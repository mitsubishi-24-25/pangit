<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Enhanced Chatbot Widget</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      transition: background 0.3s, color 0.3s;
    }

    #chat-toggle {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #2563eb;
      color: #fff;
      border: none;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 28px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
    }

    #chat-widget {
      position: fixed;
      bottom: 95px;
      right: 20px;
      width: 320px;
      height: 420px;
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
      display: none;
      flex-direction: column;
      overflow: hidden;
    }

    #chat-header {
      background: #1e40af;
      color: #fff;
      padding: 12px;
      font-size: 18px;
      font-weight: bold;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    #chat-body {
      flex: 1;
      padding: 12px;
      overflow-y: auto;
      font-size: 14px;
    }

    .message {
      margin-bottom: 10px;
      padding: 8px 10px;
      border-radius: 8px;
      max-width: 85%;
      line-height: 1.4;
    }

    .user {
      background: #dbeafe;
      align-self: flex-end;
    }

    .bot {
      background: #e5e7eb;
      align-self: flex-start;
    }

    .suggestions button {
      margin: 2px;
      padding: 4px 6px;
      cursor: pointer;
      border-radius: 4px;
      border: none;
      background: #2563eb;
      color: #fff;
      font-size: 12px;
    }

    #chat-input-area {
      padding: 10px;
      display: flex;
      gap: 6px;
      border-top: 1px solid #ddd;
    }

    #chat-input {
      flex: 1;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    #send-btn {
      background: #2563eb;
      color: #fff;
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
    }

    #clear-btn {
      background: #ef4444;
      color: #fff;
      border: none;
      padding: 4px 8px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      margin-left: 6px;
    }

    #theme-btn {
      background: #fbbf24;
      color: #000;
      border: none;
      padding: 4px 8px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
    }

    body.dark-mode {
      background: #111;
      color: #eee;
    }

    body.dark-mode #chat-widget {
      background: #222;
    }

    body.dark-mode .bot {
      background: #333;
      color: #fff;
    }

    body.dark-mode .user {
      background: #444;
      color: #fff;
    }

    body.dark-mode .suggestions button {
      background: #fbbf24;
      color: #000;
    }

    @media (max-width: 480px) {
      #chat-widget {
        width: calc(100% - 40px);
        right: 20px;
        bottom: 80px;
        height: 50vh;
      }
    }

    @media (max-width: 768px) {
      #chat-widget {
        width: 300px;
        right: 15px;
        bottom: 80px;
        height: 400px;
      }
    }
  </style>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>

  <button id="chat-toggle">üí¨</button>

  <div id="chat-widget">
    <div id="chat-header">
      <span>Chatbot</span>
      <div>
        <button id="clear-btn">Clear</button>
        <button id="theme-btn">Theme</button>
      </div>
    </div>
    <div id="chat-body"></div>
    <div id="chat-input-area">
      <input id="chat-input" type="text" placeholder="Type here...">
      <button id="send-btn">Send</button>
    </div>
  </div>

  <script>
    const toggle = document.getElementById("chat-toggle");
    const widget = document.getElementById("chat-widget");
    const body = document.getElementById("chat-body");
    const input = document.getElementById("chat-input");
    const send = document.getElementById("send-btn");
    const clearBtn = document.getElementById("clear-btn");
    const themeBtn = document.getElementById("theme-btn");

    let knowledgeData = [];
    const defaultMessage = "Hi üßèüèΩ‚Äç‚ôÇÔ∏è! How are you today?";

    function displayMessage(text, sender) {
      const div = document.createElement("div");
      div.className = `message ${sender}`;
      div.innerHTML = text.replace(/\n/g, "<br>");
      body.appendChild(div);
      body.scrollTo({ top: body.scrollHeight, behavior: "smooth" });
    }

    function saveMessage(text, sender) {
      const chatHistory = JSON.parse(localStorage.getItem("chatHistory") || "[]");
      chatHistory.push({ text, sender });
      localStorage.setItem("chatHistory", JSON.stringify(chatHistory));
    }

    function addMessage(text, sender) {
      displayMessage(text, sender);
      saveMessage(text, sender);
    }

    function loadHistory() {
      const chatHistory = JSON.parse(localStorage.getItem("chatHistory") || "[]");
      if (chatHistory.length === 0) {
        displayMessage(defaultMessage, "bot");
      } else {
        chatHistory.forEach(msg => displayMessage(msg.text, msg.sender));
        body.scrollTo({ top: body.scrollHeight, behavior: "auto" });
      }
    }

    clearBtn.onclick = () => {
      localStorage.removeItem("chatHistory");
      body.innerHTML = "";
      displayMessage(defaultMessage, "bot");
    };

    themeBtn.onclick = () => document.body.classList.toggle("dark-mode");

    function showTyping() {
      const div = document.createElement("div");
      div.className = "message bot typing";
      div.textContent = "Bot is typing...";
      body.appendChild(div);
      body.scrollTo({ top: body.scrollHeight, behavior: "smooth" });
      return div;
    }

    fetch('knowledge.json')
      .then(res => res.json())
      .then(data => {
        knowledgeData = data;
        loadHistory();
        send.onclick = handleMessage;
        input.addEventListener("keydown", e => { if (e.key === "Enter") handleMessage(); });
      })
      .catch(err => console.error("Failed to load knowledge base:", err));

    function similarity(s1, s2) {
      const len1 = s1.length, len2 = s2.length;
      const dp = Array.from({ length: len1 + 1 }, () => Array(len2 + 1).fill(0));
      for (let i = 0; i <= len1; i++) dp[i][0] = i;
      for (let j = 0; j <= len2; j++) dp[0][j] = j;
      for (let i = 1; i <= len1; i++)
        for (let j = 1; j <= len2; j++)
          dp[i][j] = s1[i - 1] === s2[j - 1] ? dp[i - 1][j - 1] : 1 + Math.min(dp[i - 1][j - 1], dp[i][j - 1], dp[i - 1][j]);
      return 1 - dp[len1][len2] / Math.max(len1, len2);
    }

    function findAnswer(msg) {
      msg = msg.toLowerCase().replace(/[^\w\s]/g, '').split(/\s+/);
      const matched = [];

      for (let entry of knowledgeData) {
        for (let keyword of entry.keywords) {
          for (let word of msg) {
            const score = similarity(word, keyword.toLowerCase());
            if (score > 0.7) {
              if (!matched.some(a => a.text === entry.answer)) {
                matched.push({
                  text: entry.answer,
                  keywords: entry.keywords,
                  score,
                  Trigger: entry.Trigger,
                  Location: entry.Location
                });
              }
            }
          }
        }
      }
      return matched.sort((a, b) => b.score - a.score);
    }

    function showSuggestions(keywords) {
      const container = document.createElement("div");
      container.className = "message bot suggestions";
      keywords.forEach(k => {
        const btn = document.createElement("button");
        btn.textContent = k;
        btn.onclick = () => { input.value = k; send.click(); };
        container.appendChild(btn);
      });
      body.appendChild(container);
      body.scrollTo({ top: body.scrollHeight, behavior: "smooth" });
    }

    function escapeRegex(text) {
      return text.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
    }

    function handleMessage() {
      const text = input.value.trim();
      if (!text) return;
      addMessage(text, "user");
      input.value = "";

      const replies = findAnswer(text);

      if (replies.length === 0) {
        const suggestions = knowledgeData.filter(e => !e.noSuggest)
          .map(e => e.keywords[0])
          .slice(0, 10);
        setTimeout(() => addMessage(`Sorry, I don't have info about that yet. Try asking about: ${suggestions.join(", ")}`, "bot"), 300);
        if (suggestions.length > 0) setTimeout(() => showSuggestions(suggestions), 400);
        return;
      }

      let delay = 0;

      replies.forEach(replyObj => {
        const lines = replyObj.text.split('\n').map(l => l.trim()).filter(l => l);

        lines.forEach(line => {
          replyObj.keywords.forEach(k => {
            const regex = new RegExp(`\\b${escapeRegex(k)}\\b`, "gi");
            line = line.replace(regex, "<b>$&</b>");
          });

          setTimeout(() => {
            const typing = showTyping();
            setTimeout(() => {
              typing.remove();
              addMessage(line, "bot");
            }, 500);
          }, delay);

          delay += line.length * 10 + 400;
        });

        if (replyObj.Trigger && replyObj.Location) {
          setTimeout(() => {
            const btnContainer = document.createElement("div");
            btnContainer.className = "message bot suggestions";
            const btn = document.createElement("button");
            btn.textContent = replyObj.Trigger;
            btn.className = "btn btn-sm btn-primary";
            btn.onclick = () => window.location.href = replyObj.Location;
            btnContainer.appendChild(btn);
            body.appendChild(btnContainer);
            body.scrollTo({ top: body.scrollHeight, behavior: "smooth" });
          }, delay);
        }

        delay += 200;
      });
    }

    toggle.onclick = () => { widget.style.display = widget.style.display === "flex" ? "none" : "flex"; };
  </script>
</body>

</html>