<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance Record</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="root.css">
    <link rel="stylesheet" href="Toast.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@14.3.0/dist/handsontable.full.min.css">
    <style>
        body {
            background: var(--background-color);
            margin: 0;
            min-height: 100vh;
            font-family: 'Poppins', sans-serif;
            padding: 20px;
        }

        .navbar {
            z-index: 1060 !important;
            font-family: 'Oswald', sans-serif;
            background: var(--primary-color) !important;
        }

        .main-content {
            margin-left: 0;
            transition: margin-left 0.3s;
            padding-right: 1rem;
            padding-top: 0;
        }

        @media (min-width: 992px) {
            .main-content {
                margin-left: 250px;
                padding-right: 2rem;
            }

            #toggleBtn {
                display: none;
            }

            .sidebar {
                transform: translateX(0) !important;
            }
        }

        @media (max-width: 991.98px) {
            .sidebar {
                position: absolute;
                height: 100vh;
            }
        }

        @media (max-width: 768px) {
            .button-row {
                flex-direction: column;
            }

            .btn-group-left {
                flex-direction: column;
            }

            .hot-container {
                height: 250px;
            }
        }

        .sidebar {
            height: 100vh;
            width: 250px;
            position: fixed;
            top: 0;
            left: 0;
            background: var(--secondary-color);
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
            z-index: 1050;
            font-family: 'Poppins', sans-serif;
            padding-top: 60px;
        }

        .sidebar.collapsed {
            transform: translateX(-100%);
        }

        .sidebar .nav-link {
            border-radius: 5px;
            transition: background-color 0.2s ease, color 0.2s ease, transform 0.2s ease;
            color: var(--primary-color);
        }

        .sidebar .nav-link:hover {
            background-color: var(--primary-color);
            color: var(--secondary-color);
            transform: translateX(5px);
        }

        .sidebar .nav-link.active {
            background-color: var(--primary-color);
            color: var(--secondary-color);
            font-weight: bold;
            transform: translateX(5px);
            pointer-events: none;
        }

        .sidebar .nav-item p {
            font-family: Poppins;
            font-weight: bold;
            color: var(--primarydark-color);
        }

        #toggleBtn {
            color: var(--secondary-color);
            border-color: var(--secondary-color);
        }

        #toggleBtn:hover {
            background-color: var(--secondary-color) !important;
            color: var(--primary-color) !important;
            border-color: var(--secondary-color) !important;
        }

        .button-row {
            margin-bottom: 20px;
        }

        .btn-group-left {
            display: flex;
            gap: 10px;
        }

        .btn-right {
            margin-left: auto;
        }

        .hot-container {
            height: 500px;
            border: 1px solid var(--primarydark-color);
            margin-bottom: 40px;
            overflow: auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .student-table {
            height: 300px;
        }

        .handsontable thead th .relative {
            background-color: var(--accent-color);
            border: 1px solid var(--primarydark-color);
        }

        .handsontable table {
            border-collapse: collapse;
            border: 1px solid var(--primarydark-color);
        }

        .btn-primary {
            background-color: var(--primary-color) !important;
            border-color: var(--primarydark-color);
        }

        @media (max-width: 768px) {
            .button-row {
                flex-direction: column;
                align-items: stretch !important;
            }

            .button-row .btn-group-left,
            .button-row .btn-danger {
                width: 100%;
            }

            .button-row .btn-group-left .btn {
                flex: 1;
            }

            .button-row>.ms-auto {
                display: none;
            }
        }

        .month-selection {
            background: white;
            border: 1px solid var(--primarydark-color);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .month-selection label {
            font-weight: bold;
            color: var(--primary-color);
        }

        .month-selection .form-select {
            border-color: var(--primarydark-color);
        }

        @media (max-width: 576px) {
            .month-selection .col-sm-3 {
                flex: 0 0 50%;
                max-width: 50%;
            }
        }

        .htBold {
            font-weight: bold !important;
        }

        
    </style>
</head>

<body>
    <nav class="navbar navbar-light bg-primary shadow-sm fixed-top" data-bs-theme="dark">
        <div class="container-fluid">
            <div
                class="d-flex flex-column flex-lg-row w-100 align-items-start align-items-lg-center justify-content-lg-between">
                <div class="d-flex align-items-center w-100 w-lg-auto justify-content-start mb-2 mb-lg-0">
                    <button class="btn btn-outline-secondary me-2 d-lg-none" id="toggleBtn">â˜°</button>
                    <span class="navbar-brand mb-0 h1 d-none d-lg-inline" id="Hi">CardGen: From Grade Consolidation to
                        Printable Report Card for Senior High School</span>
                    <span class="navbar-brand mb-0 h1 d-inline d-lg-none" id="Hi">CardGen 2025</span>
                </div>
            </div>
        </div>
    </nav>

    <div class="sidebar collapsed" id="sidebar">
        <ul class="nav flex-column px-3">
            <div id="sidebar-container"></div>
        </ul>
    </div>

    <div class="main-content">
        <div class="container-fluid container">
            <div class="row">
                <div class="col-12">
                    <h5>Attendance Months Selection</h5>
                    <div class="month-selection">
                        <div class="row g-3">
                            <div class="col-sm-3 d-flex align-items-center">
                                <label for="startMonth">First Month:</label>
                            </div>
                            <div class="col-sm-3">
                                <select id="startMonth" class="form-select">
                                    <option value="">Select Month</option>
                                    <option value="Jan">Jan</option>
                                    <option value="Feb">Feb</option>
                                    <option value="Mar">Mar</option>
                                    <option value="Apr">Apr</option>
                                    <option value="May">May</option>
                                    <option value="Jun">Jun</option>
                                    <option value="Jul">Jul</option>
                                    <option value="Aug">Aug</option>
                                    <option value="Sep">Sep</option>
                                    <option value="Oct">Oct</option>
                                    <option value="Nov">Nov</option>
                                    <option value="Dec">Dec</option>
                                </select>
                            </div>
                            <div class="col-sm-3 d-flex align-items-center">
                                <label for="endMonth">Last Month:</label>
                            </div>
                            <div class="col-sm-3">
                                <select id="endMonth" class="form-select">
                                    <option value="">Select Month</option>
                                    <option value="Jan">Jan</option>
                                    <option value="Feb">Feb</option>
                                    <option value="Mar">Mar</option>
                                    <option value="Apr">Apr</option>
                                    <option value="May">May</option>
                                    <option value="Jun">Jun</option>
                                    <option value="Jul">Jul</option>
                                    <option value="Aug">Aug</option>
                                    <option value="Sep">Sep</option>
                                    <option value="Oct">Oct</option>
                                    <option value="Nov">Nov</option>
                                    <option value="Dec">Dec</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <h5>Males Data</h5>
                    <div id="boysHot" class="hot-container student-table"></div>

                    <h5>Females Data</h5>
                    <div id="girlsHot" class="hot-container student-table"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="loader.js"></script>
    <script>
        loadSidebar("Attendance c.html");
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/handsontable@14.3.0/dist/handsontable.full.min.js"></script>
    <script src="SideBar-NavBar.js"></script>
    <script src="Logout.js"></script>
    <script src="Toast.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const STORAGE_KEY = "CardGen";
        
            if (!localStorage.getItem(STORAGE_KEY)) {
                localStorage.setItem(STORAGE_KEY, JSON.stringify({
                    information: {},
                    subject: { sem1: { core: {}, applied: {} }, sem2: { core: {}, applied: {} } },
                    students: { boys: {}, girls: {} },
                    chathistory: {},
                    attendanceMonth: ""
                }));
            }
        
            function getCardGen() { return JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}"); }
            function saveCardGen(data) { localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); }
        
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        
            let boysHotInstance = null;
            let girlsHotInstance = null;
        
            function generateMonthSequence(start, end) {
                if (!start || !end || start === end) return "";
                const startIndex = months.indexOf(start);
                const endIndex = months.indexOf(end);
                let sequence = [];
                if (endIndex >= startIndex) {
                    sequence = months.slice(startIndex, endIndex + 1);
                } else {
                    sequence = months.slice(startIndex).concat(months.slice(0, endIndex + 1));
                }
                return sequence.join(', ');
            }
        
            function getDisplayedMonths() {
                const cardGen = getCardGen();
                const saved = cardGen.attendanceMonth || "";
                if (!saved) return Array(12).fill("");
        
                const monthList = saved.split(', ').filter(m => m.trim());
                const displayed = Array(12).fill("");
                monthList.forEach((month, index) => {
                    if (index < 12) displayed[index] = month;
                });
                return displayed;
            }
        
            function refreshAttendanceTables() {
                if (!boysHotInstance || !girlsHotInstance) return;
        
                const displayed = getDisplayedMonths();
                const count = displayed.filter(m => m !== "").length;
        
                // Batch updates para mas mabilis
                boysHotInstance.batch(() => {
                    boysHotInstance.setDataAtCell(0, 4, `No. of School Days (${count})`);
                    boysHotInstance.setDataAtCell(0, 16, `No. of Days Absent (${count})`);
                    boysHotInstance.setDataAtCell(0, 28, `No. of Days Present (${count})`);
        
                    for (let i = 0; i < 12; i++) {
                        const m = displayed[i] || "";
                        boysHotInstance.setDataAtCell(1, 4 + i, m);
                        boysHotInstance.setDataAtCell(1, 16 + i, m);
                        boysHotInstance.setDataAtCell(1, 28 + i, m);
                    }
                });
                boysHotInstance.render();
        
                girlsHotInstance.batch(() => {
                    girlsHotInstance.setDataAtCell(0, 4, `No. of School Days (${count})`);
                    girlsHotInstance.setDataAtCell(0, 16, `No. of Days Absent (${count})`);
                    girlsHotInstance.setDataAtCell(0, 28, `No. of Days Present (${count})`);
        
                    for (let i = 0; i < 12; i++) {
                        const m = displayed[i] || "";
                        girlsHotInstance.setDataAtCell(1, 4 + i, m);
                        girlsHotInstance.setDataAtCell(1, 16 + i, m);
                        girlsHotInstance.setDataAtCell(1, 28 + i, m);
                    }
                });
                girlsHotInstance.render();
            }
        
            const startSelect = document.getElementById('startMonth');
            const endSelect = document.getElementById('endMonth');
        
            function updateEndOptions() {
    const selected = startSelect.value;
    const opts = selected 
        ? months.filter(m => m !== selected).map(m => `<option value="${m}">${m}</option>`)
        : months.map(m => `<option value="${m}">${m}</option>`);

    endSelect.innerHTML = `<option value="">Select Month</option>${opts.join('')}`;
}
        
            function saveAttendanceMonths() {
                const start = startSelect.value.trim();
                const end = endSelect.value.trim();
        
                let data = getCardGen();
        
                if (!start || !end) {
                    data.attendanceMonth = "";
                } else {
                    const sequence = generateMonthSequence(start, end);
                    data.attendanceMonth = sequence;
                }
        
                saveCardGen(data);
        
                // Delay lang para hindi ma-block ang dropdown render
                refreshAttendanceTables();
            }
        
            function restoreMonthSelection() {
                const cardGen = getCardGen();
                const saved = cardGen.attendanceMonth || "";
        
                if (!saved) {
                    startSelect.value = "";
                    endSelect.value = "";
                    updateEndOptions();
                    return;
                }
        
                const monthList = saved.split(', ').filter(m => m.trim());
                if (monthList.length === 0) {
                    startSelect.value = "";
                    endSelect.value = "";
                    updateEndOptions();
                    return;
                }
        
                const first = monthList[0];
                const last = monthList[monthList.length - 1];
        
                startSelect.value = months.includes(first) ? first : "";
                updateEndOptions();
                endSelect.value = months.includes(last) ? last : "";
            }
        
            function createAttendanceTable(containerId, gender) {
                const container = document.getElementById(containerId);
                if (!container) return null;
        
                let cardGen = getCardGen();
                const studentsObj = cardGen.students?.[gender] || {};
                const studentEntries = Object.entries(studentsObj).sort(([a], [b]) => a.localeCompare(b));
        
                const getMonthKey = (index) => `month${index + 1}`;
        
                const rows = studentEntries.map(([id, student]) => {
                    if (!student.monthlyAttendance || Array.isArray(student.monthlyAttendance.schoolDays)) {
                        const old = student.monthlyAttendance || { schoolDays: [], absent: [], present: [] };
                        student.monthlyAttendance = {
                            total: { schoolDays: "", absent: "", present: "" },
                            schoolDays: {},
                            absent: {},
                            present: {}
                        };
                        for (let i = 0; i < 12; i++) {
                            const key = getMonthKey(i);
                            student.monthlyAttendance.schoolDays[key] = old.schoolDays[i] ?? "";
                            student.monthlyAttendance.absent[key] = old.absent[i] ?? "";
                            student.monthlyAttendance.present[key] = old.present[i] ?? "";
                        }
                    }
        
                    const ma = student.monthlyAttendance;
        
                    let totalSchool = 0, totalAbsent = 0;
                    for (let i = 0; i < 12; i++) {
                        const key = getMonthKey(i);
                        const sd = Number(ma.schoolDays[key]) || 0;
                        const ab = Number(ma.absent[key]) || 0;
                        const pr = (sd && ab !== "") ? Math.max(0, sd - ab) : "";
                        ma.present[key] = pr;
        
                        totalSchool += sd;
                        totalAbsent += ab;
                    }
                    ma.total.schoolDays = totalSchool || "";
                    ma.total.absent = totalAbsent || "";
                    ma.total.present = Math.max(0, totalSchool - totalAbsent) || "";
        
                    const row = [
                        student.name || "",
                        ma.total.schoolDays,
                        ma.total.absent,
                        ma.total.present
                    ];
        
                    for (let i = 0; i < 12; i++) row.push(ma.schoolDays[getMonthKey(i)]);
                    for (let i = 0; i < 12; i++) row.push(ma.absent[getMonthKey(i)]);
                    for (let i = 0; i < 12; i++) row.push(ma.present[getMonthKey(i)]);
        
                    return row;
                });
        
                while (rows.length < 50) {
                    rows.push(["", "", "", "", ...Array(36).fill("")]);
                }
        
                const displayedMonths = getDisplayedMonths();
                const activeCount = displayedMonths.filter(m => m !== "").length;
        
                const headerRow1 = [
                    "Names of Learners", "Total", "", "",
                    `No. of School Days (${activeCount})`, ...Array(11).fill(""),
                    `No. of Days Absent (${activeCount})`, ...Array(11).fill(""),
                    `No. of Days Present (${activeCount})`, ...Array(11).fill("")
                ];
        
                const headerRow2 = [
                    "", "No. of School Days", "No. of Days Absent", "No. of Days Present",
                    ...displayedMonths, ...displayedMonths, ...displayedMonths
                ];
        
                const data = [headerRow1, headerRow2, ...rows];
        
                const hot = new Handsontable(container, {
                    data: data,
                    invalidCellClassName: '',
                    allowInvalid: true,
                    rowHeaders: true,
                    colHeaders: false,
                    stretchH: 'all',
                    manualRowResize: true,
                    manualColumnResize: true,
                    fixedRowsTop: 2,
                    licenseKey: 'non-commercial-and-evaluation',
        
                    columns: [
                        { type: 'text', readOnly: true },
                        { type: 'numeric', readOnly: true },
                        { type: 'numeric', readOnly: true },
                        { type: 'numeric', readOnly: true },
                        ...Array(12).fill({ type: 'numeric', numericFormat: { pattern: '0' } }),
                        ...Array(12).fill({ type: 'numeric', numericFormat: { pattern: '0' } }),
                        ...Array(12).fill({ type: 'numeric', readOnly: true })
                    ],
        
                    mergeCells: [
                        { row: 0, col: 0, rowspan: 2, colspan: 1 },
                        { row: 0, col: 1, rowspan: 1, colspan: 3 },
                        { row: 0, col: 4, rowspan: 1, colspan: 12 },
                        { row: 0, col: 16, rowspan: 1, colspan: 12 },
                        { row: 0, col: 28, rowspan: 1, colspan: 12 }
                    ],
        
                    cells: function (row, col) {
                        const meta = {};
                        if (row < 2) {
                            meta.readOnly = true;
                            meta.className = 'htCenter htBold';
                        } else if (col === 0) {
                            meta.readOnly = true;
                            meta.className = 'htLeft htBold';
                        } else {
                            meta.className = 'htCenter';
                        }
                        return meta;
                    },
        
                    afterChange: function (changes, source) {
                        if (!changes || source === 'autoCalc') return;
        
                        let cardGen = getCardGen();
        
                        changes.forEach(([rowIndex, col, oldVal, newVal]) => {
                            if (rowIndex < 2) return;
        
                            const dataRow = rowIndex - 2;
                            if (dataRow >= studentEntries.length) return;
        
                            const name = this.getDataAtCell(rowIndex, 0);
                            if (!name) return;
        
                            const [studentId] = Object.entries(cardGen.students[gender])
                                .find(([_, stu]) => stu.name === name) || [null];
                            if (!studentId) return;
        
                            let student = cardGen.students[gender][studentId];
        
                            if (!student.monthlyAttendance) {
                                student.monthlyAttendance = {
                                    total: { schoolDays: "", absent: "", present: "" },
                                    schoolDays: {},
                                    absent: {},
                                    present: {}
                                };
                                for (let i = 0; i < 12; i++) {
                                    const key = getMonthKey(i);
                                    student.monthlyAttendance.schoolDays[key] = "";
                                    student.monthlyAttendance.absent[key] = "";
                                    student.monthlyAttendance.present[key] = "";
                                }
                            }
        
                            const ma = student.monthlyAttendance;
        
                            const monthIndex = col - 4;
                            const isSchoolDaysCol = monthIndex >= 0 && monthIndex < 12;
                            const isAbsentCol = monthIndex >= 12 && monthIndex < 24;
        
                            let needsRecalc = false;
        
                            if (isSchoolDaysCol) {
                                const key = getMonthKey(monthIndex);
                                ma.schoolDays[key] = newVal === null || newVal === "" ? "" : Number(newVal);
                                needsRecalc = true;
                            } else if (isAbsentCol) {
                                const key = getMonthKey(monthIndex - 12);
                                ma.absent[key] = newVal === null || newVal === "" ? "" : Number(newVal);
                                needsRecalc = true;
                            }
        
                            if (needsRecalc) {
                                let totalSchool = 0, totalAbsent = 0;
                                for (let i = 0; i < 12; i++) {
                                    const key = getMonthKey(i);
                                    const sd = Number(ma.schoolDays[key]) || 0;
                                    const ab = Number(ma.absent[key]) || 0;
                                    const pr = (sd !== 0 && ab !== "") ? Math.max(0, sd - ab) : "";
        
                                    ma.present[key] = pr;
                                    totalSchool += sd;
                                    totalAbsent += ab;
        
                                    this.setDataAtCell(rowIndex, 28 + i, pr || "", 'autoCalc');
                                }
        
                                ma.total.schoolDays = totalSchool || "";
                                ma.total.absent = totalAbsent || "";
                                ma.total.present = Math.max(0, totalSchool - totalAbsent) || "";
        
                                this.setDataAtCell(rowIndex, 1, ma.total.schoolDays, 'autoCalc');
                                this.setDataAtCell(rowIndex, 2, ma.total.absent, 'autoCalc');
                                this.setDataAtCell(rowIndex, 3, ma.total.present, 'autoCalc');
                            }
                        });
        
                        saveCardGen(cardGen);
                    }
                });
        
                return hot;
            }
        
            // ======================
            // ORDER: TABLES FIRST
            // ======================
            boysHotInstance = createAttendanceTable('boysHot', 'boys');
            girlsHotInstance = createAttendanceTable('girlsHot', 'girls');
        
            // Listeners
            startSelect.addEventListener('change', () => {
                updateEndOptions();
                if (endSelect.value && endSelect.value === startSelect.value) endSelect.value = "";
                saveAttendanceMonths();
            });
        
            endSelect.addEventListener('change', saveAttendanceMonths);
        
            // Initial
            updateEndOptions();
            restoreMonthSelection();
            // Initial header update with delay para hindi ma-block ang page load
            refreshAttendanceTables();
        });
        </script>
</body>

</html>