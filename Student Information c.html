<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Information</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="root.css">
    <link rel="stylesheet" href="Toast.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@14.4.0/dist/handsontable.full.min.css">    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.2/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.2/cropper.min.js"></script>
    <style>
        body {
            background: var(--background-color);
            margin: 0;
            min-height: 100vh;
            font-family: 'Poppins', sans-serif;
            padding: 20px;
        }
        .navbar {
            z-index: 1060 !important;
            font-family: 'Oswald', sans-serif;
            background: var(--primary-color) !important;
        }
        .main-content {
            margin-left: 0;
            transition: margin-left 0.3s;
            padding-right: 1rem;
            padding-top: 0;
        }
        @media (min-width: 992px) {
            .main-content { margin-left: 250px; padding-right: 2rem; }
            #toggleBtn { display: none; }
            .sidebar { transform: translateX(0) !important; }
        }
        @media (max-width: 991.98px) {
            .sidebar { position: absolute; height: 100vh; }
        }
        @media (max-width: 768px) {
            .button-row { flex-direction: column; }
            .btn-group-left { flex-direction: column; }
            .hot-container { height: 250px; }
        }
        .sidebar {
            height: 100vh;
            width: 250px;
            position: fixed;
            top: 0;
            left: 0;
            background: var(--secondary-color);
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
            z-index: 1050;
            font-family: 'Poppins', sans-serif;
            padding-top: 60px;
        }
        .sidebar.collapsed { transform: translateX(-100%); }
        .sidebar .nav-link {
            border-radius: 5px;
            transition: background-color 0.2s ease, color 0.2s ease, transform 0.2s ease;
            color: var(--primary-color);
        }
        .sidebar .nav-link:hover {
            background-color: var(--primary-color);
            color: var(--secondary-color);
            transform: translateX(5px);
        }
        .sidebar .nav-link.active {
            background-color: var(--primary-color);
            color: var(--secondary-color);
            font-weight: bold;
            transform: translateX(5px);
            pointer-events: none;
        }
        .sidebar .nav-item p {
            font-family: Poppins;
            font-weight: bold;
            color: var(--primarydark-color);
        }
        #toggleBtn {
            color: var(--secondary-color);
            border-color: var(--secondary-color);
        }
        #toggleBtn:hover {
            background-color: var(--secondary-color) !important;
            color: var(--primary-color) !important;
            border-color: var(--secondary-color) !important;
        }
        .button-row { margin-bottom: 20px; }
        .btn-group-left { display: flex; gap: 10px; }
        .btn-right { margin-left: auto; }
        .hot-container { height: 300px; border: 1px solid var(--primarydark-color); margin-bottom: 20px; overflow: auto; }
        .student-table { height: 300px; }
        .signature-preview { max-width: 200px; max-height: 100px; margin: 10px 0; border: 1px solid var(--background-color); }
        .remove-signature {
    position: absolute;
    top: -15px !important;     /* mas mataas - fully lumalabas */
    right: -3px !important;   /* mas kanan - fully lumalabas */
    background: #dc3545 !important;  /* Bootstrap red */
    color: white !important;
    border: 3px solid white !important;  /* puting border para mas pop out */
    border-radius: 50%;
    width: 32px !important;    /* mas malaki */
    height: 32px !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    font-weight: bold !important;
    font-size: 20px !important;  /* mas malaking X */
    cursor: pointer !important;
    box-shadow: 0 4px 12px rgba(0,0,0,0.4) !important;  /* malakas na shadow */
    z-index: 1000 !important;  /* sobrang taas */
    line-height: 1 !important;
}
.remove-signature:hover {
    background: #c82333 !important;
    transform: scale(1.15) !important;  /* lumalaki sa hover */
    box-shadow: 0 6px 16px rgba(0,0,0,0.5) !important;
}
#teacherSigPreview, #principalSigPreview {
    width: 300px;
    height: 150px;
    border: 2px dashed #ccc;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    overflow: visible !important;  /* ← DAGDAGIN MO 'TO - mahalaga! */
    margin: 10px 0;
}
        .metadata-table { height: 250px; }
        .htInvalid { background-color: var(--background-color) !important; border: 2px solid #f44336 !important; }
        .space { height: 20px; }
        .btn .btn-secondary { background-color: var(--danger) !important; }
        .handsontable thead th .relative { background-color: var(--accent-color); border: 1px solid var(--primarydark-color); }
        .handsontable table { border-collapse: collapse; border: 1px solid var(--primarydark-color); }
        .ht_master tb { background-color: var(--accent-color); border: 1px solid var(--primarydark-color); }
        .btn-primary {background-color: var(--primary-color) !important; border-color: var(--primarydark-color);}

        .modal { z-index: 9999;}

        #confirmModal .btn-danger:focus {
            box-shadow: 0 0 0 0.25rem rgba(220, 53, 69, 0.5);
        }

        /* Checkerboard pattern */
        .checkerboard {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 20 20'%3E%3Crect width='10' height='10' fill='%23ddd'/%3E%3Crect x='10' y='10' width='10' height='10' fill='%23ddd'/%3E%3C/svg%3E");
            background-size: 20px 20px;
            background-repeat: repeat;
        }

        /* Fixed size container for previews with centering */
        #teacherSigPreview, #principalSigPreview {
            width: 300px;
            height: 150px;
            border: 2px dashed #ccc;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            margin: 10px 0;
        }

        /* Signature image styling */
        .signature-preview {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            background: transparent !important;
        }

        /* For the removal modal canvas container */
        #removalModal .canvas-container {
            width: 100%;
            height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            border: 1px solid #ddd;
            border-radius: 8px;
        }

        /* Additional styles for search */
        #searchBar {
            background-color: white;
            border: 1px solid black;
            color: black;
            padding-right: 40px;
        }
        #searchBar::placeholder {
            color: black;
        }
        #clearSearch {
            font-size: 2em;          /* Mas malaki na yung × */
            font-weight: bold;       /* Mas bold para mas kita */
            line-height: 1;
            padding: 0 8px;          /* Kaunting space sa gilid para madaling i-click */
        }
        .bg-pink {
            background-color: pink !important;
        }
        .temp-highlight {
            background-color: lightblue !important;
        }
        #searchSuggestions {
            font-family: 'Poppins', sans-serif; /* Change font here if needed */
        }
        .suggestion-item {
            display: flex;
            justify-content: space-between;  /* Name sa left, badge sa right */
            align-items: center;             /* Vertically centered */
            padding: 8px 12px;               /* Kaunting padding para maluwag */
            border-bottom: 1px solid #dee2e6;
            color: black;
        }

        .suggestion-item .badge {
            flex-shrink: 0;                  /* Para hindi mag-shrink yung badge */
            margin-left: 10px;               /* Optional space from text */
        }
        @media (max-width: 576px) {
            .navbar-brand-container {
                width: 100%;
                text-align: center;
            }
            .search-container {
                width: 100%;
                margin-top: 5px;
            }
            #searchBar {
                width: 100% !important;
            }
        }
        @media (min-width: 577px) {
            .search-container {
                flex-grow: 1;
                max-width: 400px; /* Adjust max width as needed */
            }
            #searchBar {
                width: 100%;
            }
        }
        .suggestion-item:hover,
        .suggestion-item.selected {
            background-color: #e9ecef !important; /* Gray highlight kapag hover o selected */
        }
        .text-muted {
            color: black !important;
        }

    </style>
    
</head>
<body>
    
  <nav class="navbar navbar-light bg-primary shadow-sm fixed-top" data-bs-theme="dark">
      <div class="container-fluid">
          <div class="d-flex align-items-center w-100 justify-content-between flex-wrap">
              <div class="d-flex align-items-center">
                  <button class="btn btn-outline-secondary me-2 d-lg-none" id="toggleBtn">☰</button>
                  <span class="navbar-brand mb-0 h1 navbar-brand-container d-none d-lg-inline" id="Hi">CardGen: From Grade Consolidation to Printable Report Card for Senior High School</span>
                  <span class="navbar-brand mb-0 h1 navbar-brand-container d-inline d-lg-none" id="Hi" onclick="dboard()">CardGen 2025</span>
              </div>
              <div class="search-container position-relative ms-lg-auto">
                    <input type="text" id="searchBar" class="form-control" placeholder="Search Name or LRN" autocomplete="off" autocorrect="off" autocapitalize="off">
                  <span id="clearSearch" class="position-absolute" style="right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer; display: none; color: black;">×</span>
                  <div id="searchSuggestions" class="position-absolute bg-white border border-black shadow" style="display: none; width: 100%; max-height: 250px; overflow-y: auto; z-index: 1051; top: 100%; left: 0;"></div>
              </div>
          </div>
      </div>
  </nav>
    
    
  <div class="sidebar collapsed" id="sidebar">
    <ul class="nav flex-column px-3">
        <div id="sidebar-container"></div>   
    </ul>
  </div>

    <div class="main-content">
        <div class="container-fluid container">
            <div class="row">
                <div class="col-12">
                    <div class="d-flex button-row">
                        <div class="btn-group-left">
                            <button class="btn btn-primary" onclick="exportData()">Export Data</button>
                            <button class="btn btn-secondary" onclick="window.confirmImport()">Import Data</button>
                            <input type="file" id="importFile" accept=".xlsx,.xls" style="display:none" onchange="importData(event)">
                        </div>
                        <button class="btn btn-danger btn-right" onclick="showClearConfirmation()">Clear Data (Male/Female)</button>
                    </div>

                    <div id="metadataHot" class="hot-container metadata-table"></div>

                    <!-- NEW: Sort Button -->
                    <div class="d-flex justify-content-start my-3">
                        <button class="btn btn-success btn-lg" onclick="sortStudentsAlphabetically()">
                            Sort Students Alphabetically
                        </button>
                    </div>


                    <h5>Males Data</h5>
                    <div id="boysHot" class="hot-container student-table"></div>
                    <div class="space"></div>

                    <h5>Females Data</h5>
                    <div id="girlsHot" class="hot-container student-table"></div>

                    <div class="d-flex button-row">
                        <div class="btn-group-left">
                            <button class="btn btn-info" onclick="document.getElementById('teacherSigFile').click()">Upload Teacher Signature</button>
                            <input type="file" id="teacherSigFile" accept="image/*" style="display:none" onchange="uploadSignature(event, 'teacher')">
                            <div id="teacherSigPreview" style="position:relative; display:inline-block;"></div>

                            <button class="btn btn-info" onclick="document.getElementById('principalSigFile').click()">Upload Principal Signature</button>
                            <input type="file" id="principalSigFile" accept="image/*" style="display:none" onchange="uploadSignature(event, 'principal')">
                            <div id="principalSigPreview" style="position:relative; display:inline-block;"></div>
                        </div>
                    </div>

                    <!-- REUSABLE CONFIRMATION MODAL -->
                    <div class="modal fade" style="z-index: 9999;" id="confirmModal" tabindex="-1" aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="confirmModalTitle">Confirm Action</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body" id="confirmModalBody">
                                    Are you sure you want to proceed?
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                    <button type="button" class="btn btn-danger btn-primary" id="confirmModalConfirmBtn" autofocus>Confirm</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Crop Modal -->
                    <div id="cropModal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:9999; justify-content:center; align-items:center;">
                        <div style="background:white; padding:20px; border-radius:10px; max-width:90%; max-height:90%; width:700px; display:flex; flex-direction:column;">
                            <h3>Crop Signature</h3>

                            <div style="flex:1; min-height:300px; position:relative;">
                                <img id="cropImage" style="max-width:100%; display:block;">
                            </div>

                            <div style="margin-top:20px; text-align:right;">
                                <button id="cropCancelBtn" style="margin-right:10px;">Cancel</button>
                                <button id="cropSaveBtn" class="btn btn-primary">Crop & Proceed to Removal</button>
                            </div>
                        </div>
                    </div>

                    <!-- Background Removal Modal -->
                    <div id="removalModal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:9999; justify-content:center; align-items:center;">
                        <div style="background:white; padding:20px; border-radius:10px; max-width:90%; max-height:90%; width:700px; display:flex; flex-direction:column;">
                            <h3>Adjust Background Removal</h3>
                            <p>Note: This step is only necessary if you are using a background color other than white. If the background is white, you may skip this step. For best results, ensure the signature is a dark color with enough contrast against the background.</p>

                            <div class="canvas-container checkerboard">
                                <canvas id="removalCanvas" style="max-width:100%; max-height:100%; object-fit:contain; display:block;"></canvas>
                            </div>

                            <div style="margin:15px 0; padding:10px; background:#f8f9fa; border-radius:8px;">
                                <label style="font-weight:bold; display:block; margin-bottom:8px;">
                                    Removal Strength:
                                </label>
                                <div style="display:flex; align-items:center; gap:15px;">
                                    <input type="range" id="toleranceSlider" min="0" max="200" value="0" step="5" style="flex:1;">
                                    <span id="toleranceValue" style="min-width:50px; font-weight:bold;">0</span>
                                </div>
                                <small style="color:#666; display:block; margin-top:5px;">
                                    0 = No removal | 200 = Maximum aggressive
                                </small>
                            </div>

                            <div style="margin-top:20px; text-align:right;">
                                <button id="removalCancelBtn" style="margin-right:10px;">Cancel</button>
                                <button id="removalSaveBtn" class="btn btn-primary">Save</button>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

<script src="loader.js"></script>

<script>
    loadSidebar("Student Information c.html");
</script>

<script>
document.addEventListener("DOMContentLoaded", async () => {
    const STORAGE_KEY = "CardGen";

    if (!localStorage.getItem(STORAGE_KEY)) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify({
            information: { track: "", strand: "", "school-year": "", adviser: "", principal: "", section: "", grade: "" },
            subject: { sem1: { core: [], applied: [] }, sem2: { core: [], applied: [] } },
            students: { boys: {}, girls: {} },
            chathistory: {}
        }));
    }

    let cardGen = getCardGen();

    const metadataContainer = document.getElementById("metadataHot");
    if (!metadataContainer) return console.error("metadataHot container not found!");

    const labels = ["Track:", "Strand:", "School Year:", "Adviser:", "Principal:", "Section:", "Grade:"];
    const keys   = ["track", "strand", "school-year", "adviser", "principal", "section", "grade"];

    const metadataData = labels.map((label, i) => [label, cardGen.information[keys[i]] || ""]);

    const metadataHot = new Handsontable(metadataContainer, {
    data: metadataData,
    colHeaders: ["Label", "Input"],
    rowHeaders: true,
    colWidths: [150, 400],
    stretchH: "all",
    licenseKey: "non-commercial-and-evaluation",
    trimDropdown: false,

    cells: function(row, col) {
    if (col === 0) {
        return { readOnly: true };
    }

    const cellProperties = {};

    // Adviser (row 3) - max 30 chars
    if (row === 3) {
        cellProperties.type = 'text';
        cellProperties.validator = function(value, callback) {
            if (!value || value.trim() === "") return callback(true);
            const isValid = value.trim().length <= 40;
            callback(isValid);
        };
        return cellProperties;
    }

    // Principal (row 4) - max 35 chars
    if (row === 4) {
        cellProperties.type = 'text';
        cellProperties.validator = function(value, callback) {
            if (!value || value.trim() === "") return callback(true);
            const isValid = value.trim().length <= 35;
            callback(isValid);
        };
        return cellProperties;
    }

    // Existing code for other rows...
    if (row === 0) {
        cellProperties.type = 'autocomplete';
        cellProperties.source = [
            'ACADEMIC TRACK',
            'TECHNICAL-VOCATIONAL-LIVELIHOOD TRACK',
            'ARTS AND DESIGN TRACK',
            'SPORTS TRACK'
        ];
        cellProperties.strict = false;
        cellProperties.allowInvalid = true;
        cellProperties.filter = false;
        cellProperties.visibleRows = 4;
        cellProperties.trimDropdown = false;
        return cellProperties;
    }

    if (row === 1) {
        cellProperties.type = 'autocomplete';
        cellProperties.source = function(query, process) {
            const trackValue = metadataHot.getDataAtCell(0, 1) || "";
            const firstPart = trackValue.trim().toUpperCase();

            let options = [];

            if (firstPart === "") {
                options = [
                    'ACCOUNTANCY, BUSINESS AND MANAGEMENT',
                    'SCIENCE, TECHNOLOGY, ENGINEERING AND MATHEMATICS',
                    'HUMANITIES AND SOCIAL SCIENCES',
                    'GENERAL ACADEMIC STRAND',
                    'AGRI-FISHERY ARTS',
                    'HOME ECONOMICS',
                    'INFORMATION AND COMMUNICATIONS TECHNOLOGY',
                    'INDUSTRIAL ARTS',
                    'ARTS AND DESIGN',
                    'SPORTS'
                ];
            } else if (firstPart.startsWith('A') && !['AR', 'AD', 'A&D'].some(p => firstPart.startsWith(p))) {
                options = [
                    'ACCOUNTANCY, BUSINESS AND MANAGEMENT',
                    'SCIENCE, TECHNOLOGY, ENGINEERING AND MATHEMATICS',
                    'HUMANITIES AND SOCIAL SCIENCES',
                    'GENERAL ACADEMIC STRAND'
                ];
            } else if (['AR', 'AD', 'A&D'].some(p => firstPart.startsWith(p))) {
                options = ['ARTS AND DESIGN'];
            } else if (firstPart.startsWith('T')) {
                options = [
                    'AGRI-FISHERY ARTS',
                    'HOME ECONOMICS',
                    'INFORMATION AND COMMUNICATIONS TECHNOLOGY',
                    'INDUSTRIAL ARTS'
                ];
            } else if (firstPart.startsWith('S')) {
                options = ['SPORTS'];
            } else {
                options = [
                    'ACCOUNTANCY, BUSINESS AND MANAGEMENT',
                    'SCIENCE, TECHNOLOGY, ENGINEERING AND MATHEMATICS',
                    'HUMANITIES AND SOCIAL SCIENCES',
                    'GENERAL ACADEMIC STRAND',
                    'AGRI-FISHERY ARTS',
                    'HOME ECONOMICS',
                    'INFORMATION AND COMMUNICATIONS TECHNOLOGY',
                    'INDUSTRIAL ARTS',
                    'ARTS AND DESIGN',
                    'SPORTS'
                ];
            }

            process(options);
        };
        cellProperties.strict = false;
        cellProperties.allowInvalid = true;
        cellProperties.filter = false;
        cellProperties.visibleRows = 10;
        cellProperties.trimDropdown = false;
        return cellProperties;
    }

    if (row === 2) {
        cellProperties.type = 'text';
        cellProperties.validator = function(value, callback) {
            if (!value || value === "") return callback(true);
            callback(/^\d{4}-\d{4}$/.test(value.trim()));
        };
        cellProperties.allowInvalid = true;
        return cellProperties;
    }

    if (row === 6) {
        cellProperties.type = 'text';
        cellProperties.validator = function(value, callback) {
            if (!value || value === "") return callback(true);
            callback(/^(11|12)$/.test(value.toString()));
        };
        cellProperties.allowInvalid = true;
        return cellProperties;
    }

    cellProperties.type = 'text';
    return cellProperties;
},

    beforeChange: function(changes, source) {
        if (!changes || source === 'loadData') return;

        changes.forEach(change => {
            const row = change[0];
            const col = change[1];
            let newValue = change[3];

            if (col === 1 && newValue !== null && typeof newValue === 'string') {
                if (row === 3 || row === 4) {
                } else {
                    change[3] = newValue.toUpperCase();
                }
            }
        });
    },

    afterChange: function(changes, source) {
    if (!changes || source === 'loadData') return;

    let data = getCardGen();
    metadataHot.getData().forEach((rowData, index) => {
        data.information[keys[index]] = rowData[1] || "";
    });
    saveGen(data);

    if (source === 'autofill' || source === 'paste') return;

    changes.forEach(([row, prop, oldVal, newVal]) => {
        if (prop !== 1) return;

        if (!newVal || newVal.trim() === "") return;

        let message = "";

        if (row === 3) { // Adviser
            if (newVal.trim().length > 40) {
                message = "The Adviser’s name is too long and may not display properly on the card. Please shorten it to fit.";
            }
        } else if (row === 4) { // Principal
            if (newVal.trim().length > 35) {
                message = "The Principal's name is too long and may not display properly on the card. Please shorten it to fit.";
            }
        } else if (row === 2) {
            if (!/^\d{4}-\d{4}$/.test(newVal.trim())) {
                message = "Invalid School Year: Must be in format YYYY-YYYY (e.g., 2024-2025).";
            }
        } else if (row === 6) {
            if (!/^(11|12)$/.test(newVal.toString())) {
                message = "Invalid Grade: Must be 11 or 12 only.";
            }
        }

        if (message) {
            showToast(message, "warning");
        }
    });
},

    afterInit: function() {
        setTimeout(() => {
            this.validateCells(() => {
                this.render();
            });
        }, 100);
    },

    afterValidate: function(isValid, value, row, col) {
        const cell = this.getCell(row, col);
        if (cell) {
            if (!isValid && value !== '' && value !== null && value !== undefined) {
                let message = "";
                if (row === 2) message = "Invalid School Year: Must be in format YYYY-YYYY (e.g., 2024-2025).";
                if (row === 3) message = "The Adviser’s name is too long and may not display properly on the card. Please shorten it to fit.";
                if (row === 4) message = "The Principal's name is too long and may not display properly on the card. Please shorten it to fit.";
                if (row === 6) message = "Invalid Grade: Must be 11 or 12 only.";

                cell.title = message;
            } else {
                cell.title = ""; // clear tooltip kapag valid na
            }
        }
    },

    });

    function generateId(gender, index) {
        const prefix = gender === "boys" ? "2025-01-" : "2025-02-";
        return prefix + String(index + 1).padStart(4, "0");
    }

    function createStudentTable(containerId, gender) {
        const container = document.getElementById(containerId);
        if (!container) return console.error(`${containerId} not found!`);

        let rows = Object.values(cardGen.students[gender] || {}).map(s => [
            s.name || "",
            s.age || "",
            s.gender || (gender === "boys" ? "MALE" : "FEMALE"),
            s.lrn || "",
            s.parent || "",
            s.parentNumber || "",
            s.parentGmail || ""
        ]);
        while (rows.length < 50) {
            rows.push(["", "", gender === "boys" ? "MALE" : "FEMALE", "", "", "", ""]);
        }

        const hot = new Handsontable(container, {
            data: rows,
            colHeaders: ["Name","Age","Gender","LRN","Parent","Parent Number","Parent Gmail"],
            rowHeaders: true,
            stretchH: "all",
            contextMenu: true,
            manualRowResize: true,
            manualColumnResize: true,
            hiddenColumns: { columns: [2], indicators: false },
            columns: [
                { 
                    type: 'text',
                    validator: function(value, callback) {
                        if (!value || value.toString().trim() === "") {
                            callback(true);
                            return;
                        }

                        const name = value.toString().trim().toUpperCase();

                        // Access both tables safely
                        const boysInstance = document.getElementById('boysHot')?.__hotInstance;
                        const girlsInstance = document.getElementById('girlsHot')?.__hotInstance;

                        if (!boysInstance || !girlsInstance) {
                            callback(true);
                            return;
                        }

                        const boysData = boysInstance.getData();
                        const girlsData = girlsInstance.getData();

                        const allNames = [...boysData, ...girlsData]
                            .map(row => row[0] ? row[0].toString().trim().toUpperCase() : "")
                            .filter(n => n !== "");

                        const count = allNames.filter(n => n === name).length;

                        callback(count <= 1); // valid lang kung wala pang duplicate
                    },
                    allowInvalid: true  // ← Pwede mag-enter kahit duplicate muna
                },
                {
                    type: 'text',
                    validator: function(value, callback) {
                        if (!value || value === "") return callback(true);
                        callback(/^\d{2}$/.test(value));
                    },
                    allowInvalid: true
                },
                { type: 'text', readOnly: true },
                {
                    type: 'text',
                    validator: function(value, callback) {
                        if (!value || value === "") return callback(true);
                        callback(/^\d{12}$/.test(value));
                    },
                    allowInvalid: true
                },
                { type: 'text' },
                {
                    type: 'text',
                    validator: function(value, callback) {
                        if (!value || value === "" ) return callback(true);
                        const cleaned = value.toString().replace(/\D/g, '');
                        callback(/^09\d{9}$/.test(cleaned));
                    },
                    allowInvalid: true
                },
                {
                    type: 'text',
                    validator: function(value, callback) {
                        if (!value || value === "" || value === null) return callback(true);
                        const gmailRegex = /^[a-zA-Z0-9._%+-]+@gmail\.com$/i;
                        callback(gmailRegex.test(value.toString().trim()));
                    },
                    allowInvalid: true
                }
            ],
            licenseKey: "non-commercial-and-evaluation",

            afterValidate: function(isValid, value, row, col) {
                const cell = this.getCell(row, col);
                if (!cell) return;

                if (col === 0) { // Name column
                    if (!isValid && value !== '' && value !== null && value !== undefined) {
                        cell.title = "Duplicate name! This full name already exists in Males or Females list.";
                    } else {
                        cell.title = "";
                    }
                } else if (col !== 2) { // Other columns
                    if (!isValid && value !== '' && value !== null && value !== undefined) {
                        let message = "";
                        if (col === 1) message = "Age must be a 2-digit number (e.g., 16, 17, 18).";
                        if (col === 3) message = "LRN must be exactly 12 digits";
                        if (col === 5) message = "Parent Number must start with 09 and have 11 digits (e.g., 09123456789)";
                        if (col === 6) message = "Must be a valid Gmail address ending in @gmail.com";
                        cell.title = message;
                    } else {
                        cell.title = "";
                    }
                }
            },

            afterChange: function(changes, source) {
                if (!changes) return;

                // PART 1: Save to storage WITHOUT sorting and WITHOUT reloading table
                if (source !== 'loadData') {
                    let data = getCardGen();
                    data.students[gender] = {};

                    this.getData().forEach((rowData, physicalRow) => {
                        const name = (rowData[0] || "").toString().trim();
                        if (name) { // Only save rows with name
                            const id = generateId(gender, Object.keys(data.students[gender]).length);
                            data.students[gender][id] = {
                                name: name,
                                age: rowData[1] || "",
                                gender: gender === "boys" ? "MALE" : "FEMALE",
                                lrn: rowData[3] || "",
                                parent: rowData[4] || "",
                                parentNumber: rowData[5] || "",
                                parentGmail: rowData[6] || ""
                            };
                        }
                    });
                    saveGen(data);
                }

                if (source === 'internal.compact') return; // Skip toast for automatic row move

                // PART 2: Toast warnings (keep this - walang problem sa undo)
                if (changes && source !== 'autofill' && source !== 'paste') {
                    changes.forEach(([row, prop, oldVal, newVal]) => {
                        if (!newVal || newVal.toString().trim() === "") return;
                        let message = "";
                        const colIndex = this.propToCol(prop);
                        if (colIndex === 0) {
                            const name = newVal.toString().trim().toUpperCase();
                            const boysData = document.getElementById('boysHot')?.__hotInstance?.getData() || [];
                            const girlsData = document.getElementById('girlsHot')?.__hotInstance?.getData() || [];
                            const allNames = [...boysData, ...girlsData]
                                .map(r => r[0] ? r[0].toString().trim().toUpperCase() : "")
                                .filter(n => n !== "");
                            const count = allNames.filter(n => n === name).length;
                            if (count > 1) {
                                message = `Duplicate name "${newVal.trim()}"! This full name already exists.`;
                            }
                        } else if (colIndex === 1) {
                            if (!/^\d{2}$/.test(newVal.toString())) message = "Age must be a 2-digit number (e.g., 16, 17, 18).";
                        } else if (colIndex === 3) {
                            if (!/^\d{12}$/.test(newVal.toString())) message = "LRN must be exactly 12 digits.";
                        } else if (colIndex === 5) {
                            const cleaned = newVal.toString().replace(/\D/g, '');
                            if (!/^09\d{9}$/.test(cleaned)) message = "Parent Number must start with 09 and have 11 digits (e.g., 09123456789).";
                        } else if (colIndex === 6) {
                            const gmailRegex = /^[a-zA-Z0-9._%+-]+@gmail\.com$/i;
                            if (!gmailRegex.test(newVal.toString().trim())) message = "Must be a valid Gmail address ending in @gmail.com.";
                        }
                        if (message) {
                            showToast(message, "warning");
                        }
                    });
                }

                // Re-validate after change
                this.validateCells(() => {
                    this.render();
                });

                // NEW: Compact rows upward in real-time (no leading blanks)
if (changes && source !== 'loadData') {
    changes.forEach(([row, prop, oldVal, newVal]) => {
        if (prop === 0 && oldVal === "" && newVal && newVal.trim() !== "") {
            // May bagong name na na-enter sa blank cell
            const data = this.getData();

            // Hanapin ang pinaka-unang row na blank ang name (from row 0)
            let firstBlankRow = -1;
            for (let r = 0; r < data.length; r++) {
                if ((data[r][0] || "").toString().trim() === "") {
                    firstBlankRow = r;
                    break;
                }
            }

            // Kung may nakitang blank sa itaas at hindi na siya mismo ang nasa unahan
            if (firstBlankRow !== -1 && firstBlankRow < row) {
                // I-copy ang buong row pataas
                for (let col = 0; col < data[row].length; col++) {
                    this.setDataAtCell(firstBlankRow, col, data[row][col], 'internal.compact');
                }
                // I-clear ang original row
                for (let col = 0; col < data[row].length; col++) {
                    if (col !== 2) { // Huwag galawin ang Gender (hidden)
                        this.setDataAtCell(row, col, "", 'internal.compact');
                    }
                }
            }
        }
    });
}

// NEW: Warning kapag may entry sa ibang column pero walang name
if (changes && source !== 'loadData' && source !== 'internal.compact') {
    changes.forEach(([row, prop, oldVal, newVal]) => {
        const colIndex = this.propToCol(prop);
        
        // Skip kung Name column (col 0) o Gender (col 2)
        if (colIndex === 0 || colIndex === 2) return;
        
        // Check kung may laman na yung cell na yun
        if (newVal && newVal.toString().trim() !== "" && oldVal !== newVal) {
            const currentName = this.getDataAtCell(row, 0)?.toString().trim() || "";
            
            if (currentName === "") {
                // Mag-toast ng warning
                showToast("Please enter a Name first before filling other details. This row will not be saved until a name is provided.", "warning");
                
                // Optional pero highly recommended: I-clear agad yung cell para hindi malito
                this.setDataAtCell(row, colIndex, "", 'internal.clear');
                
                // Optional: I-focus sa Name cell para madali silang mag-type
                setTimeout(() => {
                    this.selectCell(row, 0);
                }, 100);
            }
        }
    });
}
            },

            afterInit: function() {
                const instance = this;
                setTimeout(() => {
                    instance.validateCells(() => {
                        instance.render();
                    });
                }, 100);
            }
        });

        container.__hotInstance = hot;

        // Auto uppercase name
        hot.addHook('beforeChange', function(changes, source) {
            if (!changes || source === 'loadData') return;
            changes.forEach(change => {
                const col = change[1];
                let newValue = change[3];
                if (col === 0 && newValue !== null && typeof newValue === 'string') {
                    change[3] = newValue.toUpperCase();
                }
            });
        });
    }

    createStudentTable("boysHot", "boys");
    createStudentTable("girlsHot", "girls");

    window.exportData = function() {
        const d = getCardGen();
        const rows = [];

        rows.push(["Main Information", ""]);
        rows.push(["Track:", d.information.track || ""]);
        rows.push(["Strand:", d.information.strand || ""]);
        rows.push(["School Year:", d.information["school-year"] || ""]);
        rows.push(["Adviser:", d.information.adviser || ""]);
        rows.push(["Principal:", d.information.principal || ""]);
        rows.push(["Section:", d.information.section || ""]);
        rows.push(["Grade:", d.information.grade || ""]);
        rows.push([""]);
        rows.push(["Name", "Age", "gender", "LRN", "Parent", "Parent Number", "Parent Gmail"]);
        rows.push(["MALES", "", "", "", "", "", ""]);

        let boys = Object.values(d.students.boys || {}).map(s => [
            s.name||"", s.age||"", "MALE", s.lrn||"", s.parent||"", s.parentNumber||"", s.parentGmail||""
        ]);
        while (boys.length < 50) boys.push(["", "", "MALE", "", "", "", ""]);
        rows.push(...boys);

        rows.push(["FEMALES", "", "", "", "", "", ""]);

        let girls = Object.values(d.students.girls || {}).map(s => [
            s.name||"", s.age||"", "FEMALE", s.lrn||"", s.parent||"", s.parentNumber||"", s.parentGmail||""
        ]);
        while (girls.length < 50) girls.push(["", "", "FEMALE", "", "", "", ""]);
        rows.push(...girls);

        const ws = XLSX.utils.aoa_to_sheet(rows);
        ws["!merges"] = [
            { s: { r: 0, c: 0 }, e: { r: 0, c: 1 } },
            { s: { r: 10, c: 0 }, e: { r: 10, c: 6 } },
            { s: { r: 61, c: 0 }, e: { r: 61, c: 6 } }
        ];

        const boldCenter = { font: { bold: true }, alignment: { horizontal: "center", vertical: "center" } };
        ["A1", "A11", "A62"].forEach(a => { if (ws[a]) ws[a].s = boldCenter; });
        for (let c = 0; c < 7; c++) {
            const addr = XLSX.utils.encode_cell({ r: 9, c });
            if (ws[addr]) ws[addr].s = boldCenter;
        }

        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Main Data");
        XLSX.writeFile(wb, "CardGen2025.xlsx");

        showToast("Exported successfully!");
    };

    window.importData = function(e) {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(ev) {
            const data = new Uint8Array(ev.target.result);
            const wb = XLSX.read(data, { type: 'array' });

            const sheetName = wb.SheetNames.find(name => name.trim() === "Main Data");
            if (!sheetName) {
                alert("Error: No sheet named 'Main Data' found!\n\nPlease rename your sheet to exactly 'Main Data'.");
                return;
            }

            const sheet = wb.Sheets[sheetName];
            const range = XLSX.utils.decode_range(sheet['!ref']);

            let d = getCardGen();
            d.students.boys = {};
            d.students.girls = {};

            for (let R = range.s.r; R <= range.e.r; ++R) {
                const row = [];
                for (let C = range.s.c; C <= range.e.c; ++C) {
                    const cellAddress = XLSX.utils.encode_cell({ r: R, c: C });
                    const cell = sheet[cellAddress];
                    row.push(cell ? (cell.v || "").toString() : "");
                }

                const rowNum = R + 1;

                if (rowNum >= 2 && rowNum <= 8) {
                    const labelCell = sheet[XLSX.utils.encode_cell({ r: rowNum - 1, c: 0 })];
                    const valueCell = sheet[XLSX.utils.encode_cell({ r: rowNum - 1, c: 1 })];

                    if (labelCell && valueCell) {
                        const label = (labelCell.v || "").toString().trim();
                        const val = (valueCell.v || "").toString();

                        const map = {
                            "Track:": "track", "Strand:": "strand",
                            "School Year:": "school-year", "Adviser:": "adviser",
                            "Principal:": "principal", "Section:": "section", "Grade:": "grade"
                        };
                        if (map[label]) {
                            d.information[map[label]] = val;
                        }
                    }
                }

                if (rowNum >= 12 && rowNum <= 61) {
                    const nameCell = sheet[XLSX.utils.encode_cell({ r: rowNum - 1, c: 0 })];
                    if (nameCell && nameCell.v) {
                        const name = nameCell.v.toString().trim();
                        if (name) {
                            const rawName = nameCell.v.toString().trim();
                            if (rawName) {
                                const name = rawName.toUpperCase();  // ← DAGDAG NA LINYA TO!
                                const id = generateId("boys", Object.keys(d.students.boys).length);
                                d.students.boys[id] = {
                                    name: name,  // uppercase na 'to
                                    age: sheet[XLSX.utils.encode_cell({ r: rowNum - 1, c: 1 })]?.v?.toString() || "",
                                    gender: "MALE",
                                    lrn: sheet[XLSX.utils.encode_cell({ r: rowNum - 1, c: 3 })]?.v?.toString() || "",
                                    parent: sheet[XLSX.utils.encode_cell({ r: rowNum - 1, c: 4 })]?.v?.toString() || "",
                                    parentNumber: sheet[XLSX.utils.encode_cell({ r:  rowNum - 1, c: 5 })]?.v?.toString() || "",
                                    parentGmail: sheet[XLSX.utils.encode_cell({ r: rowNum - 1, c: 6 })]?.v?.toString() || ""
                                };
                            }
                        }
                    }
                }

                if (rowNum >= 63 && rowNum <= 112) {
                    const nameCell = sheet[XLSX.utils.encode_cell({ r: rowNum - 1, c: 0 })];
                    if (nameCell && nameCell.v) {
                        const rawName = nameCell.v.toString().trim();
                        if (rawName) {
                            const name = rawName.toUpperCase();  // ← SAME DAGDAG DITO
                            const id = generateId("girls", Object.keys(d.students.girls).length);
                            d.students.girls[id] = {
                                name: name,  // uppercase na rin
                                age: sheet[XLSX.utils.encode_cell({ r: rowNum - 1, c: 1 })]?.v?.toString() || "",
                                gender: "FEMALE",
                                lrn: sheet[XLSX.utils.encode_cell({ r: rowNum - 1, c: 3 })]?.v?.toString() || "",
                                parent: sheet[XLSX.utils.encode_cell({ r: rowNum - 1, c: 4 })]?.v?.toString() || "",
                                parentNumber: sheet[XLSX.utils.encode_cell({ r: rowNum - 1, c: 5 })]?.v?.toString() || "",
                                parentGmail: sheet[XLSX.utils.encode_cell({ r: rowNum - 1, c: 6 })]?.v?.toString() || ""
                            };
                        }
                    }
                }
            }


            saveGen(d);

            labels.forEach((l, i) => {
                metadataHot.setDataAtCell(i, 1, d.information[keys[i]] || "");
            });

            // Reload tables from storage (preserves imported order)
            reloadStudentTables();

            showToast("Import successful! Use the Sort button if you want alphabetical order.", "success");
            // === END OF NEW CODE ===
        };
        reader.readAsArrayBuffer(file);
    };

    window.confirmImport = function() {
        askConfirm(
            "Confirm Import Data",
            "Are you sure you want to import new data? This will overwrite the current Males and Females student data. This cannot be undone.",
            function() {
                document.getElementById('importFile').click();
                showToast("Select your Excel file to import.", "info");
            }
        );
    };

    window.showClearConfirmation = function() {
        askConfirm(
            "Confirm Clear Data",
            "Are you sure you want to clear Males and Females data? This cannot be undone.",
            confirmClearData
        );
    };

    window.confirmClearData = function() {
    // Clear sa storage
    let d = getCardGen();
    d.students.boys = {};
    d.students.girls = {};
    saveGen(d);

    // Gamitin ang reloadStudentTables() — ito ang consistent at proven way mo
    reloadStudentTables();

    showToast("Student data cleared successfully!", "success");

    // Optional: siguraduhin na ma-re-render
    setTimeout(() => {
        document.getElementById('boysHot')?.__hotInstance?.render();
        document.getElementById('girlsHot')?.__hotInstance?.render();
    }, 100);

    // Properly hide modal
    const modalElement = document.getElementById('confirmModal');
    const modalInstance = bootstrap.Modal.getInstance(modalElement);
    if (modalInstance) {
        modalInstance.hide();
    }
};

});

function sortStudentsAlphabetically() {
    askConfirm(
        "Sort Students Alphabetically",
        "This will sort both Males and Females by name alphabetically and save the new order. Continue?",
        function() {
            let data = getCardGen();

            // Sort boys
            const boysList = Object.values(data.students.boys)
                .filter(s => s.name && s.name.trim() !== "")
                .sort((a, b) => a.name.localeCompare(b.name));
            data.students.boys = {};
            boysList.forEach((student, index) => {
                const id = generateId("boys", index);
                data.students.boys[id] = student;
            });

            // Sort girls
            const girlsList = Object.values(data.students.girls)
                .filter(s => s.name && s.name.trim() !== "")
                .sort((a, b) => a.name.localeCompare(b.name));
            data.students.girls = {};
            girlsList.forEach((student, index) => {
                const id = generateId("girls", index);
                data.students.girls[id] = student;
            });

            saveGen(data);
            reloadStudentTables();

            // Re-validate both tables
            document.getElementById('boysHot').__hotInstance?.validateCells(() => document.getElementById('boysHot').__hotInstance?.render());
            document.getElementById('girlsHot').__hotInstance?.validateCells(() => document.getElementById('girlsHot').__hotInstance?.render());

            showToast("Students sorted alphabetically!", "success");
        }
    );
}

function askConfirm(title, message, onConfirm) {
    document.getElementById('confirmModalTitle').textContent = title;
    document.getElementById('confirmModalBody').textContent = message;

    const confirmBtn = document.getElementById('confirmModalConfirmBtn');
    const newConfirmBtn = confirmBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);

    newConfirmBtn.addEventListener('click', function() {
        if (onConfirm) onConfirm();
        const modalElement = document.getElementById('confirmModal');
        const modalInstance = bootstrap.Modal.getInstance(modalElement);
        if (modalInstance) {
            modalInstance.hide();
            modalElement.addEventListener('hidden.bs.modal', function cleanup() {
                forceHideModalBackdrop();
                modalElement.removeEventListener('hidden.bs.modal', cleanup);
            }, { once: true });
        }
    });

    const modalElement = document.getElementById('confirmModal');
    const modal = new bootstrap.Modal(modalElement, {
        keyboard: true,
        backdrop: 'static'
    });

    modal.show();

    modalElement.addEventListener('shown.bs.modal', function () {
        newConfirmBtn.focus();
    }, { once: true });
}

document.getElementById('confirmModal').addEventListener('shown.bs.modal', function () {
    const confirmBtn = document.getElementById('confirmModalConfirmBtn');
    const cancelBtn = document.querySelector('#confirmModal .btn-secondary[data-bs-dismiss="modal"]');

    confirmBtn.focus();

    const handleArrowKeys = (e) => {
        if (e.key === 'ArrowLeft' || e.key === 'ArrowRight') {
            e.preventDefault();
            if (document.activeElement === confirmBtn) {
                cancelBtn.focus();
            } else {
                confirmBtn.focus();
            }
        }
    };

    this.addEventListener('keydown', handleArrowKeys);

    this.addEventListener('hidden.bs.modal', function cleanup() {
        this.removeEventListener('keydown', handleArrowKeys);
        this.removeEventListener('hidden.bs.modal', cleanup);
    });
});
</script>

<script>
// ==================== SIGNATURE HANDLING WITH CROPPING AND REMOVAL ====================

let cropper = null;
let currentType = null;
let croppedBlob = null;
let currentImageUrl = null;

const DB_NAME = 'CardGenSignatures';
const DB_VERSION = 1;
const STORE_NAME = 'signatures';

let db = null;

async function initDB() {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);

        request.onupgradeneeded = (event) => {
            db = event.target.result;
            if (!db.objectStoreNames.contains(STORE_NAME)) {
                db.createObjectStore(STORE_NAME);
            }
        };

        request.onsuccess = (event) => {
            db = event.target.result;
            resolve(db);
        };

        request.onerror = (event) => reject(event.target.error);
    });
}

async function saveSignature(type, blob) {
    if (!type || typeof type !== 'string') {
        console.error('Invalid signature type:', type);
        throw new Error('Invalid signature type');
    }
    if (!blob) {
        console.warn('No blob to save');
        return;
    }
    await initDB();
    const transaction = db.transaction([STORE_NAME], 'readwrite');
    const store = transaction.objectStore(STORE_NAME);
    store.put(blob, type);
    return new Promise((resolve, reject) => {
        transaction.oncomplete = resolve;
        transaction.onerror = reject;
    });
}

async function loadSignature(type) {
    await initDB();
    const transaction = db.transaction([STORE_NAME], 'readonly');
    const store = transaction.objectStore(STORE_NAME);
    const request = store.get(type);
    return new Promise((resolve) => {
        request.onsuccess = () => resolve(request.result ? URL.createObjectURL(request.result) : null);
        request.onerror = () => resolve(null);
    });
}

async function removeSignature(type) {
    await initDB();
    const transaction = db.transaction([STORE_NAME], 'readwrite');
    const store = transaction.objectStore(STORE_NAME);
    store.delete(type);
    return new Promise((resolve, reject) => {
        transaction.oncomplete = resolve;
        transaction.onerror = reject;
    });
}

async function uploadSignature(event, type) {
    const file = event.target.files[0];
    if (!file || !file.type.startsWith('image/')) return alert('Invalid image.');
    if (file.size > 5 * 1024 * 1024) return alert('Image too large.');

    closeRemovalModal();
    closeCropModal();

    currentType = type;

    const img = document.getElementById('cropImage');
    if (currentImageUrl) URL.revokeObjectURL(currentImageUrl);
    currentImageUrl = URL.createObjectURL(file);
    img.src = '';
    img.src = currentImageUrl;

    document.getElementById('cropModal').style.display = 'flex';

    img.onload = () => {
        if (cropper) cropper.destroy();
        cropper = new Cropper(img, {
            aspectRatio: NaN,
            viewMode: 1,
            autoCropArea: 0.95,
            dragMode: 'move',
            guides: true,
            center: true,
            cropBoxMovable: true,
            cropBoxResizable: true,
            background: false,
            modal: false,
            zoomable: true,
            zoomOnWheel: true,
            zoomOnTouch: true
        });
    };
}

document.getElementById('cropSaveBtn').onclick = async () => {
    if (!cropper) return;

    const canvas = cropper.getCroppedCanvas({
        width: 500,
        height: 200,
        imageSmoothingEnabled: true,
        imageSmoothingQuality: 'high'
    });

    canvas.toBlob((blob) => {
        croppedBlob = blob;
        closeCropModal(true);
        openRemovalModal(blob);
    }, 'image/png');
};

let originalImageData = null;
let selectedBgColor = null;

async function openRemovalModal(blob) {
    const canvas = document.getElementById('removalCanvas');
    const ctx = canvas.getContext('2d', { willReadFrequently: true });

    const img = new Image();
    img.src = URL.createObjectURL(blob);
    img.onload = () => {
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img, 0, 0);
        
        originalImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        
        document.getElementById('toleranceSlider').value = 0;
        document.getElementById('toleranceValue').textContent = 0;
        
        selectedBgColor = getAverageBackgroundColor(originalImageData.data, canvas.width, canvas.height);
        
        document.getElementById('removalModal').style.display = 'flex';
        
        addColorPicker(canvas, ctx);
    };
}

function addColorPicker(canvas, ctx) {
    let picking = false;
    
    const existingPick = document.getElementById('pickBgButton');
    if (existingPick) existingPick.remove();
    
    const existingReset = document.getElementById('resetBgButton');
    if (existingReset) existingReset.remove();
    
    const pickButton = document.createElement('button');
    pickButton.id = 'pickBgButton';
    pickButton.textContent = 'Pick Background Color';
    pickButton.style.marginBottom = '10px';
    pickButton.onclick = () => {
        picking = true;
        canvas.style.cursor = 'crosshair';
        pickButton.textContent = 'Click on image to pick color';
    };
    
    const resetButton = document.createElement('button');
    resetButton.id = 'resetBgButton';
    resetButton.textContent = 'Reset to Auto';
    resetButton.style.marginBottom = '10px';
    resetButton.onclick = () => {
        selectedBgColor = getAverageBackgroundColor(originalImageData.data, canvas.width, canvas.height);
        applyBackgroundRemoval(document.getElementById('toleranceSlider').value);
    };
    
    const controls = document.querySelector('#removalModal div[style*="margin:15px 0"]');
    controls.insertAdjacentElement('beforebegin', pickButton);
    controls.insertAdjacentElement('beforebegin', resetButton);
    
    canvas.addEventListener('click', (e) => {
        if (!picking) return;
        
        const rect = canvas.getBoundingClientRect();
        const x = Math.floor((e.clientX - rect.left) * (canvas.width / rect.width));
        const y = Math.floor((e.clientY - rect.top) * (canvas.height / rect.height));
        
        const i = (y * canvas.width + x) * 4;
        const data = originalImageData.data;
        
        selectedBgColor = [data[i], data[i+1], data[i+2]];
        
        picking = false;
        canvas.style.cursor = 'default';
        pickButton.textContent = 'Pick Background Color';
        
        applyBackgroundRemoval(document.getElementById('toleranceSlider').value);
    });
}

function applyBackgroundRemoval(tolerance) {
    if (!originalImageData) return;
    
    const canvas = document.getElementById('removalCanvas');
    const ctx = canvas.getContext('2d');
    
    const imageData = new ImageData(
        new Uint8ClampedArray(originalImageData.data),
        originalImageData.width,
        originalImageData.height
    );
    
    const data = imageData.data;
    const bgColor = selectedBgColor || getAverageBackgroundColor(data, canvas.width, canvas.height);

    for (let i = 0; i < data.length; i += 4) {
        const r = data[i];
        const g = data[i + 1];
        const b = data[i + 2];
        const dist = colorDistance([r, g, b], bgColor);
        if (dist < tolerance) {
            data[i + 3] = 0;
        }
    }

    ctx.putImageData(imageData, 0, 0);
}

document.getElementById('toleranceSlider').oninput = function () {
    document.getElementById('toleranceValue').textContent = this.value;
    applyBackgroundRemoval(parseInt(this.value));
};

function getAverageBackgroundColor(data, width, height) {
    const corners = [
        0,
        (width - 1) * 4,
        (height - 1) * width * 4,
        data.length - 4
    ];

    let r = 0, g = 0, b = 0;
    corners.forEach(i => {
        r += data[i];
        g += data[i + 1];
        b += data[i + 2];
    });
    return [Math.round(r / 4), Math.round(g / 4), Math.round(b / 4)];
}

function colorDistance(c1, c2) {
    return Math.sqrt(
        Math.pow(c1[0] - c2[0], 2) +
        Math.pow(c1[1] - c2[1], 2) +
        Math.pow(c1[2] - c2[2], 2)
    );
}

document.getElementById('removalSaveBtn').onclick = async () => {
    if (!currentType) {
        console.error('No signature type defined');
        showToast("Error: No signature type defined", "error");
        return;
    }
    const canvas = document.getElementById('removalCanvas');
    canvas.toBlob(async (blob) => {
        if (!blob) {
            showToast("Error: Failed to process image", "error");
            return;
        }
        try {
            await saveSignature(currentType, blob);
            const previewDiv = document.getElementById(currentType + 'SigPreview');
            previewDiv.innerHTML = '';
            previewDiv.classList.add('checkerboard');
            const img = document.createElement('img');
            const url = URL.createObjectURL(blob);
            img.src = url;
            img.className = 'signature-preview';
            previewDiv.appendChild(img);
            addRemoveButton(previewDiv, currentType, url);
            showToast("Signature saved!", "success");
            closeRemovalModal();
        } catch (error) {
            console.error('Save failed:', error);
            showToast("Error saving signature", "error");
        }
    }, 'image/png');
};

document.getElementById('cropCancelBtn').onclick = () => closeCropModal(false);

function closeCropModal(keepType = false) {
    document.getElementById('cropModal').style.display = 'none';
    if (cropper) {
        cropper.destroy();
        cropper = null;
    }
    if (currentImageUrl) {
        URL.revokeObjectURL(currentImageUrl);
        currentImageUrl = null;
    }
    if (!keepType) currentType = null;
}

document.getElementById('removalCancelBtn').onclick = closeRemovalModal;

function closeRemovalModal() {
    document.getElementById('removalModal').style.display = 'none';
    croppedBlob = null;
    currentType = null;
    originalImageData = null;
    selectedBgColor = null;
}

async function loadSavedSignatures() {
    const teacherUrl = await loadSignature('teacher');
    if (teacherUrl) {
        const div = document.getElementById('teacherSigPreview');
        div.innerHTML = '';
        div.classList.add('checkerboard');
        const img = document.createElement('img');
        img.src = teacherUrl;
        img.className = 'signature-preview';
        div.appendChild(img);
        addRemoveButton(div, 'teacher', teacherUrl);
    }

    const principalUrl = await loadSignature('principal');
    if (principalUrl) {
        const div = document.getElementById('principalSigPreview');
        div.innerHTML = '';
        div.classList.add('checkerboard');
        const img = document.createElement('img');
        img.src = principalUrl;
        img.className = 'signature-preview';
        div.appendChild(img);
        addRemoveButton(div, 'principal', principalUrl);
    }
}

function addRemoveButton(div, type, url) {
    const btn = document.createElement('span');
    btn.className = 'remove-signature';
    btn.innerText = '×';
    btn.onclick = async () => {
        askConfirm(
            "Remove Signature",
            "Are you sure you want to remove this signature?",
            async function() {
                await removeSignature(type);
                div.innerHTML = '';
                if (url) URL.revokeObjectURL(url);
                showToast("Signature removed!");
            }
        );
    };
    div.appendChild(btn);
}

document.addEventListener('DOMContentLoaded', loadSavedSignatures);

function forceHideModalBackdrop() {
    const backdrop = document.querySelector('.modal-backdrop');
    if (backdrop) {
        backdrop.remove();
    }
    document.body.classList.remove('modal-open');
    document.body.style.removeProperty('overflow');
    document.body.style.removeProperty('padding-right');
}
</script>

<script>
// Search bar functionality
// Search bar functionality
document.addEventListener('DOMContentLoaded', () => {
    const searchBar = document.getElementById('searchBar');
    const clearSearch = document.getElementById('clearSearch');
    const searchSuggestions = document.getElementById('searchSuggestions');

    let searchTimer;
    let currentHighlightedCell = null;
    let selectedSuggestionIndex = -1; // Para sa keyboard navigation
    let suggestionItems = []; // Para i-store yung mga suggestion divs

    function removeHighlight() {
        if (currentHighlightedCell) {
            currentHighlightedCell.classList.remove('temp-highlight');
            currentHighlightedCell = null;
        }
    }

    function clearSelection() {
        suggestionItems.forEach(item => item.classList.remove('selected'));
        selectedSuggestionIndex = -1;
    }

    searchBar.addEventListener('input', (e) => {
        const query = e.target.value.trim().toLowerCase();
        if (!query) {
            clearSearch.style.display = 'none';
            searchSuggestions.style.display = 'none';
            removeHighlight();
            clearSelection();
            return;
        }
        clearSearch.style.display = 'block';
        searchSuggestions.style.display = 'block';
        searchSuggestions.innerHTML = '<div class="p-2 text-center"><div class="spinner-border spinner-border-sm text-dark" role="status"></div> Searching...</div>';
        clearTimeout(searchTimer);
        searchTimer = setTimeout(() => performSearch(query), 300);
    });

    searchBar.addEventListener('focus', () => {
        const query = searchBar.value.trim().toLowerCase();
        if (query) {
            performSearch(query);
            searchSuggestions.style.display = 'block';
        }
    });

    // Keyboard navigation
    searchBar.addEventListener('keydown', (e) => {
        if (searchSuggestions.style.display === 'none' || suggestionItems.length === 0) return;

        if (e.key === 'ArrowDown') {
            e.preventDefault();
            selectedSuggestionIndex = (selectedSuggestionIndex + 1) % suggestionItems.length;
            updateSelection();
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            selectedSuggestionIndex = (selectedSuggestionIndex - 1 + suggestionItems.length) % suggestionItems.length;
            updateSelection();
        } else if (e.key === 'Enter') {
            e.preventDefault();
            if (selectedSuggestionIndex >= 0 && suggestionItems[selectedSuggestionIndex]) {
                suggestionItems[selectedSuggestionIndex].click();
                searchBar.blur(); // Tinatanggal yung focus → nawawala yung blinking cursor
            }
        } else if (e.key === 'Escape') {
            searchSuggestions.style.display = 'none';
            clearSelection();
        }
    });

    function updateSelection() {
        suggestionItems.forEach((item, index) => {
            if (index === selectedSuggestionIndex) {
                item.classList.add('selected');
                item.scrollIntoView({ block: 'nearest' });
            } else {
                item.classList.remove('selected');
            }
        });
    }

    clearSearch.addEventListener('click', () => {
        searchBar.value = '';
        clearSearch.style.display = 'none';
        searchSuggestions.style.display = 'none';
        removeHighlight();
        clearSelection();
        searchBar.focus();
    });

    document.addEventListener('click', (e) => {
        if (!searchBar.contains(e.target) && !searchSuggestions.contains(e.target)) {
            searchSuggestions.style.display = 'none';
            clearSelection();
        }
    });

    function performSearch(query) {
        const boysHot = document.getElementById('boysHot').__hotInstance;
        const girlsHot = document.getElementById('girlsHot').__hotInstance;
        const matches = [];

        [{ hot: boysHot, gender: 'M', table: 'boys' }, { hot: girlsHot, gender: 'F', table: 'girls' }].forEach(group => {
            group.hot.getData().forEach((row, rowIndex) => {
                const name = row[0].trim();
                const nameLower = name.toLowerCase();
                const lrn = row[3].toString().trim();
                if (name || lrn) {
                    if (nameLower.includes(query)) {
                        matches.push({
                            text: name,
                            lower: nameLower,
                            isName: true,
                            col: 0,
                            rowIndex,
                            gender: group.gender,
                            table: group.table
                        });
                    }
                    if (lrn.includes(query)) {
                        matches.push({
                            text: lrn,
                            lower: lrn.toLowerCase(),
                            isName: false,
                            col: 3,
                            rowIndex,
                            gender: group.gender,
                            table: group.table
                        });
                    }
                }
            });
        });

        matches.sort((a, b) => a.text.localeCompare(b.text));

        if (!matches.length) {
            searchSuggestions.innerHTML = `<div class="p-2 text-muted">No results found for "${searchBar.value}"</div>`;
            suggestionItems = [];
            clearSelection();
            return;
        }

        searchSuggestions.innerHTML = '';
        suggestionItems = [];
        selectedSuggestionIndex = -1;

        matches.forEach(match => {
            const div = document.createElement('div');
            div.className = 'suggestion-item p-2 border-bottom';
            div.style.cursor = 'pointer';
            div.dataset.table = match.table;
            div.dataset.row = match.rowIndex;
            div.dataset.col = match.col;

            const escaped = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            const regex = new RegExp(escaped, 'gi');
            const highlighted = match.text.replace(regex, '<strong>$&</strong>');

            const genderClass = match.gender === 'M' ? 'bg-primary text-white' : 'bg-pink text-dark';
            div.innerHTML = `
                <span style="flex-grow: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${highlighted}</span>
                <span class="badge ${genderClass}">${match.gender}</span>
            `;

            div.addEventListener('mouseover', () => { 
                clearSelection();
                div.classList.add('selected');
                selectedSuggestionIndex = suggestionItems.length;
            });
            div.addEventListener('mouseout', () => {
                if (selectedSuggestionIndex !== suggestionItems.length) {
                    div.classList.remove('selected');
                }
            });
            div.addEventListener('click', handleSuggestionClick);

            searchSuggestions.appendChild(div);
            suggestionItems.push(div);
        });
    }

    function handleSuggestionClick(e) {
        const item = e.currentTarget;
        const table = item.dataset.table;
        const row = parseInt(item.dataset.row);
        const col = parseInt(item.dataset.col);

        searchSuggestions.style.display = 'none';
        clearSelection();

        removeHighlight();

        const hotContainer = document.getElementById(table + 'Hot');
        hotContainer.scrollIntoView({ behavior: 'smooth' });

        const hot = hotContainer.__hotInstance;
        hot.scrollViewportTo(row, col);
        hot.render();

        setTimeout(() => {
            const td = hot.getCell(row, col);
            if (td) {
                td.classList.add('temp-highlight');
                currentHighlightedCell = td;

                const cellRect = td.getBoundingClientRect();
                const offset = cellRect.top + window.scrollY - (window.innerHeight / 2) + (cellRect.height / 2);
                window.scrollTo({ top: offset, behavior: 'smooth' });
            }
        }, 300);
    }
});
</script>

<script>
    // ==================== GLOBAL UTILITIES (Must be defined before any use) ====================
    const STORAGE_KEY = "CardGen";
    
    function getCardGen() {
        return JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");
    }
    
    function saveGen(data) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }
    
    function generateId(gender, index) {
        const prefix = gender === "boys" ? "2025-01-" : "2025-02-";
        return prefix + String(index + 1).padStart(4, "0");
    }
    
    function reloadStudentTables() {
    const data = getCardGen();

    // Boys
    let boysRows = Object.values(data.students.boys || {}).map(s => [
        s.name || "", s.age || "", "MALE", s.lrn || "", s.parent || "", s.parentNumber || "", s.parentGmail || ""
    ]);
    while (boysRows.length < 50) boysRows.push(["", "", "MALE", "", "", "", ""]);
    
    const boysHot = document.getElementById('boysHot')?.__hotInstance;
    if (boysHot) {
        boysHot.loadData(boysRows);
        boysHot.validateCells(() => {
            boysHot.render();
        });
    }

    // Girls
    let girlsRows = Object.values(data.students.girls || {}).map(s => [
        s.name || "", s.age || "", "FEMALE", s.lrn || "", s.parent || "", s.parentNumber || "", s.parentGmail || ""
    ]);
    while (girlsRows.length < 50) girlsRows.push(["", "", "FEMALE", "", "", "", ""]);
    
    const girlsHot = document.getElementById('girlsHot')?.__hotInstance;
    if (girlsHot) {
        girlsHot.loadData(girlsRows);
        girlsHot.validateCells(() => {
            girlsHot.render();
        });
    }
}

    function sortStudentsAlphabetically() {
        askConfirm(
            "Sort Students Alphabetically",
            "This will sort both Males and Females by name alphabetically and save the new order. Continue?",
            function() {
                const data = getCardGen();
    
                // Sort boys
                const boysList = Object.values(data.students.boys)
                    .filter(s => s.name?.trim())
                    .sort((a, b) => a.name.localeCompare(b.name));
                data.students.boys = {};
                boysList.forEach((student, index) => {
                    data.students.boys[generateId("boys", index)] = student;
                });
    
                // Sort girls
                const girlsList = Object.values(data.students.girls)
                    .filter(s => s.name?.trim())
                    .sort((a, b) => a.name.localeCompare(b.name));
                data.students.girls = {};
                girlsList.forEach((student, index) => {
                    data.students.girls[generateId("girls", index)] = student;
                });
    
                saveGen(data);
                reloadStudentTables();
    
                document.getElementById('boysHot')?.__hotInstance?.render();
                document.getElementById('girlsHot')?.__hotInstance?.render();
    
                showToast("Students sorted alphabetically!", "success");
            }
        );
    }
    </script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/handsontable@14.4.0/dist/handsontable.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="SideBar-NavBar.js"></script>
<script src="Logout.js"></script>
<script src="Toast.js"></script>
</body>
</html>