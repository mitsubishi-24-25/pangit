<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Information</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="../Assets/CSS/root.css">
    <link rel="stylesheet" href="../Assets/CSS/Toast.css">
    <link rel="stylesheet" href="../CSS/admin-style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@14.4.0/dist/handsontable.full.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.2/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.2/cropper.min.js"></script>
    <style>
        .button-row {
            margin-bottom: 20px;
        }

        .btn-group-left {
            display: flex;
            gap: 10px;
        }

        .btn-right {
            margin-left: auto;
        }

        .hot-container {
            height: 300px;
            border: 1px solid var(--primarydark-color);
            margin-bottom: 20px;
            overflow: auto;
        }

        .student-table {
            height: 300px;
        }


        .signature-preview {
            max-width: 200px;
            max-height: 100px;
            margin: 10px 0;
            border: 1px solid var(--background-color);
        }

        .remove-signature {
            position: absolute;
            top: -15px !important;
            right: -3px !important;
            background: #dc3545 !important;
            color: var(--secondary-color) !important;
            border: 3px solid var(--secondary-color) !important;
            border-radius: 50%;
            width: 32px !important;
            height: 32px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            font-weight: bold !important;
            font-size: 20px !important;
            cursor: pointer !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4) !important;
            z-index: 1000 !important;
            line-height: 1 !important;
        }

        .remove-signature:hover {
            background: #c82333 !important;
            transform: scale(1.15) !important;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.5) !important;
        }

        #teacherSigPreview,
        #principalSigPreview {
            width: 300px;
            height: 150px;
            border: 2px dashed #ccc;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: visible !important;
            margin: 10px 0;
        }

        .metadata-table {
            height: 250px;
        }


        .htInvalid {
            background-color: var(--background-color) !important;
            border: 2px solid #f44336 !important;
        }

        .space {
            height: 20px;
        }

        .btn .btn-secondary {
            background-color: var(--danger) !important;
        }

        .handsontable thead th .relative {
            background-color: var(--accent-color);
            border: 1px solid var(--primarydark-color);
        }

        .handsontable table {
            border-collapse: collapse;
            border: 1px solid var(--primarydark-color);
        }

        .ht_master tb {
            background-color: var(--accent-color);
            border: 1px solid var(--primarydark-color);
        }


        .modal {
            z-index: 9999;
        }

        #confirmModal .btn-danger:focus {
            box-shadow: 0 0 0 0.25rem rgba(134, 0, 13, 0.795);
        }


        .checkerboard {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 20 20'%3E%3Crect width='10' height='10' fill='%23ddd'/%3E%3Crect x='10' y='10' width='10' height='10' fill='%23ddd'/%3E%3C/svg%3E");
            background-size: 20px 20px;
            background-repeat: repeat;
        }


        .signature-preview {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            background: transparent !important;
        }


        #removalModal .canvas-container {
            width: 100%;
            height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            border: 1px solid #ddd;
            border-radius: 8px;
        }


        #searchBar {
            background-color: var(--secondary-color);
            border: 1px solid var(--dark-mode-color);
            color: var(--dark-mode-color);
            padding-right: 40px;
        }

        #searchBar::placeholder {
            color: black;
        }

        #clearSearch {
            font-size: 2em;
            font-weight: bold;
            line-height: 1;
            padding: 0 8px;
        }

        .bg-pink {
            background-color: red !important;
        }

        .temp-highlight {
            background-color: var(--lowPrimary) !important;
            color: black;
            font-weight: bold;
            border: 1px dashed var(--primarydark-color) !important;
        }

        #searchSuggestions {
            font-family: 'Poppins', sans-serif;
        }

        .suggestion-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            border-bottom: 1px solid #dee2e6;
            color: var(--dark-mode-color);
        }

        .suggestion-item .badge {
            flex-shrink: 0;
            margin-left: 10px;
        }

        @media (max-width: 576px) {
            .navbar-brand-container {
                width: 100%;
                text-align: center;
            }

            .search-container {
                width: 100%;
                margin-top: 5px;
            }

            #searchBar {
                width: 100% !important;
            }
        }

        @media (min-width: 577px) {
            .search-container {
                flex-grow: 1;
                max-width: 400px;
            }

            #searchBar {
                width: 100%;
            }
        }

        .suggestion-item:hover,
        .suggestion-item.selected {
            background-color: #e9ecef !important;
        }

        .text-muted {
            color: black !important;
        }


        .htRowHighlighted {
            background-color: var(--lowPrimary) !important;
            border-bottom: var(--primarydark-color) 1px dashed !important;
            border-top: var(--primarydark-color) 1px dashed !important;
            font-weight: bold !important;
            color: black;
            vertical-align: middle !important;
        }

        .btn-primary {
            background: var(--gradient-main) !important;
            border: none !important;
            box-shadow: 0 2px 8px rgba(0, 120, 233, 0.3) !important;
            transition: all 0.2s ease !important;
        }

        .btn-primary:hover {
            background: var(--gradient-main-hover) !important;
            transform: translateY(-1px) !important;
            box-shadow: 0 4px 14px rgba(0, 120, 233, 0.4) !important;
        }

        .page-header {
            background: linear-gradient(135deg, rgba(0, 120, 233, 0.08) 0%, rgba(0, 196, 255, 0.05) 100%);
            border: 1px solid rgba(0, 120, 233, 0.12);
            border-radius: 12px;
            padding: 16px 20px;
            margin-bottom: 20px;
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-light bg-primary shadow-sm fixed-top" data-bs-theme="dark">
        <div class="container-fluid">
            <div class="d-flex align-items-center w-100 justify-content-between flex-wrap">
                <div class="d-flex align-items-center">
                    <button class="btn btn-outline-secondary me-2 d-lg-none" id="toggleBtn">☰</button>
                    <span class="navbar-brand mb-0 h1 navbar-brand-container d-none d-lg-inline" id="Hi">CardGen: From
                        Grade Consolidation to Printable Report Card for Senior High School</span>
                    <span class="navbar-brand mb-0 h1 navbar-brand-container d-inline d-lg-none" id="Hi"
                        onclick="dboard()">CardGen 2025</span>
                </div>
                <div class="search-container position-relative ms-lg-auto">
                    <input type="text" id="searchBar" class="form-control" placeholder="Search Name or LRN"
                        autocomplete="off" autocorrect="off" autocapitalize="off">
                    <span id="clearSearch" class="position-absolute"
                        style="right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer; display: none; color: black;">×</span>
                    <div id="searchSuggestions" class="position-absolute bg-white border border-black shadow"
                        style="display: none; width: 100%; max-height: 250px; overflow-y: auto; z-index: 1051; top: 100%; left: 0;">
                    </div>
                </div>
            </div>
        </div>
    </nav>
    <div class="sidebar collapsed" id="sidebar">
        <ul class="nav flex-column px-3">
            <div id="sidebar-container"></div>
        </ul>
    </div>
    <div class="main-content">
        <div class="container-fluid container">
            <div class="row">
                <div class="col-12">
                    <div class="d-flex button-row flex-wrap gap-3 align-items-center">
                        <div class="btn-group-left d-flex flex-wrap gap-2">
                            <button class="btn btn-primary" onclick="exportData()">Export Data</button>
                            <button class="btn btn-secondary" onclick="window.confirmImport()">Import Data</button>
                            <input type="file" id="importFile" accept=".xlsx,.xls" style="display:none"
                                onchange="importData(event)">
                        </div>
                        <div class="ms-auto"></div>
                        <button class="btn btn-danger flex-shrink-0" onclick="showClearConfirmation()">Clear Data
                            (Male/Female)</button>
                    </div>
                    <div id="metadataHot" class="hot-container metadata-table"></div>

                    <div class="d-flex justify-content-start my-3 gap-2">
                        <button class="btn btn-success" onclick="sortStudentsAlphabetically()">
                            Sort Students Alphabetically
                        </button>

                        <div class="form-check form-switch align-self-center">
                            <input class="form-check-input" type="checkbox" id="rowTrackerToggle" checked>
                            <label class="form-check-label" for="rowTrackerToggle">
                                Row Tracker (highlight on click)
                            </label>
                        </div>
                    </div>
                    <h5>Males Data</h5>
                    <div id="boysHot" class="hot-container student-table"></div>
                    <div class="space"></div>
                    <h5>Females Data</h5>
                    <div id="girlsHot" class="hot-container student-table"></div>
                    <div class="d-flex button-row">
                        <div class="btn-group-left">
                            <button class="btn btn-info"
                                onclick="document.getElementById('teacherSigFile').click()">Upload Teacher
                                Signature</button>
                            <input type="file" id="teacherSigFile" accept="image/*" style="display:none"
                                onchange="uploadSignature(event, 'teacher')">
                            <div id="teacherSigPreview" style="position:relative; display:inline-block;"></div>
                            <button class="btn btn-info"
                                onclick="document.getElementById('principalSigFile').click()">Upload Principal
                                Signature</button>
                            <input type="file" id="principalSigFile" accept="image/*" style="display:none"
                                onchange="uploadSignature(event, 'principal')">
                            <div id="principalSigPreview" style="position:relative; display:inline-block;"></div>
                        </div>
                    </div>

                    <div class="modal fade" style="z-index: 9999;" id="confirmModal" tabindex="-1" aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="confirmModalTitle">Confirm Action</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"
                                        aria-label="Close"></button>
                                </div>
                                <div class="modal-body" id="confirmModalBody">
                                    Are you sure you want to proceed?
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary"
                                        data-bs-dismiss="modal">Cancel</button>
                                    <button type="button" class="btn btn-danger" id="confirmModalConfirmBtn"
                                        autofocus>Confirm</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="cropModal" class="modal"
                        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:9999; justify-content:center; align-items:center;">
                        <div
                            style="background:white; padding:20px; border-radius:10px; max-width:90%; max-height:90%; width:700px; display:flex; flex-direction:column;">
                            <h3>Crop Signature</h3>
                            <div style="flex:1; min-height:300px; position:relative;">
                                <img id="cropImage" style="max-width:100%; display:block;">
                            </div>
                            <div style="margin-top:20px; text-align:right;">
                                <button id="cropCancelBtn" style="margin-right:10px;">Cancel</button>
                                <button id="cropSaveBtn" class="btn btn-primary">Crop & Proceed to Removal</button>
                            </div>
                        </div>
                    </div>

                    <div id="removalModal" class="modal"
                        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:9999; justify-content:center; align-items:center;">
                        <div
                            style="background:white; padding:20px; border-radius:10px; max-width:90%; max-height:90%; width:700px; display:flex; flex-direction:column;">
                            <h3>Adjust Background Removal</h3>
                            <p>Note: This step is only necessary if you are using a background color other than white.
                                If the background is white, you may skip this step. For best results, ensure the
                                signature is a dark color with enough contrast against the background.</p>
                            <div class="canvas-container checkerboard">
                                <canvas id="removalCanvas"
                                    style="max-width:100%; max-height:100%; object-fit:contain; display:block;"></canvas>
                            </div>
                            <div style="margin:15px 0; padding:10px; background:#f8f9fa; border-radius:8px;">
                                <label style="font-weight:bold; display:block; margin-bottom:8px;">
                                    Removal Strength:
                                </label>
                                <div style="display:flex; align-items:center; gap:15px;">
                                    <input type="range" id="toleranceSlider" min="0" max="200" value="0" step="5"
                                        style="flex:1;">
                                    <span id="toleranceValue" style="min-width:50px; font-weight:bold;">0</span>
                                </div>
                                <small style="color:#666; display:block; margin-top:5px;">
                                    0 = No removal | 200 = Maximum aggressive
                                </small>
                            </div>
                            <div style="margin-top:20px; text-align:right;">
                                <button id="removalCancelBtn" style="margin-right:10px;">Cancel</button>
                                <button id="removalSaveBtn" class="btn btn-primary">Save</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="../Assets/JS/Loader.js"></script>
    <script>
        loadSidebar("Student_Information.html");
    </script>

    <script>
        const STORAGE_KEY = "CardGen";

        function getCardGen() {
            return JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");
        }

        function saveGen(data) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        }

        function reloadStudentTables() {
            const data = getCardGen();

            let boysRows = Object.values(data.students.boys || {}).map(s => [
                s.name || "",
                s.age || "",
                "MALE",
                s.lrn || "",
                s.parent || "",
                s.parentNumber || "",
                s.parentGmail || ""
            ]);
            while (boysRows.length < 50) boysRows.push(["", "", "MALE", "", "", "", ""]);
            const boysHot = document.getElementById('boysHot')?.__hotInstance;
            if (boysHot) {
                boysHot.loadData(boysRows);
                boysHot.validateCells(() => boysHot.render());
            }

            let girlsRows = Object.values(data.students.girls || {}).map(s => [
                s.name || "",
                s.age || "",
                "FEMALE",
                s.lrn || "",
                s.parent || "",
                s.parentNumber || "",
                s.parentGmail || ""
            ]);
            while (girlsRows.length < 50) girlsRows.push(["", "", "FEMALE", "", "", "", ""]);
            const girlsHot = document.getElementById('girlsHot')?.__hotInstance;
            if (girlsHot) {
                girlsHot.loadData(girlsRows);
                girlsHot.validateCells(() => girlsHot.render());
            }
        }

        let cropper = null;
        let currentType = null;
        let croppedBlob = null;
        let currentImageUrl = null;
        const DB_NAME = 'CardGenSignatures';
        const DB_VERSION = 1;
        const STORE_NAME = 'signatures';
        let db = null;

        async function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        db.createObjectStore(STORE_NAME);
                    }
                };
                request.onsuccess = (event) => {
                    db = event.target.result;
                    resolve(db);
                };
                request.onerror = (event) => reject(event.target.error);
            });
        }

        async function saveSignature(type, blob) {
            if (!type || typeof type !== 'string') throw new Error('Invalid signature type');
            if (!blob) return;
            await initDB();
            const transaction = db.transaction([STORE_NAME], 'readwrite');
            const store = transaction.objectStore(STORE_NAME);
            store.put(blob, type);
            return new Promise((resolve, reject) => {
                transaction.oncomplete = resolve;
                transaction.onerror = reject;
            });
        }

        async function loadSignature(type) {
            await initDB();
            const transaction = db.transaction([STORE_NAME], 'readonly');
            const store = transaction.objectStore(STORE_NAME);
            const request = store.get(type);
            return new Promise((resolve) => {
                request.onsuccess = () => resolve(request.result ? URL.createObjectURL(request.result) : null);
                request.onerror = () => resolve(null);
            });
        }

        async function removeSignature(type) {
            await initDB();
            const transaction = db.transaction([STORE_NAME], 'readwrite');
            const store = transaction.objectStore(STORE_NAME);
            store.delete(type);
            return new Promise((resolve, reject) => {
                transaction.oncomplete = resolve;
                transaction.onerror = reject;
            });
        }

        async function uploadSignature(event, type) {
            const file = event.target.files[0];
            if (!file || !file.type.startsWith('image/')) return alert('Invalid image.');
            if (file.size > 5 * 1024 * 1024) return alert('Image too large.');
            closeRemovalModal();
            closeCropModal();
            currentType = type;
            const img = document.getElementById('cropImage');
            if (currentImageUrl) URL.revokeObjectURL(currentImageUrl);
            currentImageUrl = URL.createObjectURL(file);
            img.src = '';
            img.src = currentImageUrl;
            document.getElementById('cropModal').style.display = 'flex';
            img.onload = () => {
                if (cropper) cropper.destroy();
                cropper = new Cropper(img, {
                    aspectRatio: NaN,
                    viewMode: 1,
                    autoCropArea: 0.95,
                    dragMode: 'move',
                    guides: true,
                    center: true,
                    cropBoxMovable: true,
                    cropBoxResizable: true,
                    background: false,
                    modal: false,
                    zoomable: true,
                    zoomOnWheel: true,
                    zoomOnTouch: true
                });
            };
        }

        document.getElementById('cropSaveBtn').onclick = async () => {
            if (!cropper) return;
            const canvas = cropper.getCroppedCanvas({
                width: 500,
                height: 200,
                imageSmoothingEnabled: true,
                imageSmoothingQuality: 'high'
            });
            canvas.toBlob((blob) => {
                croppedBlob = blob;
                closeCropModal(true);
                openRemovalModal(blob);
            }, 'image/png');
        };

        async function openRemovalModal(blob) {
            const canvas = document.getElementById('removalCanvas');
            const ctx = canvas.getContext('2d', { willReadFrequently: true });
            const img = new Image();
            img.src = URL.createObjectURL(blob);
            img.onload = () => {
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.drawImage(img, 0, 0);
                originalImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                document.getElementById('toleranceSlider').value = 0;
                document.getElementById('toleranceValue').textContent = 0;
                selectedBgColor = getAverageBackgroundColor(originalImageData.data, canvas.width, canvas.height);
                document.getElementById('removalModal').style.display = 'flex';
                addColorPicker(canvas, ctx);
            };
        }

        function addColorPicker(canvas, ctx) {
            let picking = false;
            const existingPick = document.getElementById('pickBgButton');
            if (existingPick) existingPick.remove();
            const existingReset = document.getElementById('resetBgButton');
            if (existingReset) existingReset.remove();
            const pickButton = document.createElement('button');
            pickButton.id = 'pickBgButton';
            pickButton.textContent = 'Pick Background Color';
            pickButton.style.marginBottom = '10px';
            pickButton.onclick = () => {
                picking = true;
                canvas.style.cursor = 'crosshair';
                pickButton.textContent = 'Click on image to pick color';
            };
            const resetButton = document.createElement('button');
            resetButton.id = 'resetBgButton';
            resetButton.textContent = 'Reset to Auto';
            resetButton.style.marginBottom = '10px';
            resetButton.onclick = () => {
                selectedBgColor = getAverageBackgroundColor(originalImageData.data, canvas.width, canvas.height);
                applyBackgroundRemoval(document.getElementById('toleranceSlider').value);
            };
            const controls = document.querySelector('#removalModal div[style*="margin:15px 0"]');
            controls.insertAdjacentElement('beforebegin', pickButton);
            controls.insertAdjacentElement('beforebegin', resetButton);
            canvas.addEventListener('click', (e) => {
                if (!picking) return;
                const rect = canvas.getBoundingClientRect();
                const x = Math.floor((e.clientX - rect.left) * (canvas.width / rect.width));
                const y = Math.floor((e.clientY - rect.top) * (canvas.height / rect.height));
                const i = (y * canvas.width + x) * 4;
                const data = originalImageData.data;
                selectedBgColor = [data[i], data[i + 1], data[i + 2]];
                picking = false;
                canvas.style.cursor = 'default';
                pickButton.textContent = 'Pick Background Color';
                applyBackgroundRemoval(document.getElementById('toleranceSlider').value);
            });
        }

        function applyBackgroundRemoval(tolerance) {
            if (!originalImageData) return;
            const canvas = document.getElementById('removalCanvas');
            const ctx = canvas.getContext('2d');
            const imageData = new ImageData(
                new Uint8ClampedArray(originalImageData.data),
                originalImageData.width,
                originalImageData.height
            );
            const data = imageData.data;
            const bgColor = selectedBgColor || getAverageBackgroundColor(data, canvas.width, canvas.height);
            for (let i = 0; i < data.length; i += 4) {
                const r = data[i];
                const g = data[i + 1];
                const b = data[i + 2];
                const dist = colorDistance([r, g, b], bgColor);
                if (dist < tolerance) {
                    data[i + 3] = 0;
                }
            }
            ctx.putImageData(imageData, 0, 0);
        }

        document.getElementById('toleranceSlider').oninput = function () {
            document.getElementById('toleranceValue').textContent = this.value;
            applyBackgroundRemoval(parseInt(this.value));
        };

        function getAverageBackgroundColor(data, width, height) {
            const corners = [0, (width - 1) * 4, (height - 1) * width * 4, data.length - 4];
            let r = 0, g = 0, b = 0;
            corners.forEach(i => {
                r += data[i];
                g += data[i + 1];
                b += data[i + 2];
            });
            return [Math.round(r / 4), Math.round(g / 4), Math.round(b / 4)];
        }

        function colorDistance(c1, c2) {
            return Math.sqrt(
                Math.pow(c1[0] - c2[0], 2) +
                Math.pow(c1[1] - c2[1], 2) +
                Math.pow(c1[2] - c2[2], 2)
            );
        }

        document.getElementById('removalSaveBtn').onclick = async () => {
            if (!currentType) {
                console.error('No signature type defined');
                showToast("Error: No signature type defined", "error");
                return;
            }
            const canvas = document.getElementById('removalCanvas');
            canvas.toBlob(async (blob) => {
                if (!blob) {
                    showToast("Error: Failed to process image", "error");
                    return;
                }
                try {
                    await saveSignature(currentType, blob);
                    const previewDiv = document.getElementById(currentType + 'SigPreview');
                    previewDiv.innerHTML = '';
                    previewDiv.classList.add('checkerboard');
                    const img = document.createElement('img');
                    const url = URL.createObjectURL(blob);
                    img.src = url;
                    img.className = 'signature-preview';
                    previewDiv.appendChild(img);
                    addRemoveButton(previewDiv, currentType, url);
                    showToast("Signature saved!", "success");
                    closeRemovalModal();
                } catch (error) {
                    console.error('Save failed:', error);
                    showToast("Error saving signature", "error");
                }
            }, 'image/png');
        };

        document.getElementById('cropCancelBtn').onclick = () => closeCropModal(false);

        function closeCropModal(keepType = false) {
            document.getElementById('cropModal').style.display = 'none';
            if (cropper) {
                cropper.destroy();
                cropper = null;
            }
            if (currentImageUrl) {
                URL.revokeObjectURL(currentImageUrl);
                currentImageUrl = null;
            }
            if (!keepType) currentType = null;
        }

        document.getElementById('removalCancelBtn').onclick = closeRemovalModal;

        function closeRemovalModal() {
            document.getElementById('removalModal').style.display = 'none';
            croppedBlob = null;
            currentType = null;
            originalImageData = null;
            selectedBgColor = null;
        }

        async function loadSavedSignatures() {
            const teacherUrl = await loadSignature('teacher');
            if (teacherUrl) {
                const div = document.getElementById('teacherSigPreview');
                div.innerHTML = '';
                div.classList.add('checkerboard');
                const img = document.createElement('img');
                img.src = teacherUrl;
                img.className = 'signature-preview';
                div.appendChild(img);
                addRemoveButton(div, 'teacher', teacherUrl);
            }
            const principalUrl = await loadSignature('principal');
            if (principalUrl) {
                const div = document.getElementById('principalSigPreview');
                div.innerHTML = '';
                div.classList.add('checkerboard');
                const img = document.createElement('img');
                img.src = principalUrl;
                img.className = 'signature-preview';
                div.appendChild(img);
                addRemoveButton(div, 'principal', principalUrl);
            }
        }

        function addRemoveButton(div, type, url) {
            const btn = document.createElement('span');
            btn.className = 'remove-signature';
            btn.innerText = '×';
            btn.onclick = async () => {
                askConfirm(
                    "Remove Signature",
                    "Are you sure you want to remove this signature?",
                    async function () {
                        await removeSignature(type);
                        div.innerHTML = '';
                        if (url) URL.revokeObjectURL(url);
                        showToast("Signature removed!");
                    }
                );
            };
            div.appendChild(btn);
        }

        document.addEventListener('DOMContentLoaded', loadSavedSignatures);

        function forceHideModalBackdrop() {
            const backdrop = document.querySelector('.modal-backdrop');
            if (backdrop) backdrop.remove();
            document.body.classList.remove('modal-open');
            document.body.style.removeProperty('overflow');
            document.body.style.removeProperty('padding-right');
        }

        function attachRowClickTracker(hot) {
            if (!hot) return;

            hot.removeHook('afterSelectionEnd', highlightRow);
            hot.removeHook('afterOnCellMouseDown', handleRowHeaderClick);

            function highlightRow(rowFrom, colFrom, rowTo, colTo) {
                const toggle = document.getElementById('rowTrackerToggle');
                if (toggle && !toggle.checked) return;

                // Clear any existing row highlights in this table
                const tbody = hot.getCell(0, 0)?.closest('tbody');
                if (tbody) {
                    tbody.querySelectorAll('.htRowHighlighted').forEach(cell => {
                        cell.classList.remove('htRowHighlighted');
                    });
                }

                // If it's a single row selection, highlight it
                if (rowFrom === rowTo && rowFrom >= 0) {
                    for (let col = 0; col < hot.countCols(); col++) {
                        const cell = hot.getCell(rowFrom, col);
                        if (cell) {
                            cell.classList.add('htRowHighlighted');
                        }
                    }
                }
            }

            function handleRowHeaderClick(event, coords) {
                if (coords.row >= 0 && coords.col === -1) { // row header
                    const toggle = document.getElementById('rowTrackerToggle');
                    if (toggle && !toggle.checked) return;

                    // Clear any existing row highlights in this table
                    const tbody = hot.getCell(0, 0)?.closest('tbody');
                    if (tbody) {
                        tbody.querySelectorAll('.htRowHighlighted').forEach(cell => {
                            cell.classList.remove('htRowHighlighted');
                        });
                    }

                    for (let col = 0; col < hot.countCols(); col++) {
                        const cell = hot.getCell(coords.row, col);
                        if (cell) {
                            cell.classList.add('htRowHighlighted');
                        }
                    }
                    hot.selectRows(coords.row);
                }
            }

            hot.addHook('afterSelectionEnd', highlightRow);
            hot.addHook('afterOnCellMouseDown', handleRowHeaderClick);
        }

        document.addEventListener('DOMContentLoaded', () => {
            const searchBar = document.getElementById('searchBar');
            const clearSearch = document.getElementById('clearSearch');
            const searchSuggestions = document.getElementById('searchSuggestions');
            let searchTimer;
            let currentHighlightedCell = null;
            let selectedSuggestionIndex = -1;
            let suggestionItems = [];

            function removeHighlight() {
                if (currentHighlightedCell) {
                    currentHighlightedCell.classList.remove('temp-highlight');
                    currentHighlightedCell = null;
                }
            }

            function clearSelection() {
                suggestionItems.forEach(item => item.classList.remove('selected'));
                selectedSuggestionIndex = -1;
            }

            searchBar.addEventListener('input', (e) => {
                const query = e.target.value.trim().toLowerCase();
                if (!query) {
                    clearSearch.style.display = 'none';
                    searchSuggestions.style.display = 'none';
                    removeHighlight();
                    clearSelection();
                    return;
                }
                clearSearch.style.display = 'block';
                searchSuggestions.style.display = 'block';
                searchSuggestions.innerHTML = '<div class="p-2 text-center"><div class="spinner-border spinner-border-sm text-dark" role="status"></div> Searching...</div>';
                clearTimeout(searchTimer);
                searchTimer = setTimeout(() => performSearch(query), 300);
            });

            searchBar.addEventListener('focus', () => {
                const query = searchBar.value.trim().toLowerCase();
                if (query) {
                    performSearch(query);
                    searchSuggestions.style.display = 'block';
                }
            });

            searchBar.addEventListener('keydown', (e) => {
                if (searchSuggestions.style.display === 'none' || suggestionItems.length === 0) return;
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    selectedSuggestionIndex = (selectedSuggestionIndex + 1) % suggestionItems.length;
                    updateSelection();
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    selectedSuggestionIndex = (selectedSuggestionIndex - 1 + suggestionItems.length) % suggestionItems.length;
                    updateSelection();
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    if (selectedSuggestionIndex >= 0 && suggestionItems[selectedSuggestionIndex]) {
                        suggestionItems[selectedSuggestionIndex].click();
                        searchBar.blur();
                    }
                } else if (e.key === 'Escape') {
                    searchSuggestions.style.display = 'none';
                    clearSelection();
                }
            });

            function updateSelection() {
                suggestionItems.forEach((item, index) => {
                    if (index === selectedSuggestionIndex) {
                        item.classList.add('selected');
                        item.scrollIntoView({ block: 'nearest' });
                    } else {
                        item.classList.remove('selected');
                    }
                });
            }

            clearSearch.addEventListener('click', () => {
                searchBar.value = '';
                clearSearch.style.display = 'none';
                searchSuggestions.style.display = 'none';
                removeHighlight();
                clearSelection();
                searchBar.blur();
            });

            document.addEventListener('click', (e) => {
                if (!searchBar.contains(e.target) && !searchSuggestions.contains(e.target)) {
                    searchSuggestions.style.display = 'none';
                    clearSelection();
                }
            });

            function performSearch(query) {
                const boysHot = document.getElementById('boysHot').__hotInstance;
                const girlsHot = document.getElementById('girlsHot').__hotInstance;
                const matches = [];
                [{ hot: boysHot, gender: 'M', table: 'boys' }, { hot: girlsHot, gender: 'F', table: 'girls' }].forEach(group => {
                    group.hot.getData().forEach((row, rowIndex) => {
                        const name = row[0].trim();
                        const nameLower = name.toLowerCase();
                        const lrn = row[3].toString().trim();
                        if (name || lrn) {
                            if (nameLower.includes(query)) {
                                matches.push({
                                    text: name,
                                    lower: nameLower,
                                    isName: true,
                                    col: 0,
                                    rowIndex,
                                    gender: group.gender,
                                    table: group.table
                                });
                            }
                            if (lrn.includes(query)) {
                                matches.push({
                                    text: lrn,
                                    lower: lrn.toLowerCase(),
                                    isName: false,
                                    col: 3,
                                    rowIndex,
                                    gender: group.gender,
                                    table: group.table
                                });
                            }
                        }
                    });
                });
                matches.sort((a, b) => a.text.localeCompare(b.text));
                if (!matches.length) {
                    searchSuggestions.innerHTML = `<div class="p-2 text-muted">No results found for "${searchBar.value}"</div>`;
                    suggestionItems = [];
                    clearSelection();
                    return;
                }
                searchSuggestions.innerHTML = '';
                suggestionItems = [];
                selectedSuggestionIndex = -1;
                matches.forEach(match => {
                    const div = document.createElement('div');
                    div.className = 'suggestion-item p-2 border-bottom';
                    div.style.cursor = 'pointer';
                    div.dataset.table = match.table;
                    div.dataset.row = match.rowIndex;
                    div.dataset.col = match.col;
                    const escaped = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                    const regex = new RegExp(escaped, 'gi');
                    const highlighted = match.text.replace(regex, '<strong>$&</strong>');
                    const genderClass = match.gender === 'M' ? 'bg-primary text-white' : 'bg-pink text-dark';
                    div.innerHTML = `
                <span style="flex-grow: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${highlighted}</span>
                <span class="badge ${genderClass}">${match.gender}</span>
            `;
                    div.addEventListener('mouseover', () => {
                        clearSelection();
                        div.classList.add('selected');
                        selectedSuggestionIndex = suggestionItems.length;
                    });
                    div.addEventListener('mouseout', () => {
                        if (selectedSuggestionIndex !== suggestionItems.length) {
                            div.classList.remove('selected');
                        }
                    });
                    div.addEventListener('click', handleSuggestionClick);
                    searchSuggestions.appendChild(div);
                    suggestionItems.push(div);
                });
            }

            function handleSuggestionClick(e) {
                const item = e.currentTarget;
                const table = item.dataset.table;
                const row = parseInt(item.dataset.row);
                const col = parseInt(item.dataset.col);
                searchSuggestions.style.display = 'none';
                clearSelection();
                removeHighlight();
                const hotContainer = document.getElementById(table + 'Hot');
                hotContainer.scrollIntoView({ behavior: 'smooth' });
                const hot = hotContainer.__hotInstance;
                hot.scrollViewportTo(row, col);
                hot.render();
                setTimeout(() => {
                    const td = hot.getCell(row, col);
                    if (td) {
                        td.classList.add('temp-highlight');
                        currentHighlightedCell = td;
                        const cellRect = td.getBoundingClientRect();
                        const offset = cellRect.top + window.scrollY - (window.innerHeight / 2) + (cellRect.height / 2);
                        window.scrollTo({ top: offset, behavior: 'smooth' });
                    }
                }, 300);
            }
        });

        document.addEventListener("DOMContentLoaded", async () => {
            if (!localStorage.getItem(STORAGE_KEY)) {
                localStorage.setItem(STORAGE_KEY, JSON.stringify({
                    information: { track: "", strand: "", "school-year": "", adviser: "", principal: "", section: "", grade: "" },
                    subject: { sem1: { core: [], applied: [] }, sem2: { core: [], applied: [] } },
                    students: { boys: {}, girls: {} },
                    chathistory: {}
                }));
            }

            let cardGen = getCardGen();
            const metadataContainer = document.getElementById("metadataHot");
            if (!metadataContainer) return console.error("metadataHot container not found!");

            const labels = ["Track:", "Strand:", "School Year:", "Adviser:", "Principal:", "Section:", "Grade:"];
            const keys = ["track", "strand", "school-year", "adviser", "principal", "section", "grade"];
            const metadataData = labels.map((label, i) => [label, cardGen.information[keys[i]] || ""]);

            const metadataHot = new Handsontable(metadataContainer, {
                data: metadataData,
                colHeaders: ["Label", "Input"],
                rowHeaders: true,
                colWidths: [150, 400],
                stretchH: "all",
                licenseKey: "non-commercial-and-evaluation",
                trimDropdown: false,
                cells: function (row, col) {
                    if (col === 0) return { readOnly: true };
                    const cellProperties = {};
                    if (row === 3) {
                        cellProperties.type = 'text';
                        cellProperties.validator = function (value, callback) {
                            if (!value || value.trim() === "") return callback(true);
                            callback(value.trim().length <= 40);
                        };
                        return cellProperties;
                    }
                    if (row === 4) {
                        cellProperties.type = 'text';
                        cellProperties.validator = function (value, callback) {
                            if (!value || value.trim() === "") return callback(true);
                            callback(value.trim().length <= 35);
                        };
                        return cellProperties;
                    }
                    if (row === 0) {
                        cellProperties.type = 'autocomplete';
                        cellProperties.source = [
                            'ACADEMIC TRACK -',
                            'TECHNICAL-VOCATIONAL-LIVELIHOOD TRACK -',
                            'ARTS AND DESIGN TRACK -',
                            'SPORTS TRACK -'
                        ];
                        cellProperties.strict = false;
                        cellProperties.allowInvalid = true;
                        return cellProperties;
                    }
                    if (row === 1) {
                        cellProperties.type = 'autocomplete';
                        cellProperties.source = function (query, process) {
                            const trackValue = metadataHot.getDataAtCell(0, 1) || "";
                            const firstPart = trackValue.trim().toUpperCase();
                            let options = [];
                            if (firstPart === "") {
                                options = [
                                    'ACCOUNTANCY, BUSINESS AND MANAGEMENT',
                                    'SCIENCE, TECHNOLOGY, ENGINEERING AND MATHEMATICS',
                                    'HUMANITIES AND SOCIAL SCIENCES',
                                    'GENERAL ACADEMIC STRAND',
                                    'AGRI-FISHERY ARTS',
                                    'HOME ECONOMICS',
                                    'INFORMATION AND COMMUNICATIONS TECHNOLOGY',
                                    'INDUSTRIAL ARTS',
                                    'ARTS AND DESIGN',
                                    'SPORTS'
                                ];
                            } else if (firstPart.startsWith('A') && !['AR', 'AD', 'A&D'].some(p => firstPart.startsWith(p))) {
                                options = [
                                    'ACCOUNTANCY, BUSINESS AND MANAGEMENT',
                                    'SCIENCE, TECHNOLOGY, ENGINEERING AND MATHEMATICS',
                                    'HUMANITIES AND SOCIAL SCIENCES',
                                    'GENERAL ACADEMIC STRAND'
                                ];
                            } else if (['AR', 'AD', 'A&D'].some(p => firstPart.startsWith(p))) {
                                options = ['ARTS AND DESIGN'];
                            } else if (firstPart.startsWith('T')) {
                                options = [
                                    'AGRI-FISHERY ARTS',
                                    'HOME ECONOMICS',
                                    'INFORMATION AND COMMUNICATIONS TECHNOLOGY',
                                    'INDUSTRIAL ARTS'
                                ];
                            } else if (firstPart.startsWith('S')) {
                                options = ['SPORTS'];
                            } else {
                                options = [
                                    'ACCOUNTANCY, BUSINESS AND MANAGEMENT',
                                    'SCIENCE, TECHNOLOGY, ENGINEERING AND MATHEMATICS',
                                    'HUMANITIES AND SOCIAL SCIENCES',
                                    'GENERAL ACADEMIC STRAND',
                                    'AGRI-FISHERY ARTS',
                                    'HOME ECONOMICS',
                                    'INFORMATION AND COMMUNICATIONS TECHNOLOGY',
                                    'INDUSTRIAL ARTS',
                                    'ARTS AND DESIGN',
                                    'SPORTS'
                                ];
                            }
                            process(options);
                        };
                        cellProperties.strict = false;
                        cellProperties.allowInvalid = true;
                        return cellProperties;
                    }
                    if (row === 2) {
                        cellProperties.type = 'text';
                        cellProperties.validator = function (value, callback) {
                            if (!value || value === "") return callback(true);
                            callback(/^\d{4}-\d{4}$/.test(value.trim()));
                        };
                        cellProperties.allowInvalid = true;
                        return cellProperties;
                    }
                    if (row === 6) {
                        cellProperties.type = 'text';
                        cellProperties.validator = function (value, callback) {
                            if (!value || value === "") return callback(true);
                            callback(/^(11|12)$/.test(value.toString()));
                        };
                        cellProperties.allowInvalid = true;
                        return cellProperties;
                    }
                    cellProperties.type = 'text';
                    return cellProperties;
                },
                beforeChange: function (changes, source) {
                    if (!changes || source === 'loadData') return;
                    changes.forEach(change => {
                        const row = change[0];
                        const col = change[1];
                        let newValue = change[3];
                        if (col === 1 && newValue !== null && typeof newValue === 'string') {
                            if (row !== 3 && row !== 4) {
                                change[3] = newValue.toUpperCase();
                            }
                        }
                    });
                },
                afterChange: function (changes, source) {
                    if (!changes || source === 'loadData') return;
                    let data = getCardGen();
                    metadataHot.getData().forEach((rowData, index) => {
                        data.information[keys[index]] = rowData[1] || "";
                    });
                    saveGen(data);
                    if (source === 'autofill' || source === 'paste') return;
                    changes.forEach(([row, prop, oldVal, newVal]) => {
                        if (prop !== 1) return;
                        if (!newVal || newVal.trim() === "") return;
                        let message = "";
                        if (row === 3 && newVal.trim().length > 40) {
                            message = "Adviser name too long.";
                        } else if (row === 4 && newVal.trim().length > 35) {
                            message = "Principal name too long.";
                        } else if (row === 2 && !/^\d{4}-\d{4}$/.test(newVal.trim())) {
                            message = "Invalid School Year format.";
                        } else if (row === 6 && !/^(11|12)$/.test(newVal.toString())) {
                            message = "Grade must be 11 or 12.";
                        }
                        if (message) showToast(message, "warning");
                    });
                },
                afterInit: function () {
                    setTimeout(() => this.validateCells(() => this.render()), 100);
                },
                afterValidate: function (isValid, value, row, col) {
                    const cell = this.getCell(row, col);
                    if (cell) {
                        if (!isValid && value !== '' && value !== null && value !== undefined) {
                            let message = "";
                            if (row === 2) message = "Invalid School Year format.";
                            if (row === 3) message = "Adviser name too long.";
                            if (row === 4) message = "Principal name too long.";
                            if (row === 6) message = "Grade must be 11 or 12.";
                            cell.title = message;
                        } else {
                            cell.title = "";
                        }
                    }
                }
            });

            function createStudentTable(containerId, genderKey) {
                const container = document.getElementById(containerId);
                if (!container) return console.error(`${containerId} not found!`);

                const expectedGender = genderKey === "boys" ? "MALE" : "FEMALE";


                let rows = Object.values(cardGen.students[genderKey] || {}).map(s => [
                    s.name || "",
                    s.age || "",
                    expectedGender,
                    s.lrn || "",
                    s.parent || "",
                    s.parentNumber || "",
                    s.parentGmail || ""
                ]);

                while (rows.length < 50) {
                    rows.push(["", "", expectedGender, "", "", "", ""]);
                }

                const hot = new Handsontable(container, {
                    data: rows,
                    colHeaders: ["Name", "Age", "Gender", "LRN", "Parent", "Parent Number", "Parent Gmail"],
                    rowHeaders: true,
                    stretchH: "all",
                    contextMenu: false,
                    manualRowResize: true,
                    manualColumnResize: true,
                    hiddenColumns: { columns: [2], indicators: false },
                    columns: [
                        { type: 'text' },
                        {
                            type: 'text',
                            validator: (v, cb) => (!v || /^\d{2}$/.test(v)) ? cb(true) : cb(false),
                            allowInvalid: true
                        },
                        { type: 'text', readOnly: true, className: "htCenter" },
                        {
                            type: 'text',
                            validator: (v, cb) => (!v || /^\d{12}$/.test(v)) ? cb(true) : cb(false),
                            allowInvalid: true
                        },
                        { type: 'text' },
                        {
                            type: 'text',
                            validator: (v, cb) => (!v || /^09\d{9}$/.test(v.replace(/\D/g, ''))) ? cb(true) : cb(false),
                            allowInvalid: true
                        },
                        {
                            type: 'text',
                            validator: (v, cb) => (!v || /^[a-zA-Z0-9._%+-]+@gmail\.com$/i.test(v.trim())) ? cb(true) : cb(false),
                            allowInvalid: true
                        }
                    ],
                    afterValidate: function (isValid, value, row, col, prop) {
                        const cell = this.getCell(row, col);
                        if (!cell) return;


                        cell.style.backgroundColor = '';
                        cell.style.border = '';
                        cell.title = '';

                        if (!isValid && value !== '' && value != null) {

                            cell.style.backgroundColor = '#ffe6e6';
                            cell.style.border = '1px solid #ff4d4d';

                            let message = '';
                            switch (col) {
                                case 0: message = "Name is required or duplicate detected"; break;
                                case 1: message = "Age must be a 2-digit number (e.g. 17)"; break;
                                case 3: message = "LRN must be exactly 12 digits"; break;
                                case 5: message = "Parent number must start with 09 and have 11 digits"; break;
                                case 6: message = "Invalid Gmail format (must end with @gmail.com)"; break;
                            }
                            cell.title = message;
                        }
                    },
                    afterInit: function () {
                        setTimeout(() => {
                            this.validateCells(() => {
                                this.render();
                            });
                        }, 150);
                    },
                    licenseKey: "non-commercial-and-evaluation",

                    afterChange: function (changes, source) {
                        if (!changes || source === 'loadData' || source.startsWith('internal.')) return;

                        let storage = getCardGen();
                        let students = storage.students[genderKey] || {};
                        let needsFullReload = false;

                        changes.forEach(([row, prop, oldValue, newValueRaw]) => {
                            const col = this.propToCol(prop);
                            const currentNameInCell = this.getDataAtCell(row, 0)?.trim().toUpperCase() || "";
                            const oldNameKey = (oldValue || "").trim().toUpperCase();


                            if (col === 0 && !currentNameInCell) {

                                if (oldNameKey && students[oldNameKey]) {
                                    delete students[oldNameKey];
                                    needsFullReload = true;
                                }
                                return;
                            }


                            if (col !== 0 && !currentNameInCell) return;


                            let studentKey = currentNameInCell;


                            if (col === 0 && oldNameKey && oldNameKey !== currentNameInCell) {
                                if (students[currentNameInCell]) {
                                    showToast(`"${currentNameInCell}" already exists!`, "warning");
                                    this.setDataAtCell(row, 0, oldValue, 'internal.revert');
                                    return;
                                }


                                if (students[oldNameKey]) {
                                    students[currentNameInCell] = { ...students[oldNameKey], name: currentNameInCell };
                                    delete students[oldNameKey];
                                    needsFullReload = true;
                                    studentKey = currentNameInCell;
                                }
                            }


                            if (col === 0 && !oldNameKey) {
                                let finalName = currentNameInCell;


                                if (students[finalName]) {

                                    this.setDataAtCell(row, 0, "", "internal.revert");
                                    showToast(`Name "${finalName}" already exists in this section!`, "warning");
                                    return;
                                }


                                studentKey = finalName;
                                students[studentKey] = students[studentKey] || {
                                    name: finalName,
                                    age: "",
                                    gender: expectedGender,
                                    lrn: "",
                                    parent: "",
                                    parentNumber: "",
                                    parentGmail: ""
                                };
                                needsFullReload = true;
                            }


                            if (!studentKey) return;

                            switch (col) {
                                case 0:
                                    students[studentKey].name = studentKey;
                                    break;
                                case 1:
                                    students[studentKey].age = (newValueRaw || "").trim();
                                    break;
                                case 3:
                                    students[studentKey].lrn = (newValueRaw || "").trim();
                                    break;
                                case 4:
                                    students[studentKey].parent = (newValueRaw || "").trim();
                                    break;
                                case 5:
                                    students[studentKey].parentNumber = (newValueRaw || "").trim();
                                    break;
                                case 6:
                                    students[studentKey].parentGmail = (newValueRaw || "").trim();
                                    break;
                            }
                        });


                        if (needsFullReload || Object.keys(students).length > 0) {
                            storage.students[genderKey] = students;
                            saveGen(storage);

                            if (needsFullReload) {
                                setTimeout(() => {
                                    reloadStudentTables();
                                    this.render();
                                }, 80);
                            }
                        }
                    },
                });

                container.__hotInstance = hot;


                hot.addHook('beforeChange', (changes, source) => {
                    if (source === 'loadData') return;
                    changes.forEach(change => {
                        if (change[1] === 0 && typeof change[3] === 'string') {
                            change[3] = change[3].toUpperCase();
                        }
                    });
                });
            }

            createStudentTable("boysHot", "boys");
            createStudentTable("girlsHot", "girls");

            // FIXED: Initialize row click trackers after tables are created
            setTimeout(() => {
                const boysHotInstance = document.getElementById('boysHot')?.__hotInstance;
                const girlsHotInstance = document.getElementById('girlsHot')?.__hotInstance;

                if (boysHotInstance) attachRowClickTracker(boysHotInstance);
                if (girlsHotInstance) attachRowClickTracker(girlsHotInstance);

                console.log('Row click trackers attached successfully');
            }, 500);

            // Add toggle event listener to reapply/remove highlights
            document.getElementById('rowTrackerToggle').addEventListener('change', function (e) {
                const boysHot = document.getElementById('boysHot')?.__hotInstance;
                const girlsHot = document.getElementById('girlsHot')?.__hotInstance;

                if (!this.checked) {
                    [boysHot, girlsHot].forEach(hot => {
                        if (hot) {
                            const tbody = hot.getCell(0, 0)?.closest('tbody');
                            if (tbody) {
                                tbody.querySelectorAll('.htRowHighlighted').forEach(cell => {
                                    cell.classList.remove('htRowHighlighted');
                                });
                            }
                        }
                    });
                }
            });

            window.exportData = function () {
                const data = getCardGen();

                const hasMetadata = Object.values(data.information || {}).some(val =>
                    val && val.toString().trim() !== ""
                );

                const hasBoys = Object.values(data.students.boys || {}).some(student =>
                    student.name && student.name.trim() !== ""
                );
                const hasGirls = Object.values(data.students.girls || {}).some(student =>
                    student.name && student.name.trim() !== ""
                );
                const isCompletelyEmpty = !hasMetadata && !hasBoys && !hasGirls;
                if (isCompletelyEmpty) {

                    showToast("No data found. Downloading template file instead...", "info");

                    const templatePath = "CardGen_Template.xlsx";

                    const link = document.createElement('a');
                    link.href = templatePath;
                    link.download = "CardGen_Template.xlsx";
                    link.style.display = 'none';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    return;
                }

                showToast("Exporting your current data...", "info");
                const rows = [];
                rows.push(["Main Information", ""]);
                rows.push(["Track:", data.information.track || ""]);
                rows.push(["Strand:", data.information.strand || ""]);
                rows.push(["School Year:", data.information["school-year"] || ""]);
                rows.push(["Adviser:", data.information.adviser || ""]);
                rows.push(["Principal:", data.information.principal || ""]);
                rows.push(["Section:", data.information.section || ""]);
                rows.push(["Grade:", data.information.grade || ""]);
                rows.push([""]);
                rows.push(["Name", "Age", "Gender", "LRN", "Parent", "Parent Number", "Parent Gmail"]);
                rows.push(["MALES", "", "", "", "", "", ""]);
                let boys = Object.values(data.students.boys || {}).map(s => [
                    s.name || "", s.age || "", "MALE", s.lrn || "", s.parent || "", s.parentNumber || "", s.parentGmail || ""
                ]);
                while (boys.length < 50) boys.push(["", "", "MALE", "", "", "", ""]);
                rows.push(...boys);
                rows.push(["FEMALES", "", "", "", "", "", ""]);
                let girls = Object.values(data.students.girls || {}).map(s => [
                    s.name || "", s.age || "", "FEMALE", s.lrn || "", s.parent || "", s.parentNumber || "", s.parentGmail || ""
                ]);
                while (girls.length < 50) girls.push(["", "", "FEMALE", "", "", "", ""]);
                rows.push(...girls);
                const ws = XLSX.utils.aoa_to_sheet(rows);

                ws["!merges"] = [
                    { s: { r: 0, c: 0 }, e: { r: 0, c: 1 } },
                    { s: { r: 10, c: 0 }, e: { r: 10, c: 6 } },
                    { s: { r: 61, c: 0 }, e: { r: 61, c: 6 } }
                ];
                const boldCenter = { font: { bold: true }, alignment: { horizontal: "center", vertical: "center" } };
                ["A1", "A11", "A62"].forEach(a => { if (ws[a]) ws[a].s = boldCenter; });
                for (let c = 0; c < 7; c++) {
                    const addr = XLSX.utils.encode_cell({ r: 9, c });
                    if (ws[addr]) ws[addr].s = boldCenter;
                }
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Main Data");
                XLSX.writeFile(wb, "CardGen2025.xlsx");
                showToast("Data exported successfully!", "success");
            };
            window.importData = function (e) {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = function (ev) {
                    try {
                        const data = new Uint8Array(ev.target.result);
                        const wb = XLSX.read(data, { type: 'array' });
                        const sheetName = wb.SheetNames.find(name => name.trim() === "Main Data");
                        if (!sheetName) {
                            throw new Error("Walang sheet na 'Main Data' sa file! Siguraduhing tama ang sheet name.");
                        }

                        const sheet = wb.Sheets[sheetName];
                        const range = XLSX.utils.decode_range(sheet['!ref']);

                        let d = getCardGen();


                        d.students.boys = {};
                        d.students.girls = {};


                        for (let R = range.s.r; R <= range.e.r; ++R) {
                            const rowNum = R + 1;
                            if (rowNum >= 2 && rowNum <= 8) {
                                const labelCell = sheet[XLSX.utils.encode_cell({ r: rowNum - 1, c: 0 })];
                                const valueCell = sheet[XLSX.utils.encode_cell({ r: rowNum - 1, c: 1 })];
                                if (labelCell && valueCell) {
                                    const label = (labelCell.v || "").toString().trim();
                                    const val = (valueCell.v || "").toString().trim();
                                    const map = {
                                        "Track:": "track", "Strand:": "strand",
                                        "School Year:": "school-year", "Adviser:": "adviser",
                                        "Principal:": "principal", "Section:": "section", "Grade:": "grade"
                                    };
                                    if (map[label]) {
                                        d.information[map[label]] = val;
                                    }
                                }
                            }
                        }


                        const normalize = (name) => (name || "").toString().trim().toUpperCase();


                        for (let r = 11; r <= 60; r++) {
                            const nameCell = sheet[XLSX.utils.encode_cell({ r, c: 0 })];
                            if (!nameCell || !nameCell.v) continue;

                            let rawName = nameCell.v.toString().trim();
                            if (!rawName) continue;

                            const nameUpper = normalize(rawName);


                            if (d.students.boys[nameUpper]) {
                                console.warn(`Duplicate name in import (boys): ${nameUpper} - keeping first occurrence`);
                                continue;
                            }

                            d.students.boys[nameUpper] = {
                                name: nameUpper,
                                age: sheet[XLSX.utils.encode_cell({ r, c: 1 })]?.v?.toString().trim() || "",
                                gender: "MALE",
                                lrn: sheet[XLSX.utils.encode_cell({ r, c: 3 })]?.v?.toString().trim() || "",
                                parent: sheet[XLSX.utils.encode_cell({ r, c: 4 })]?.v?.toString().trim() || "",
                                parentNumber: sheet[XLSX.utils.encode_cell({ r, c: 5 })]?.v?.toString().trim() || "",
                                parentGmail: sheet[XLSX.utils.encode_cell({ r, c: 6 })]?.v?.toString().trim() || ""
                            };
                        }


                        for (let r = 62; r <= 111; r++) {
                            const nameCell = sheet[XLSX.utils.encode_cell({ r, c: 0 })];
                            if (!nameCell || !nameCell.v) continue;

                            let rawName = nameCell.v.toString().trim();
                            if (!rawName) continue;

                            const nameUpper = normalize(rawName);

                            if (d.students.girls[nameUpper]) {
                                console.warn(`Duplicate name in import (girls): ${nameUpper} - keeping first occurrence`);
                                continue;
                            }

                            d.students.girls[nameUpper] = {
                                name: nameUpper,
                                age: sheet[XLSX.utils.encode_cell({ r, c: 1 })]?.v?.toString().trim() || "",
                                gender: "FEMALE",
                                lrn: sheet[XLSX.utils.encode_cell({ r, c: 3 })]?.v?.toString().trim() || "",
                                parent: sheet[XLSX.utils.encode_cell({ r, c: 4 })]?.v?.toString().trim() || "",
                                parentNumber: sheet[XLSX.utils.encode_cell({ r, c: 5 })]?.v?.toString().trim() || "",
                                parentGmail: sheet[XLSX.utils.encode_cell({ r, c: 6 })]?.v?.toString().trim() || ""
                            };
                        }

                        saveGen(d);


                        labels.forEach((l, i) => {
                            metadataHot.setDataAtCell(i, 1, d.information[keys[i]] || "");
                        });
                        reloadStudentTables();

                        showToast("Import complete! Existing students replaced with the imported list.", "success");

                    } catch (err) {
                        console.error("Import error:", err);
                        alert("Error sa import: " + err.message);
                        showToast("Import failed. Check console for details.", "danger");
                    }
                };
                reader.readAsArrayBuffer(file);
            };
            window.confirmImport = function () {
                askConfirm(
                    "Confirm Import Data",
                    "Are you sure you want to import new data? This will overwrite the current Males and Females student data. This cannot be undone.",
                    function () {
                        document.getElementById('importFile').click();
                        showToast("Select your Excel file to import.", "info");
                    }
                );
            };
            window.showClearConfirmation = function () {
                askConfirm(
                    "Confirm Clear Data",
                    "Are you sure you want to clear Males and Females data? This cannot be undone.",
                    confirmClearData
                );
            };
            window.confirmClearData = function () {
                let d = getCardGen();
                d.students = { boys: {}, girls: {} };
                saveGen(d);

                const boysHot = document.getElementById('boysHot').__hotInstance;
                const girlsHot = document.getElementById('girlsHot').__hotInstance;

                const maleRows = Array(50).fill().map(() => ["", "", "MALE", "", "", "", ""]);
                const femaleRows = Array(50).fill().map(() => ["", "", "FEMALE", "", "", "", ""]);

                boysHot.loadData(maleRows);
                girlsHot.loadData(femaleRows);

                showToast("Student data (Males & Females) cleared!", "success");
            };
        });
        function sortStudentsAlphabetically() {
            askConfirm(
                "Sort Students Alphabetically",
                "This will sort both Males and Females by name alphabetically and save the new order. Continue?",
                function () {
                    let data = getCardGen();

                    const boysList = Object.values(data.students.boys)
                        .filter(s => s.name && s.name.trim() !== "")
                        .sort((a, b) => a.name.localeCompare(b.name));
                    data.students.boys = {};
                    boysList.forEach((student) => {
                        data.students.boys[student.name] = student;
                    });

                    const girlsList = Object.values(data.students.girls)
                        .filter(s => s.name && s.name.trim() !== "")
                        .sort((a, b) => a.name.localeCompare(b.name));
                    data.students.girls = {};
                    girlsList.forEach((student) => {
                        data.students.girls[student.name] = student;
                    });
                    saveGen(data);
                    reloadStudentTables();

                    document.getElementById('boysHot').__hotInstance?.validateCells(() => document.getElementById('boysHot').__hotInstance?.render());
                    document.getElementById('girlsHot').__hotInstance?.validateCells(() => document.getElementById('girlsHot').__hotInstance?.render());
                    showToast("Students sorted alphabetically!", "success");
                }
            );
        }
        function askConfirm(title, message, onConfirm) {
            document.getElementById('confirmModalTitle').textContent = title;
            document.getElementById('confirmModalBody').textContent = message;
            const confirmBtn = document.getElementById('confirmModalConfirmBtn');
            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
            newConfirmBtn.addEventListener('click', function () {
                if (onConfirm) onConfirm();
                const modalElement = document.getElementById('confirmModal');
                const modalInstance = bootstrap.Modal.getInstance(modalElement);
                if (modalInstance) {
                    modalInstance.hide();
                    modalElement.addEventListener('hidden.bs.modal', function cleanup() {
                        forceHideModalBackdrop();
                        modalElement.removeEventListener('hidden.bs.modal', cleanup);
                    }, { once: true });
                }
            });
            const modalElement = document.getElementById('confirmModal');
            const modal = new bootstrap.Modal(modalElement, {
                keyboard: true,
                backdrop: 'static'
            });
            modal.show();
            modalElement.addEventListener('shown.bs.modal', function () {
                newConfirmBtn.focus();
            }, { once: true });
        }
        document.getElementById('confirmModal').addEventListener('shown.bs.modal', function () {
            const confirmBtn = document.getElementById('confirmModalConfirmBtn');
            const cancelBtn = document.querySelector('#confirmModal .btn-secondary[data-bs-dismiss="modal"]');
            confirmBtn.focus();
            const handleArrowKeys = (e) => {
                if (e.key === 'ArrowLeft' || e.key === 'ArrowRight') {
                    e.preventDefault();
                    if (document.activeElement === confirmBtn) {
                        cancelBtn.focus();
                    } else {
                        confirmBtn.focus();
                    }
                }
            };
            this.addEventListener('keydown', handleArrowKeys);
            this.addEventListener('hidden.bs.modal', function cleanup() {
                this.removeEventListener('keydown', handleArrowKeys);
                this.removeEventListener('hidden.bs.modal', cleanup);
            });
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/handsontable@14.4.0/dist/handsontable.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="../Assets/JS/SideBar-NavBar.js"></script>
    <script src="../Assets/JS/Logout.js"></script>
    <script src="../Assets/JS/Toast.js"></script>
</body>

</html>