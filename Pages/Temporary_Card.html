<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Temporary Card</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="../assets/css/Toast.css">
    <link rel="stylesheet" href="../assets/css/root.css">
    <link rel="stylesheet" href="../CSS/admin-style.css">

    <style>
        @media (min-width: 992px) {
            #toggleBtn {
                display: none;
            }
        }

        .container {
            padding: 0 15px;
            overflow: hidden;
        }

        #cardContainer {
            display: inline-block;
            vertical-align: top;
        }

        #printableCard {
            position: relative;
            width: 215.9mm;
            height: 279.4mm;
            overflow: hidden;
        }

        .front-card {
            width: 100%;
            height: 100%;
        }




        .overlay-container {
            position: absolute;
            inset: 0;
            pointer-events: none;
        }

        tbody,
        td,
        tfoot,
        th,
        thead,
        tr {
            padding: 5px 5px !important;
        }

        .subject-col {
            width: 57%;
        }

        .grade-col {
            width: 14.3%;
            text-align: center;
            padding: 8px 0px
        }

        .sem1-block {
            position: absolute;
            top: 260px;

            left: 25px;

            width: 370px;

        }

        .sem2-block {
            position: absolute;
            top: 260px;

            left: 420px;
            width: 370px;
        }

        @media print {
            @page {
                size: letter portrait;
                margin: 0 !important;
            }

            html,
            body {
                margin: 0 !important;
                padding: 0 !important;
                width: 100% !important;
                height: 100% !important;
                background: white !important;

                transform: none !important;

                zoom: 100% !important;

            }


            body * {
                visibility: hidden;
            }

            #printableCard,
            #printableCard * {
                visibility: visible !important;
            }

            #printableCard {
                position: absolute !important;
                transform: none !important;
                top: 0 !important;
                left: 0 !important;
                width: 215.9mm !important;
                height: 279.4mm !important;
                margin: 0 !important;
                padding: 0 !important;
                overflow: hidden !important;

                page-break-after: avoid;
                break-inside: avoid-page;
                box-sizing: border-box;
            }

            .front-card {
                display: block !important;
                width: 100% !important;
                height: 100% !important;
                -webkit-print-color-adjust: exact !important;

                print-color-adjust: exact !important;

            }

            .overlay-container,
            .overlay-container * {
                visibility: visible !important;
            }


            .grades-table,
            .grades-table * {
                page-break-inside: avoid !important;
                break-inside: avoid !important;
            }


            body,
            html,
            #printableCard,
            table,
            thead,
            tbody,
            tr,
            th,
            td {
                -webkit-print-color-adjust: exact !important;

                print-color-adjust: exact !important;

            }


            [style*="background: #d6d6d6"],
            th[style*="background: #d6d6d6"],
            td[style*="background: #d6d6d6"] {
                background-color: #d6d6d6 !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }


            .gray-bg,
            thead th,
            .section-header td {
                background-color: #d6d6d6 !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
        }

        body.generation-locked {
            overflow: hidden;
        }

        body.generation-locked::before {
            content: "";
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.4);
            z-index: 9998;
            pointer-events: all;
        }

        #progressOverlay,
        #progressOverlay * {
            pointer-events: auto !important;
        }

        #studentSelection {
            border: 1px solid #ced4da;
            border-radius: 0.375rem;
            padding: 0.375rem 0.75rem;
            max-height: 200px;
            overflow-y: auto;
            background-color: white;
        }

        #studentSelection label {
            display: block;
            cursor: pointer;
        }

        .overlay-container #teacherName {
            white-space: nowrap;
            font-size: inherit;
            text-align: center;
            display: inline-block;
        }

        .overlay-container #teacherNameWrapper {
            position: absolute;
            top: 710px;
            left: -23px;
            transform: translateX(-50%);
            width: auto;
            z-index: 5;
        }

        .overlay-container #studentSection {
            top: -44px;
            left: -200px;
            position: absolute;
        }

        .overlay-container #studentName {
            top: -81px;
            left: -285px;
            position: absolute;
        }

        .overlay-container #studentSchoolYear {
            top: -172px;
            left: -78px;
            position: absolute;
        }


        .overlay-container {
            white-space: nowrap;
            text-align: center;
            display: inline-block;
        }

        .overlay-container {
            position: absolute;
            top: 50px;
            left: 250px;
            color: black;
            font-family: 'Times New Roman';
            white-space: nowrap;
            font-size: 1.35rem;
        }

        .overlay-container .teacherSignatureImg {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            display: none;
        }

        .overlay-container .teacherSignatureWrapper {
            position: absolute;
            top: 662px;
            left: -129px;
            width: 210px;
            height: 60px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, #0078e9, #00a8ff) !important;
            border: none !important;
            box-shadow: 0 2px 8px rgba(0, 120, 233, 0.25) !important;
            transition: all 0.2s ease !important;
        }

        .btn-primary:hover {
            transform: translateY(-1px) !important;
            box-shadow: 0 4px 14px rgba(0, 120, 233, 0.35) !important;
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745, #20c997) !important;
            border: none !important;
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545, #c0392b) !important;
            border: none !important;
        }
    </style>

</head>

<body>
    <nav class="navbar navbar-light bg-primary shadow-sm fixed-top" data-bs-theme="dark">
        <div class="container-fluid">
            <div
                class="d-flex flex-column flex-lg-row w-100 align-items-start align-items-lg-center justify-content-lg-between">
                <div class="d-flex align-items-center w-100 w-lg-auto justify-content-start mb-2 mb-lg-0">
                    <button class="btn btn-outline-secondary me-2 d-lg-none" id="toggleBtn">â˜°</button>
                    <span class="navbar-brand mb-0 h1 d-none d-lg-inline" id="Hi">CardGen: From Grade Consolidation to
                        Printable Report Card for Senior High School</span>
                    <span class="navbar-brand mb-0 h1 d-inline d-lg-none" id="Hi">CardGen 2025</span>
                </div>
            </div>
        </div>
    </nav>

    <div class="sidebar collapsed" id="sidebar">
        <ul class="nav flex-column px-3">
            <div id="sidebar-container"></div>
        </ul>
    </div>

    <div class="main-content">
        <div class="container-fluid container">
            <div class="row">
                <div class="col-12">

                    <button class="btn btn-primary align-items-start"
                        onclick="window.location.href='Other Features.html'">Back</button>

                    <h1>Card</h1>
                    <div id="studentSelection"></div>
                    <br>
                    <div class="mb-3 d-flex flex-wrap gap-2 align-items-center">
                        <button id="downloadSingleBtn" class="btn btn-primary">Download Current Page</button>
                        <button id="downloadAllBtn" class="btn btn-success">Download All Cards</button>

                        <button id="printCard" class="btn btn-secondary">ðŸ–¨ Print Page</button>
                    </div>

                    <div id="progressOverlay" class="position-fixed top-0 start-0 w-100 h-100 d-none"
                        style="background: rgba(0,0,0,0.7); z-index: 9999; backdrop-filter: blur(5px);">
                        <div class="d-flex flex-column justify-content-center align-items-center h-100 text-black">
                            <div class="card bg-light text-black shadow-lg p-4" style="max-width: 460px; width: 92%;">
                                <h4 class="text-center mb-4 fw-bold">Generating All Report Cards</h4>

                                <div class="progress mb-4" style="height: 30px; background: rgba(0, 0, 0, 0.15);">
                                    <div id="progressBar"
                                        class="progress-bar progress-bar-striped progress-bar-animated bg-success"
                                        role="progressbar" style="width: 0%">0%</div>
                                </div>

                                <p id="progressStatus" class="text-center mb-4 fs-5 fw-semibold">
                                    Initializing...
                                </p>

                                <button id="btnCancelAll" class="btn btn-outline-danger btn-lg w-100">
                                    CANCEL GENERATION
                                </button>

                                <small class="text-center mt-3 opacity-75">
                                    Please wait â€” do not close or refresh this page
                                </small>
                            </div>
                        </div>
                    </div>
                    <div id="previewWrapper" style="text-align: center;">
                        <div id="cardContainer"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script src="../Assets/JS/loader.js"></script>

    <script>
        loadSidebar("Temporary_Card.html");
    </script>

    <script>

        const DB_NAME = 'CardGenSignatures';
        const DB_VERSION = 1;
        const STORE_NAME = 'signatures';
        let db;

        function openDB() {
            return new Promise((resolve, reject) => {
                const req = indexedDB.open(DB_NAME, DB_VERSION);

                req.onupgradeneeded = e => {
                    db = e.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        db.createObjectStore(STORE_NAME);
                    }
                };

                req.onsuccess = e => {
                    db = e.target.result;
                    resolve(db);
                };

                req.onerror = e => reject(e.target.error);
            });
        }

        async function loadSignatureBlob(key) {
            await openDB();
            return new Promise((resolve, reject) => {
                const tx = db.transaction(STORE_NAME, "readonly");
                const store = tx.objectStore(STORE_NAME);
                const req = store.get(key);

                req.onsuccess = () => resolve(req.result || null);
                req.onerror = e => reject(e.target.error);
            });
        }

        let teacherSignatureDataURL = null;

        function applyTeacherSignature(container) {
            if (!teacherSignatureDataURL) return;

            const imgs = container.querySelectorAll(".teacherSignatureImg");
            imgs.forEach(img => {
                img.src = teacherSignatureDataURL;
                img.style.display = "block";
            });
        }


        document.getElementById("printCard").addEventListener("click", function () {
            window.print();
        });

        document.addEventListener("DOMContentLoaded", async () => {

            await preloadTeacherSignature();


            function setCardText(container, selector, value) {
                const el = container.querySelector(selector);
                if (el) {
                    el.textContent = value || "";
                }
            }

            const STORAGE_KEY = "CardGen";
            const selectionDiv = document.getElementById("studentSelection");
            const cardContainer = document.getElementById("cardContainer");

            let generationInProgress = false;
            let abortController = null;

            const cardGen = JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");


            const allStudents = [];
            Object.values(cardGen.students?.boys || {}).forEach(s => {
                if (s.name?.trim()) allStudents.push({ ...s, gender: "MALE" });
            });
            Object.values(cardGen.students?.girls || {}).forEach(s => {
                if (s.name?.trim()) allStudents.push({ ...s, gender: "FEMALE" });
            });
            allStudents.sort((a, b) => a.name.localeCompare(b.name));


            let template;
            try {
                template = await (await fetch("../assets/html/Back_Card_Template 2.0.html")).text();
            } catch (err) {
                console.error("Failed to load template:", err);
                cardContainer.innerHTML = "<h3 style='color:red'>Error: Back_Card_Template.html not found!</h3>";
                return;
            }


            template = template.replace(/id="(GenAve[12])"/g, 'class="$1"');
            template = template.replace(/id="(core[12]-body|applied[12]-body)"/g, 'class="$1"');
            template = template.replace(/id="(sem[12]-block)"/g, 'class="$1"');
            template = template.replace(/id="front-card"/g, 'class="front-card"');


            cardContainer.innerHTML = '<div id="printableCard" style="position: relative; width: 215.9mm; height: 279.4mm; overflow: hidden;"></div>';
            const printableCard = document.getElementById("printableCard");

            const halfWidth = 107.95;
            const halfHeight = 139.7;

            for (let i = 1; i <= 4; i++) {
                const cardDiv = document.createElement("div");
                cardDiv.id = `card${i}`;
                cardDiv.style.position = "absolute";
                cardDiv.style.width = "215.9mm";
                cardDiv.style.height = "279.4mm";
                cardDiv.style.transform = "scale(0.5)";
                cardDiv.style.transformOrigin = "top left";

                if (i === 1) {
                    cardDiv.style.left = "0mm";
                    cardDiv.style.top = "0mm";
                } else if (i === 2) {
                    cardDiv.style.left = `${halfWidth}mm`;
                    cardDiv.style.top = "0mm";
                } else if (i === 3) {
                    cardDiv.style.left = "0mm";
                    cardDiv.style.top = `${halfHeight}mm`;
                } else if (i === 4) {
                    cardDiv.style.left = `${halfWidth}mm`;
                    cardDiv.style.top = `${halfHeight}mm`;
                }

                cardDiv.innerHTML = template;
                printableCard.appendChild(cardDiv);
            }


            allStudents.forEach(student => {
                const label = document.createElement("label");
                const check = document.createElement("input");
                check.type = "checkbox";
                check.value = student.name;
                check.addEventListener("change", updateSelected);
                label.appendChild(check);
                label.appendChild(document.createTextNode(` ${student.name} (${student.gender === "MALE" ? "M" : "F"})`));
                selectionDiv.appendChild(label);
            });

            function updateSelected(e) {
                const checks = [...document.querySelectorAll("#studentSelection input:checked")];
                if (checks.length > 4) {
                    e.target.checked = false;
                    showToast("Maximum 4 students selectable.", "warning");
                    return;
                }
                const selectedStudents = checks.map(c => allStudents.find(s => s.name === c.value));
                for (let i = 0; i < 4; i++) {
                    const student = selectedStudents[i] || null;
                    updateBackCard(i + 1, student);
                }
                scaleCard();
            }

            function updateBackCard(cardIndex, student) {
                const container = document.getElementById(`card${cardIndex}`);
                if (!container) return;


                container.querySelectorAll(".teacherSignatureImg").forEach(img => {
                    img.style.display = "none";
                    img.src = "";
                });

                setCardText(container, "#studentName", "");
                setCardText(container, "#studentSection", "");
                setCardText(container, "#teacherName", "");
                setCardText(container, "#studentSchoolYear", "");

                ['core1-body', 'applied1-body', 'core2-body', 'applied2-body'].forEach(cls => {
                    const el = container.querySelector(`.${cls}`);
                    if (el) el.innerHTML = '';
                });

                localSetText("GenAve1", "");
                localSetText("GenAve2", "");


                if (!student || !student.name?.trim()) {
                    return;
                }


                applyTeacherSignature(container);


                const cardGen = JSON.parse(localStorage.getItem("CardGen") || "{}");
                const info = cardGen?.information || {};

                setCardText(container, "#studentName", student.name.trim());
                setCardText(container, "#studentSection", info.section || "");
                setCardText(container, "#teacherName", info.adviser || "");
                setCardText(
                    container,
                    "#studentSchoolYear",
                    info["school-year"] ? `S.Y. ${info["school-year"]}` : ""
                );




                ['core1-body', 'applied1-body', 'core2-body', 'applied2-body'].forEach(cls => {
                    const el = container.querySelector(`.${cls}`);
                    if (el) el.innerHTML = '';
                });

                localSetText("GenAve1", "");
                localSetText("GenAve2", "");



                const sem1 = student.grade?.sem1 || {};
                const sem2 = student.grade?.sem2 || {};

                const core1Names = cardGen.subject?.sem1?.core || {};
                const applied1Names = cardGen.subject?.sem1?.applied || {};
                const core2Names = cardGen.subject?.sem2?.core || {};
                const applied2Names = cardGen.subject?.sem2?.applied || {};



                const row = (subject = '', qA = '', qB = '', fin = '') => {

                    const displaySubject = subject
                        .replace(/\\n/g, '<br>')
                        .replace(/\n/g, '<br>');

                    return `
        <tr>
            <td>${displaySubject}</td>
            <td>${qA || ''}</td>
            <td>${qB || ''}</td>
            <td>${fin || ''}</td>
        </tr>
    `;
                };


                let html1Core = '';
                for (let i = 1; i <= 8; i++) {
                    const key = `subject${i}`;
                    const name = core1Names[key] || '';
                    const g = sem1.core?.[key] || {};


                    if (name.trim() === '') {
                        continue;
                    }

                    html1Core += row(name, g["1st"], g["2nd"], g["final"]);
                }

                container.querySelector('.core1-body').innerHTML = html1Core;


                let html1Applied = '';
                for (let i = 1; i <= 8; i++) {
                    const key = `subject${i}`;
                    const name = applied1Names[key] || '';
                    const g = sem1.applied?.[key] || {};

                    if (name.trim() === '') {
                        continue;
                    }


                    html1Applied += row(name, g["1st"], g["2nd"], g["final"]);
                }
                container.querySelector('.applied1-body').innerHTML = html1Applied;

                localSetText("GenAve1", sem1.genAve || sem1.generalAverage || '');



                let html2Core = '';
                for (let i = 1; i <= 8; i++) {
                    const key = `subject${i}`;
                    const name = core2Names[key]?.trim() || '';
                    const g = sem2.core?.[key] || {};

                    if (name.trim() === '') {
                        continue;
                    }


                    const q3 = g["3rd"] || g.q3 || '';
                    const q4 = g["4th"] || g.q4 || '';
                    const fin = g["final"] || g.finalSem || g.final || '';

                    html2Core += row(name, q3, q4, fin);
                }
                container.querySelector('.core2-body').innerHTML = html2Core || '';

                let html2Applied = '';
                for (let i = 1; i <= 8; i++) {
                    const key = `subject${i}`;
                    const name = applied2Names[key]?.trim() || '';
                    const g = sem2.applied?.[key] || {};

                    if (name.trim() === '') {
                        continue;
                    }

                    const q3 = g["3rd"] || g.q3 || '';
                    const q4 = g["4th"] || g.q4 || '';
                    const fin = g["final"] || g.finalSem || g.final || '';

                    html2Applied += row(name, q3, q4, fin);
                }
                container.querySelector('.applied2-body').innerHTML = html2Applied;

                localSetText("GenAve2", sem2.genAve || sem2.generalAverage || '');


                function localSetText(cls, value) {
                    const el = container.querySelector(`.${cls}`);
                    if (el) el.textContent = value || "";
                }
            }

            function scaleCard() {
                const wrapper = document.getElementById("previewWrapper");
                const card = document.getElementById("printableCard");
                if (!wrapper || !card) return;
                const scale = Math.min(wrapper.clientWidth / card.offsetWidth, 1);
                card.style.transform = `scale(${scale})`;
                card.style.transformOrigin = 'top left';
            }

            async function captureCard() {
                const card = document.getElementById("printableCard");
                card.style.transform = "scale(1)";
                await new Promise(r => requestAnimationFrame(r));

                const canvas = await html2canvas(card, {
                    scale: 3,
                    useCORS: true,
                    backgroundColor: "#ffffff",
                    logging: false
                });
                return canvas.toDataURL("image/jpeg", 0.92);
            }

            function updateProgress(percent, message = '') {
                const bar = document.getElementById("progressBar");
                const status = document.getElementById("progressStatus");
                if (!bar || !status) return;

                bar.style.width = `${percent}%`;
                bar.textContent = `${percent}%`;
                status.textContent = message || (percent === 100 ? "Finalizing PDF..." : `Generating... ${percent}%`);
            }


            window.downloadSinglePDF = async () => {
                const checked = document.querySelectorAll('#studentSelection input:checked');
                if (checked.length === 0) return showToast("Please select at least one student first!", "warning");

                await new Promise(r => requestAnimationFrame(r));

                const imgData = await captureCard();

                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({ orientation: "portrait", unit: "mm", format: "letter" });
                pdf.addImage(imgData, "JPEG", 0, 0, 215.9, 279.4);
                pdf.save(`Back_Cards_Selected.pdf`);

                scaleCard();
            };


            window.downloadAllPDFs = async () => {
                if (allStudents.length === 0) return showToast("No students found!", "warning");
                if (generationInProgress) return;

                generationInProgress = true;
                abortController = new AbortController();
                const { signal } = abortController;

                const overlay = document.getElementById("progressOverlay");
                const cancelBtn = document.getElementById("btnCancelAll");

                document.body.classList.add("generation-locked");
                overlay.classList.remove("d-none");

                document.getElementById("progressBar").style.width = "0%";
                document.getElementById("progressBar").textContent = "0%";
                document.getElementById("progressStatus").textContent = "Preparing cards...";
                cancelBtn.disabled = false;
                cancelBtn.textContent = "CANCEL GENERATION";

                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({ orientation: "portrait", unit: "mm", format: "letter" });

                let cancelled = false;
                let processed = 0;

                try {
                    const groups = [];
                    for (let i = 0; i < allStudents.length; i += 4) {
                        groups.push(allStudents.slice(i, i + 4));
                    }

                    for (let g = 0; g < groups.length; g++) {
                        if (signal.aborted) { cancelled = true; break; }

                        const group = groups[g];
                        for (let j = 0; j < 4; j++) {
                            updateBackCard(j + 1, group[j] || null);
                        }

                        await new Promise(r => requestAnimationFrame(r));
                        await new Promise(r => setTimeout(r, 40));

                        const imgData = await captureCard();

                        if (g > 0) pdf.addPage();
                        pdf.addImage(imgData, "JPEG", 0, 0, 215.9, 279.4, undefined, "FAST");

                        processed += group.length;
                        if (processed % 20 === 0 || processed === allStudents.length) {
                            const percent = Math.round((processed / allStudents.length) * 100);
                            updateProgress(percent, `Processed ${processed} of ${allStudents.length} (${percent}%)`);
                        }

                        await new Promise(r => setTimeout(r, 10));
                    }

                    if (!cancelled) {
                        pdf.save(`All_BackCards_${new Date().toISOString().slice(0, 10)}.pdf`);
                        showToast("All back cards generated successfully!", "success");
                    } else {
                        showToast("Generation cancelled", "info");
                    }
                } catch (err) {
                    console.error("Generation error:", err);
                    showToast("Error during generation", "danger");
                } finally {
                    generationInProgress = false;
                    document.body.classList.remove("generation-locked");
                    overlay.classList.add("d-none");


                    updateSelected({ target: { checked: false } });
                    scaleCard();
                }
            };


            document.getElementById("btnCancelAll")?.addEventListener("click", () => {
                if (!generationInProgress || !abortController) return;
                abortController.abort();
                document.getElementById("btnCancelAll").disabled = true;
                document.getElementById("btnCancelAll").textContent = "CANCELLING...";
                document.getElementById("progressStatus").textContent = "Cancelling current operation...";
            });


            window.addEventListener("beforeunload", (e) => {
                if (generationInProgress) {
                    e.preventDefault();
                    return (e.returnValue = "Report card generation is still running. Are you sure you want to leave?");
                }
            });


            document.getElementById("downloadSingleBtn").addEventListener("click", downloadSinglePDF);
            document.getElementById("downloadAllBtn").addEventListener("click", downloadAllPDFs);

            window.addEventListener("resize", scaleCard);


            for (let i = 1; i <= 4; i++) {
                updateBackCard(i, null);
            }
            scaleCard();
        });

        async function preloadTeacherSignature() {
            const blob = await loadSignatureBlob("teacher");
            if (!(blob instanceof Blob)) return;

            return new Promise(resolve => {
                const reader = new FileReader();
                reader.onload = e => {
                    teacherSignatureDataURL = e.target.result;
                    resolve();
                };
                reader.readAsDataURL(blob);
            });
        }

    </script>

    <script src="../Assets/JS/SideBar-NavBar.js"></script>
    <script src="../Assets/JS/Logout.js"></script>
    <script src="../Assets/JS/Toast.js"></script>
</body>

</html>