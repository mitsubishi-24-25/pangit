<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Front Card</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="../Assets/CSS/Toast.css">
    <link rel="stylesheet" href="../Assets/CSS/root.css">
    <link rel="stylesheet" href="../CSS/admin-style.css">

    <style>
        .container {
            padding: 0 15px;
            overflow: hidden;
        }

        #cardContainer {
            display: inline-block;
            vertical-align: top;
        }

        #printableCard {
            position: relative;
            width: 279.4mm;
            height: 215.9mm;
            overflow: hidden;
        }

        #front-card {
            width: 100%;
            height: 100%;
        }

        .overlay-text {
            position: absolute;
            top: 50px;
            left: 250px;
            color: black;
            font-family: 'Times New Roman';
            white-space: nowrap;
            font-size: smaller;
        }

        .overlay-text .month-text {
            white-space: nowrap;
            font-size: smaller;
            text-align: center;
            display: inline-block;
            font-weight: bold;
        }

        .overlay-text #month1wrapper {
            position: absolute;
            top: 122px;
            left: -149px;
            transform: translateX(-50%);
            width: auto;
        }

        .overlay-text #month2wrapper {
            position: absolute;
            top: 122px;
            left: -120px;
            transform: translateX(-50%);
            width: auto;
        }

        .overlay-text #month3wrapper {
            position: absolute;
            top: 122px;
            left: -90px;
            transform: translateX(-50%);
            width: auto;
        }

        .overlay-text #month4wrapper {
            position: absolute;
            top: 122px;
            left: -59px;
            transform: translateX(-50%);
            width: auto;
        }

        .overlay-text #month5wrapper {
            position: absolute;
            top: 122px;
            left: -31px;
            transform: translateX(-50%);
            width: auto;
        }

        .overlay-text #month6wrapper {
            position: absolute;
            top: 122px;
            left: -2px;
            transform: translateX(-50%);
            width: auto;
        }

        .overlay-text #month7wrapper {
            position: absolute;
            top: 122px;
            left: 28px;
            transform: translateX(-50%);
            width: auto;
        }

        .overlay-text #month8wrapper {
            position: absolute;
            top: 122px;
            left: 58px;
            transform: translateX(-50%);
            width: auto;
        }

        .overlay-text #month9wrapper {
            position: absolute;
            top: 122px;
            left: 87px;
            transform: translateX(-50%);
            width: auto;
        }

        .overlay-text #month10wrapper {
            position: absolute;
            top: 122px;
            left: 117px;
            transform: translateX(-50%);
            width: auto;
        }

        .overlay-text #month11wrapper {
            position: absolute;
            top: 122px;
            left: 147px;
            transform: translateX(-50%);
            width: auto;
        }

        .overlay-text #month12wrapper {
            position: absolute;
            top: 122px;
            left: 175px;
            transform: translateX(-50%);
            width: auto;
        }

        .overlay-text .schooldays-text,
        .presentdays-text,
        .absentdays-text,
        .totaldays-text {
            white-space: nowrap;
            font-size: smaller;
            text-align: center;
            display: inline-block;
        }

        .overlay-text #schoolDays1Wrapper {
            position: absolute;
            top: 157px;
            left: -150px;
            transform: translateX(-50%);
            width: auto;
        }

        .overlay-text #schoolDays2Wrapper {
            position: absolute;
            top: 157px;
            left: -120px;
            transform: translateX(-50%);
            width: auto;
        }

        .overlay-text #schoolDays3Wrapper {
            position: absolute;
            top: 157px;
            left: -91px;
            transform: translateX(-50%);
            width: auto;
        }

        .overlay-text #schoolDays4Wrapper {
            position: absolute;
            top: 157px;
            left: -60px;
            transform: translateX(-50%);
            width: auto;
        }

        .overlay-text #schoolDays5Wrapper {
            position: absolute;
            top: 157px;
            left: -32px;
            transform: translateX(-50%);
            width: auto;
        }

        .overlay-text #schoolDays6Wrapper {
            position: absolute;
            top: 157px;
            left: 2px;
            transform: translateX(-50%);
            width: auto;
        }

        .overlay-text #schoolDays7Wrapper {
            position: absolute;
            top: 157px;
            left: 28px;
            transform: translateX(-50%);
            width: auto;
        }

        .overlay-text #schoolDays8Wrapper {
            position: absolute;
            top: 157px;
            left: 58px;
            transform: translateX(-50%);
            width: auto;
        }

        .overlay-text #schoolDays9Wrapper {
            position: absolute;
            top: 157px;
            left: 87px;
            transform: translateX(-50%);
            width: auto;
        }

        .overlay-text #schoolDays10Wrapper {
            position: absolute;
            top: 157px;
            left: 117px;
            transform: translateX(-50%);
            width: auto;
        }

        .overlay-text #schoolDays11Wrapper {
            position: absolute;
            top: 157px;
            left: 147px;
            transform: translateX(-50%);
            width: auto;
        }

        .overlay-text #schoolDays12Wrapper {
            position: absolute;
            top: 157px;
            left: 175px;
            transform: translateX(-50%);
            width: auto;
        }

        .overlay-text #presentDays1Wrapper {
            position: absolute;
            top: 218px;
            left: -150px;
            transform: translateX(-50%);
            width: auto;
        }

        .overlay-text #presentDays2Wrapper {
            position: absolute;
            top: 218px;
            left: -121px;
            transform: translateX(-50%);
            width: auto;
        }

        .overlay-text #presentDays3Wrapper {
            position: absolute;
            top: 218px;
            left: -91px;
            transform: translateX(-50%);
            width: auto;
        }

        .overlay-text #presentDays4Wrapper {
            position: absolute;
            top: 218px;
            left: -60px;
            transform: translateX(-50%);
            width: auto;
        }

        .overlay-text #presentDays5Wrapper {
            position: absolute;
            top: 218px;
            left: -32px;
            transform: translateX(-50%);
            width: auto;
        }

        .overlay-text #presentDays6Wrapper {
            position: absolute;
            top: 218px;
            left: -2px;
            transform: translateX(-50%);
            width: auto;
        }

        .overlay-text #presentDays7Wrapper {
            position: absolute;
            top: 218px;
            left: 28px;
            transform: translateX(-50%);
            width: auto;
        }

        .overlay-text #presentDays8Wrapper {
            position: absolute;
            top: 218px;
            left: 58px;
            transform: translateX(-50%);
            width: auto;
        }

        .overlay-text #presentDays9Wrapper {
            position: absolute;
            top: 218px;
            left: 87px;
            transform: translateX(-50%);
            width: auto;
        }

        .overlay-text #presentDays10Wrapper {
            position: absolute;
            top: 218px;
            left: 117px;
            transform: translateX(-50%);
            width: auto;
        }

        .overlay-text #presentDays11Wrapper {
            position: absolute;
            top: 218px;
            left: 147px;
            transform: translateX(-50%);
            width: auto;
        }

        .overlay-text #presentDays12Wrapper {
            position: absolute;
            top: 218px;
            left: 175px;
            transform: translateX(-50%);
            width: auto;
        }

        .overlay-text #absentDays1Wrapper {
            position: absolute;
            top: 280px;
            left: -150px;
            transform: translateX(-50%);
            width: auto;
        }

        .overlay-text #absentDays2Wrapper {
            position: absolute;
            top: 280px;
            left: -121px;
            transform: translateX(-50%);
            width: auto;
        }

        .overlay-text #absentDays3Wrapper {
            position: absolute;
            top: 280px;
            left: -91px;
            transform: translateX(-50%);
            width: auto;
        }

        .overlay-text #absentDays4Wrapper {
            position: absolute;
            top: 280px;
            left: -60px;
            transform: translateX(-50%);
            width: auto;
        }

        .overlay-text #absentDays5Wrapper {
            position: absolute;
            top: 280px;
            left: -32px;
            transform: translateX(-50%);
            width: auto;
        }

        .overlay-text #absentDays6Wrapper {
            position: absolute;
            top: 280px;
            left: -2px;
            transform: translateX(-50%);
            width: auto;
        }

        .overlay-text #absentDays7Wrapper {
            position: absolute;
            top: 280px;
            left: 28px;
            transform: translateX(-50%);
            width: auto;
        }

        .overlay-text #absentDays8Wrapper {
            position: absolute;
            top: 280px;
            left: 58px;
            transform: translateX(-50%);
            width: auto;
        }

        .overlay-text #absentDays9Wrapper {
            position: absolute;
            top: 280px;
            left: 87px;
            transform: translateX(-50%);
            width: auto;
        }

        .overlay-text #absentDays10Wrapper {
            position: absolute;
            top: 280px;
            left: 117px;
            transform: translateX(-50%);
            width: auto;
        }

        .overlay-text #absentDays11Wrapper {
            position: absolute;
            top: 280px;
            left: 147px;
            transform: translateX(-50%);
            width: auto;
        }

        .overlay-text #absentDays12Wrapper {
            position: absolute;
            top: 280px;
            left: 175px;
            transform: translateX(-50%);
            width: auto;
        }

        .overlay-text #totalSchoolDays {
            position: absolute;
            top: 157px;
            left: 208px;
        }

        .overlay-text #totalPresentDays {
            position: absolute;
            top: 218px;
            left: 208px;
        }

        .overlay-text #totalAbsentDays {
            position: absolute;
            top: 280px;
            left: 208px;
        }

        .overlay-text #studentName {
            top: 168px;
            left: 380px;
            position: absolute;
        }

        .overlay-text #studentAge {
            top: 186px;
            left: 430px;
            position: absolute;
        }

        .overlay-text #studentGender {
            top: 186px;
            left: 610px;
            position: absolute;
        }

        .overlay-text #studentGrade {
            top: 204px;
            left: 430px;
            position: absolute;
        }

        .overlay-text #studentSection {
            top: 204px;
            left: 630px;
            position: absolute;
        }

        .overlay-text #studentSchoolYear {
            top: 222px;
            left: 414px;
            position: absolute;
        }

        .overlay-text #studentLRN {
            top: 222px;
            left: 604px;
            position: absolute;
        }

        .overlay-text #studentStrand {
            top: 251px;
            left: 410px;
            position: absolute;
            font-size: smaller;
        }

        .overlay-text #studentTrack {
            top: 240px;
            left: 410px;
            position: absolute;
            font-size: smaller;
        }

        .overlay-text #studentTrackStrand {
            top: 246px;
            left: 410px;
            position: absolute;
            font-size: x-small;
            text-align: left;
        }

        .overlay-text #principalame {
            white-space: nowrap;
            font-size: inherit;
            text-align: center;
            display: inline-block;
            font-weight: bold;
        }

        .overlay-text #principalame2 {
            white-space: nowrap;
            font-size: inherit;
            text-align: center;
            display: inline-block;
            font-weight: bold;
        }

        .overlay-text #principalame3 {
            white-space: nowrap;
            font-size: inherit;
            text-align: center;
            display: inline-block;
            font-weight: bold;
        }

        .overlay-text #teacherName {
            white-space: nowrap;
            font-size: inherit;
            text-align: center;
            display: inline-block;
            font-weight: bold;
        }

        .overlay-text #teacherName2 {
            white-space: nowrap;
            font-size: inherit;
            text-align: center;
            display: inline-block;
            font-weight: bold;
        }

        .overlay-text #teacherNameWrapper {
            position: absolute;
            top: 389px;
            left: 669px;
            transform: translateX(-50%);
            width: auto;
            z-index: 5;
        }

        .overlay-text #teacherName2Wrapper {
            position: absolute;
            top: 540px;
            left: 669px;
            transform: translateX(-50%);
            width: auto;
        }

        .overlay-text #principalameWrapper {
            position: absolute;
            top: 389px;
            left: 421px;
            transform: translateX(-50%);
            width: auto;
            z-index: 5;
        }

        .overlay-text #principalame2Wrapper {
            position: absolute;
            top: 540px;
            left: 421px;
            transform: translateX(-50%);
            width: auto;
        }

        .overlay-text #principalameW3rapper {
            position: absolute;
            top: 665px;
            left: 634px;
            transform: translateX(-50%);
            width: auto;
        }

        .overlay-text #principalSignatureImg {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            display: none;
        }

        .overlay-text #teacherSignatureImg {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            display: none;
        }

        .overlay-text #principalSignatureWrapper {
            position: absolute;
            top: 368px;
            left: 319px;
            width: 203px;
            height: 35px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .overlay-text #teacherSignatureWrapper {
            position: absolute;
            top: 356px;
            left: 563px;
            width: 210px;
            height: 44px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        @media print {
            body * {
                visibility: hidden;
            }

            #printableCard,
            #printableCard * {
                visibility: visible;
            }

            #printableCard {
                position: absolute;
                top: 0;
                left: 0;
                width: 279.4mm;
                height: 215.9mm;
                margin: 0;
                transform: scale(1) !important
            }

            @page {
                size: letter landscape;
                margin: 0;
            }
        }


        @media (max-width: 768px) {
            .button-row {
                flex-direction: column;
                align-items: stretch !important;
            }

            .button-row .btn-group-left,
            .button-row .btn-danger,
            .btn-primary {
                width: 100%;
            }

            .button-row .btn-group-left .btn {
                flex: 1;
            }

            .button-row>.ms-auto {
                display: none;

            }
        }


        body.generation-locked {
            overflow: hidden;
        }

        body.generation-locked::before {
            content: "";
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.4);
            z-index: 9998;
            pointer-events: all;
        }


        #progressOverlay,
        #progressOverlay * {
            pointer-events: auto !important;
        }

        .btn-primary {
            background: linear-gradient(135deg, #0078e9, #00a8ff) !important;
            border: none !important;
            box-shadow: 0 2px 8px rgba(0, 120, 233, 0.25) !important;
            transition: all 0.2s ease !important;
        }

        .btn-primary:hover {
            transform: translateY(-1px) !important;
            box-shadow: 0 4px 14px rgba(0, 120, 233, 0.35) !important;
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745, #20c997) !important;
            border: none !important;
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545, #c0392b) !important;
            border: none !important;
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-light bg-primary shadow-sm fixed-top" data-bs-theme="dark">
        <div class="container-fluid">
            <div
                class="d-flex flex-column flex-lg-row w-100 align-items-start align-items-lg-center justify-content-lg-between">
                <div class="d-flex align-items-center w-100 w-lg-auto justify-content-start mb-lg-0">
                    <button class="btn btn-outline-secondary me-2 d-lg-none" id="toggleBtn">â˜°</button>
                    <span class="navbar-brand mb-0 h1 d-none d-lg-inline" id="Hi">CardGen: From Grade Consolidation to
                        Printable Report Card for Senior High School</span>
                    <span class="navbar-brand mb-0 h1 d-inline d-lg-none" id="Hi">CardGen 2025</span>
                </div>
            </div>
        </div>
    </nav>

    <div class="sidebar collapsed" id="sidebar">
        <ul class="nav flex-column px-3">
            <div id="sidebar-container"></div>
        </ul>
    </div>

    <div class="main-content">
        <div class="container-fluid container">
            <div class="row">
                <div class="col-12">
                    <h1>Card</h1>
                    <select id="studentDropdown" class="form-select">
                        <option value="">Blank (Select Student)</option>
                    </select>
                    <br>
                    <div class="d-flex button-row flex-wrap gap-3 align-items-center mb-3">

                        <button id="downloadSingleBtn" class="btn btn-primary">
                            Download Current Card
                        </button>


                        <button id="downloadAllBtn" class="btn btn-success">
                            Download All Cards
                        </button>

                        <button class="btn btn-secondary" id="printCard">ðŸ–¨ Print Card</button>
                    </div>


                    <div id="progressOverlay" class="position-fixed top-0 start-0 w-100 h-100 d-none"
                        style="background: rgba(0,0,0,0.7); z-index: 9999; backdrop-filter: blur(5px);">
                        <div class="d-flex flex-column justify-content-center align-items-center h-100 text-black">
                            <div class="card bg-light text-black shadow-lg p-4" style="max-width: 460px; width: 92%;">
                                <h4 class="text-center mb-4 fw-bold">Generating All Report Cards</h4>

                                <div class="progress mb-4" style="height: 30px; background: rgba(0, 0, 0, 0.15);">
                                    <div id="progressBar"
                                        class="progress-bar progress-bar-striped progress-bar-animated bg-success"
                                        role="progressbar" style="width: 0%">0%</div>
                                </div>

                                <p id="progressStatus" class="text-center mb-4 fs-5 fw-semibold">
                                    Initializing...
                                </p>

                                <button id="btnCancelAll" class="btn btn-outline-danger btn-lg w-100">
                                    CANCEL GENERATION
                                </button>

                                <small class="text-center mt-3 opacity-75">
                                    Please wait â€” do not close or refresh this page
                                </small>
                            </div>
                        </div>
                    </div>
                    <div id="previewWrapper" style="text-align: center;">
                        <div id="cardContainer"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>


    <script src="../Assets/JS/SideBar-NavBar.js"></script>
    <script src="../Assets/JS/Logout.js"></script>
    <script src="../Assets/JS/Toast.js"></script>
    <script src="../Assets/JS/Loader.js"></script>

    <script>

        document.getElementById("printCard").addEventListener("click", function () {
            window.print();
        });


        const DB_NAME = 'CardGenSignatures';
        const DB_VERSION = 1;
        const STORE_NAME = 'signatures';
        let db;
        let generationInProgress = false;
        let abortController = null;

        function openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        db.createObjectStore(STORE_NAME);
                    }
                };

                request.onsuccess = (event) => {
                    db = event.target.result;
                    resolve(db);
                };

                request.onerror = (event) => {
                    console.error('IndexedDB error:', event.target.error);
                    reject(event.target.error);
                };
            });
        }

        async function loadSignature(type) {
            await openDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.get(type);

                request.onsuccess = () => resolve(request.result || null);
                request.onerror = (event) => reject(event.target.error);
            });
        }

        async function loadSignaturesToCard() {
            try {
                const teacherBlob = await loadSignature('teacher');
                const teacherImg = document.getElementById('teacherSignatureImg');
                if (teacherBlob instanceof Blob && teacherImg) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        teacherImg.src = e.target.result;
                        teacherImg.style.display = 'block';
                    };
                    reader.readAsDataURL(teacherBlob);
                } else if (teacherImg) {
                    teacherImg.style.display = 'none';
                }

                const principalBlob = await loadSignature('principal');
                const principalImg = document.getElementById('principalSignatureImg');
                if (principalBlob instanceof Blob && principalImg) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        principalImg.src = e.target.result;
                        principalImg.style.display = 'block';
                    };
                    reader.readAsDataURL(principalBlob);
                } else if (principalImg) {
                    principalImg.style.display = 'none';
                }
            } catch (err) {
                console.error('Failed to load signatures:', err);
            }
        }


        let allStudents = [];
        let cardGen = {};

        function updateCard(student) {
            const info = cardGen.information || {};

            const set = (id, val) => {
                const el = document.getElementById(id);
                if (el) el.textContent = val || "";
            };


            ['studentName', 'studentAge', 'studentGender', 'studentGrade', 'studentSection',
                'studentSchoolYear', 'studentLRN', 'studentTrack', 'studentStrand',
                'principalame', 'principalame2', 'principalame3', 'teacherName', 'teacherName2']
                .forEach(id => set(id, ''));


            ['teacherSignatureImg', 'principalSignatureImg'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.style.display = 'none';
            });


            fillMonthlyAttendance(null);

            if (!student) {
                adjustTrackStrandDisplay();
                adjustAllNameSizes();
                scaleCard();
                return;
            }


            set('studentName', student.name || '');
            set('studentAge', student.age || '');
            set('studentGender', student.gender || '');
            set('studentLRN', student.lrn || '');
            set('studentGrade', info.grade || '');
            set('studentSection', info.section || '');
            set('studentSchoolYear', info["school-year"] || '');
            set('studentTrack', info.track || '');
            set('studentStrand', info.strand || '');

            const adviser = info.adviser || '';
            const principal = info.principal || '';
            ['teacherName', 'teacherName2'].forEach(id => set(id, adviser));
            ['principalame', 'principalame2', 'principalame3'].forEach(id => set(id, principal));


            loadSignaturesToCard();


            fillMonthlyAttendance(student);


            adjustTrackStrandDisplay();
            adjustAllNameSizes();
            scaleCard();


            const months = cardGen.attendanceMonth
                ? cardGen.attendanceMonth.split(", ").map(m => m.trim())
                : [];

            months.forEach((month, index) => {
                const monthNum = index + 1;
                const el = document.getElementById(`month${monthNum}`);
                if (el) el.textContent = month;
            });
        }

        function fillMonthlyAttendance(student) {

            for (let m = 1; m <= 12; m++) {

                const schoolEl = document.getElementById(`school${m}Days`);
                if (schoolEl) schoolEl.textContent = '';


                const presentEl = document.getElementById(`present${m}Days`);
                if (presentEl) presentEl.textContent = '';


                const absentEl = document.getElementById(`absent${m}Days`);
                if (absentEl) absentEl.textContent = '';
            }


            ['totalSchoolDaysText', 'totalPresentDaysText', 'totalAbsentDaysText'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.textContent = '';
            });


            if (!student?.monthlyAttendance) {
                return;
            }

            const att = student.monthlyAttendance;


            for (let m = 1; m <= 12; m++) {
                const key = `month${m}`;


                const schoolDays = att.schoolDays?.[key] ?? '';
                const present = att.present?.[key] ?? '';
                const absent = (att.absent || {})[key] ?? '';


                const schoolEl = document.getElementById(`school${m}Days`);
                if (schoolEl) schoolEl.textContent = schoolDays;


                const presentEl = document.getElementById(`present${m}Days`);
                if (presentEl) presentEl.textContent = present;


                const absentEl = document.getElementById(`absent${m}Days`);
                if (absentEl) absentEl.textContent = absent;



            }


            const totalSchoolEl = document.getElementById('totalSchoolDaysText');
            const totalPresentEl = document.getElementById('totalPresentDaysText');
            const totalAbsentEl = document.getElementById('totalAbsentDaysText');

            if (totalSchoolEl) totalSchoolEl.textContent = att.total?.schoolDays ?? '';
            if (totalPresentEl) totalPresentEl.textContent = att.total?.present ?? '';
            if (totalAbsentEl) totalAbsentEl.textContent = att.total?.absent ?? '';
        }
        function scaleCard() {
            const wrapper = document.getElementById("previewWrapper");
            const card = document.getElementById("printableCard");
            if (!wrapper || !card) return;
            const scale = Math.min(wrapper.clientWidth / card.offsetWidth, 1);
            card.style.transform = `scale(${scale})`;
            card.style.transformOrigin = 'top left';
        }

        function fitTextToWrapper(textElement, maxWidth) {
            if (!textElement || !textElement.textContent.trim()) return;

            const wrapper = textElement.parentElement;
            if (!wrapper) return;

            wrapper.style.width = 'auto';
            wrapper.style.maxWidth = 'none';

            let originalFontSize = parseFloat(getComputedStyle(textElement).fontSize);
            if (isNaN(originalFontSize) || originalFontSize === 0) originalFontSize = 11.3333;
            textElement.style.fontSize = originalFontSize + 'px';

            const tolerance = 10;
            if (textElement.scrollWidth <= maxWidth + tolerance) return;

            let low = 5, high = originalFontSize, bestFit = originalFontSize;
            for (let i = 0; i < 20; i++) {
                let mid = (low + high) / 2;
                textElement.style.fontSize = mid.toFixed(2) + 'px';
                if (textElement.scrollWidth <= maxWidth) {
                    bestFit = mid;
                    low = mid;
                } else {
                    high = mid;
                }
            }
            textElement.style.fontSize = Math.max(5, bestFit - 0.3).toFixed(2) + 'px';
        }

        function adjustAllNameSizes() {
            const names = [
                { text: document.getElementById('teacherName'), maxWidth: 225 },
                { text: document.getElementById('teacherName2'), maxWidth: 225 },
                { text: document.getElementById('principalame'), maxWidth: 205 },
                { text: document.getElementById('principalame2'), maxWidth: 205 },
                { text: document.getElementById('principalame3'), maxWidth: 209 },
                { text: document.getElementById('studentName'), maxWidth: 364.5 }
            ];
            names.forEach(item => item.text && fitTextToWrapper(item.text, item.maxWidth));
        }

        function adjustTrackStrandDisplay() {
            const trackEl = document.getElementById("studentTrack");
            const strandEl = document.getElementById("studentStrand");
            const combinedEl = document.getElementById("studentTrackStrand");

            if (!trackEl || !strandEl || !combinedEl) return;

            const originalTrackText = trackEl.dataset.originalTrack || trackEl.textContent.trim();
            const strandText = strandEl.textContent.trim();

            if (!trackEl.dataset.originalTrack) {
                trackEl.dataset.originalTrack = originalTrackText;
            }

            const combinedText = originalTrackText && strandText ? `${originalTrackText} ${strandText}` : originalTrackText || strandText;


            if (!originalTrackText || !strandText) {
                combinedEl.textContent = combinedText;
                combinedEl.style.display = "block";
                trackEl.style.display = "none";
                strandEl.style.display = "none";
                return;
            }


            const temp = document.createElement('span');
            const combinedStyle = getComputedStyle(combinedEl);
            temp.style.fontFamily = combinedStyle.fontFamily;
            temp.style.fontSize = combinedStyle.fontSize;
            temp.style.fontWeight = combinedStyle.fontWeight;
            temp.style.letterSpacing = combinedStyle.letterSpacing;
            temp.style.whiteSpace = 'nowrap';
            temp.style.position = 'absolute';
            temp.style.visibility = 'hidden';
            temp.textContent = combinedText;
            document.body.appendChild(temp);
            const textWidth = temp.scrollWidth;
            document.body.removeChild(temp);


            const maxTrackStrandWidth = 322;

            if (textWidth <= maxTrackStrandWidth) {

                combinedEl.textContent = combinedText;
                combinedEl.style.display = "block";
                trackEl.style.display = "none";
                strandEl.style.display = "none";
            } else {

                trackEl.textContent = `${originalTrackText} `;
                strandEl.textContent = strandText;
                trackEl.style.display = "block";
                strandEl.style.display = "block";
                combinedEl.style.display = "none";
            }
        }


        document.addEventListener("DOMContentLoaded", async () => {
            const STORAGE_KEY = "CardGen";
            const dropdown = document.getElementById("studentDropdown");
            const cardContainer = document.getElementById("cardContainer");

            cardGen = JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");



            allStudents = [];
            Object.values(cardGen.students?.boys || {}).forEach(student => {
                if (student.name?.trim()) {
                    allStudents.push({
                        ...student,
                        gender: student.gender || "MALE"
                    });
                }
            });
            Object.values(cardGen.students?.girls || {}).forEach(student => {
                if (student.name?.trim()) {
                    allStudents.push({
                        ...student,
                        gender: student.gender || "FEMALE"
                    });
                }
            });
            allStudents.sort((a, b) => a.name.localeCompare(b.name));


            try {
                cardContainer.innerHTML = await (await fetch("../Assets/HTML/Front_Card_Template.html")).text();
            } catch (err) {
                console.error("Failed to load card template:", err);
                cardContainer.innerHTML = "<h3>Error: Card template not found!</h3>";
                return;
            }


            allStudents.forEach(student => {
                const option = document.createElement("option");
                option.value = student.name;
                option.textContent = `${student.name} (${student.gender === "MALE" ? "M" : "F"})`;
                dropdown.appendChild(option);
            });


            updateCard(null);


            dropdown.addEventListener("change", () => {
                const selectedName = dropdown.value;
                const student = allStudents.find(s => s.name === selectedName);
                updateCard(student);
            });

            window.addEventListener("resize", scaleCard);


            async function captureCard() {
                const card = document.getElementById("printableCard");
                card.style.transform = "scale(1)";
                await new Promise(r => requestAnimationFrame(r));

                const canvas = await html2canvas(card, {
                    scale: 3,
                    useCORS: true,
                    backgroundColor: null,
                    windowWidth: card.scrollWidth,
                    windowHeight: card.scrollHeight,
                    logging: false
                });

                return canvas.toDataURL("image/jpeg", 0.95);
            }

            window.downloadSinglePDF = async function () {
                const name = dropdown.value;
                if (!name) return showToast("Select a student first!");
                const student = allStudents.find(s => s.name === name);
                updateCard(student);
                await new Promise(r => setTimeout(r, 200));
                const img = await captureCard();
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({ orientation: "landscape", unit: "mm", format: "letter" });
                pdf.addImage(img, "JPEG", 0, 0, pdf.internal.pageSize.getWidth(), pdf.internal.pageSize.getHeight());
                pdf.save(`${name.replace(/[\\/:*?"<>|]/g, "_")}_Card.pdf`);
            };


            function updateProgress(percent, message = '') {
                const bar = document.getElementById("progressBar");
                const status = document.getElementById("progressStatus");
                if (!bar || !status) return;

                bar.style.width = `${percent}%`;
                bar.textContent = `${percent}%`;

                if (message) {
                    status.textContent = message;
                } else if (percent === 100) {
                    status.textContent = "Finalizing PDF...";
                } else {
                    status.textContent = `Generating... ${percent}%`;
                }
            }


            window.downloadAllPDFs = async function () {
                if (allStudents.length === 0) {
                    showToast("No students available!", "warning");
                    return;
                }

                if (generationInProgress) return;

                generationInProgress = true;
                abortController = new AbortController();
                const { signal } = abortController;

                const overlay = document.getElementById("progressOverlay");
                const cancelBtn = document.getElementById("btnCancelAll");
                const progressBar = document.getElementById("progressBar");


                document.body.classList.add("generation-locked");
                overlay.classList.remove("d-none");


                progressBar.style.width = "0%";
                progressBar.textContent = "0%";
                document.getElementById("progressStatus").textContent = "Preparing cards...";
                cancelBtn.disabled = false;
                cancelBtn.textContent = "CANCEL GENERATION";

                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({
                    orientation: "landscape",
                    unit: "mm",
                    format: "letter"
                });

                let cancelled = false;

                try {
                    for (let i = 0; i < allStudents.length; i++) {
                        if (signal.aborted) {
                            cancelled = true;
                            break;
                        }

                        updateCard(allStudents[i]);
                        await new Promise(r => requestAnimationFrame(r));
                        await new Promise(r => setTimeout(r, 40));

                        const imgData = await captureCard();

                        if (i > 0) pdf.addPage();
                        pdf.addImage(imgData, "JPEG", 0, 0, 279.4, 215.9, undefined, "FAST");


                        const current = i + 1;
                        if (current % 5 === 0 || current === allStudents.length) {
                            const percent = Math.round((current / allStudents.length) * 100);
                            const message = `Card ${current} of ${allStudents.length}`;
                            updateProgress(percent, message);
                        }


                        await new Promise(r => setTimeout(r, 10));
                    }

                    if (!cancelled) {
                        pdf.save("All_Students_Cards_" + new Date().toISOString().slice(0, 10) + ".pdf");
                        showToast("Successfully generated all cards!", "success");
                    } else {
                        showToast("Generation cancelled", "info");
                    }

                } catch (err) {
                    console.error("Generation failed:", err);
                    showToast("Error during generation. Please try again.", "danger");
                } finally {

                    generationInProgress = false;
                    document.body.classList.remove("generation-locked");
                    overlay.classList.add("d-none");


                    const selectedName = document.getElementById("studentDropdown")?.value;
                    if (selectedName) {
                        const student = allStudents.find(s => s.name === selectedName);
                        if (student) updateCard(student);
                    }
                }
            };


            document.getElementById("btnCancelAll")?.addEventListener("click", () => {
                if (!generationInProgress || !abortController) return;

                abortController.abort();
                document.getElementById("btnCancelAll").disabled = true;
                document.getElementById("btnCancelAll").textContent = "CANCELLING...";
                document.getElementById("progressStatus").textContent = "Cancelling current operation...";
            });


            window.addEventListener("beforeunload", (e) => {
                if (generationInProgress) {
                    e.preventDefault();
                    return (e.returnValue = "Report card generation is still running. Are you sure you want to leave?");
                }
            });

            document.getElementById("downloadSingleBtn").addEventListener("click", downloadSinglePDF);
            document.getElementById("downloadAllBtn").addEventListener("click", downloadAllPDFs);


            if (typeof loadSidebar === "function") {
                loadSidebar("Front_Card.html");
            }


            window.updateCard = updateCard;
            window.adjustTrackStrandDisplay = adjustTrackStrandDisplay;
            window.adjustAllNameSizes = adjustAllNameSizes;
            window.scaleCard = scaleCard;
        });
    </script>
</body>

</html>