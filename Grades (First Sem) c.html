<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grades (First Sem)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="root.css">
    <link rel="stylesheet" href="Toast.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@14.3.0/dist/handsontable.full.min.css">
    <style>
        body {
            background: var(--background-color);
            margin: 0;
            min-height: 100vh;
            font-family: 'Poppins', sans-serif;
            padding: 20px;
        }

        .navbar {
            z-index: 1060 !important;
            font-family: 'Oswald', sans-serif;
            background: var(--primary-color) !important;
        }

        .main-content {
            margin-left: 0;
            transition: margin-left 0.3s;
            padding-right: 1rem;
            padding-top: 0;
        }

        @media (min-width: 992px) {
            .main-content {
                margin-left: 250px;
                padding-right: 2rem;
            }

            #toggleBtn {
                display: none;
            }

            .sidebar {
                transform: translateX(0) !important;
            }
        }

        @media (max-width: 991.98px) {
            .sidebar {
                position: absolute;
                height: 100vh;
            }
        }

        @media (max-width: 768px) {
            .button-row {
                flex-direction: column;
            }

            .btn-group-left {
                flex-direction: column;
            }

            .hot-container {
                height: 250px;
            }
        }

        .sidebar {
            height: 100vh;
            width: 250px;
            position: fixed;
            top: 0;
            left: 0;
            background: var(--secondary-color);
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
            z-index: 1050;
            font-family: 'Poppins', sans-serif;
            padding-top: 60px;
        }

        .sidebar.collapsed {
            transform: translateX(-100%);
        }

        .sidebar .nav-link {
            border-radius: 5px;
            transition: background-color 0.2s ease, color 0.2s ease, transform 0.2s ease;
            color: var(--primary-color);
        }

        .sidebar .nav-link:hover {
            background-color: var(--primary-color);
            color: var(--secondary-color);
            transform: translateX(5px);
        }

        .sidebar .nav-link.active {
            background-color: var(--primary-color);
            color: var(--secondary-color);
            font-weight: bold;
            transform: translateX(5px);
            pointer-events: none;
        }

        .sidebar .nav-item p {
            font-family: Poppins;
            font-weight: bold;
            color: var(--primarydark-color);
        }

        #toggleBtn {
            color: var(--secondary-color);
            border-color: var(--secondary-color);
        }

        #toggleBtn:hover {
            background-color: var(--secondary-color) !important;
            color: var(--primary-color) !important;
            border-color: var(--secondary-color) !important;
        }

        .button-row {
            margin-bottom: 20px;
        }

        .btn-group-left {
            display: flex;
            gap: 10px;
        }

        .btn-right {
            margin-left: auto;
        }

        .hot-container {
            height: 300px;
            border: 1px solid var(--primarydark-color);
            margin-bottom: 20px;
            overflow: auto;
        }

        .student-table {
            height: 300px;
        }

        .signature-preview {
            max-width: 200px;
            max-height: 100px;
            margin: 10px 0;
            border: 1px solid var(--background-color);
        }

        .remove-signature {
            position: absolute;
            top: -5px;
            right: -5px;
            background: red;
            color: var(--secondary-color);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            cursor: pointer;
        }

        .metadata-table {
            height: 250px;
        }

        .htInvalid {
            background-color: var(--background-color) !important;
            border: 2px solid #f44336 !important;
        }

        .space {
            height: 20px;
        }

        .btn .btn-secondary {
            background-color: var(--danger) !important;
        }

        .handsontable thead th .relative {
            background-color: var(--accent-color);
            border: 1px solid var(--primarydark-color);
        }

        .handsontable table {
            border-collapse: collapse;
            border: 1px solid var(--primarydark-color);
        }

        .ht_master tb {
            background-color: var(--accent-color);
            border: 1px solid var(--primarydark-color);
        }

        .btn-primary {
            background-color: var(--primary-color) !important;
            border-color: var(--primarydark-color);
        }

        @media (max-width: 768px) {
            .button-row {
                flex-direction: column;
                align-items: stretch !important;
            }

            .button-row .btn-group-left,
            .button-row .btn-danger {
                width: 100%;
            }

            .button-row .btn-group-left .btn {
                flex: 1;
            }

            .button-row>.ms-auto {
                display: none;
                /* Hide spacer on mobile */
            }
        }

        #confirmModal .btn-danger:focus {
            box-shadow: 0 0 0 0.25rem rgba(134, 0, 13, 0.795);
        }

        /* Fix for import result modal - prevent it from becoming too tall */
        #importModal .modal-dialog {
            max-height: 90vh;
            /* ← key: limit total modal height */
            margin: 2rem auto;
            /* better spacing on small screens */
        }

        #importModal .modal-content {
            max-height: 60vh;
            /* leave space for header/footer */
            display: flex;
            flex-direction: column;
        }

        #importModal .modal-body {
            overflow-y: auto;
            /* ← now body can scroll if needed */
            flex: 1;
            /* take available space */
            padding: 1.5rem !important;
            /* override py-5 when too much */
            max-height: 65vh;
            /* safety limit - adjust as needed */
        }

        /* Make sure the unmatched names list doesn't fight with body scroll */
        #importModal .unmatched-container {
            max-height: 45vh !important;
            /* tighter control inside body */
            overflow-y: auto;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 10px;
            margin-top: 12px;
            font-size: 0.875rem;
        }

        /* Optional: smaller text on mobile */
        @media (max-width: 576px) {
            #importModal .modal-dialog {
                max-height: 95vh;
                margin: 0.5rem;
            }

            #importModal .modal-body {
                padding: 1rem !important;
            }
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-light bg-primary shadow-sm fixed-top" data-bs-theme="dark">
        <div class="container-fluid">
            <div
                class="d-flex flex-column flex-lg-row w-100 align-items-start align-items-lg-center justify-content-lg-between">
                <div class="d-flex align-items-center w-100 w-lg-auto justify-content-start mb-2 mb-lg-0">
                    <button class="btn btn-outline-secondary me-2 d-lg-none" id="toggleBtn">☰</button>
                    <span class="navbar-brand mb-0 h1 d-none d-lg-inline" id="Hi">CardGen: From Grade Consolidation to
                        Printable Report Card for Senior High School</span>
                    <span class="navbar-brand mb-0 h1 d-inline d-lg-none" id="Hi">CardGen 2025</span>
                </div>
            </div>
        </div>
    </nav>
    <div class="sidebar collapsed" id="sidebar">
        <ul class="nav flex-column px-3">
            <div id="sidebar-container"></div>
        </ul>
    </div>
    <div class="main-content">
        <div class="container-fluid container">
            <div class="row">
                <div class="col-12">
                    <div class="d-flex button-row flex-wrap gap-3 align-items-center">
                        <div class="btn-group-left d-flex flex-wrap gap-2">
                            <button class="btn btn-primary" onclick="exportData()">Export Data</button>
                            <button class="btn btn-secondary"
                                onclick="document.getElementById('importFile').click()">Import Data</button>
                            <input type="file" id="importFile" accept=".xlsx,.xls" style="display:none"
                                onchange="importData(event)">
                        </div>
                        <div class="ms-auto"></div> <!-- Spacer to push Clear button to the right on large screens -->
                        <button class="btn btn-danger flex-shrink-0" onclick="showClearSem1GradesConfirmation()">Clear
                            Data</button>
                    </div>
                    <div id="subjectList" class="hot-container"></div>
                    <h5>Males Data</h5>
                    <div id="boysHot" class="hot-container student-table"></div>
                    <h5>Females Data</h5>
                    <div id="girlsHot" class="hot-container student-table"></div>

                    <!-- REUSABLE CONFIRMATION MODAL (same as reference page) -->
                    <div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true" style="z-index: 9999;">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="confirmModalTitle">Confirm Action</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"
                                        aria-label="Close"></button>
                                </div>
                                <div class="modal-body" id="confirmModalBody">
                                    Are you sure you want to proceed?
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary"
                                        data-bs-dismiss="modal">Cancel</button>
                                    <button type="button" class="btn btn-danger" id="confirmModalConfirmBtn"
                                        autofocus>Confirm</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- IMPORT MODAL (updated with autofocus on OK button when it appears) -->
                    <div class="modal fade" id="importModal" tabindex="-1" data-bs-backdrop="static"
                        data-bs-keyboard="false" style="z-index: 1090">
                        <div class="modal-dialog modal-dialog-centered modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="importModalTitle">Importing Grades</h5>
                                    <button type="button" class="btn-close d-none" id="importModalCloseBtn"
                                        data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body text-center py-5" id="importModalBody">
                                </div>
                                <div class="modal-footer d-none" id="importModalFooter">
                                    <button type="button" class="btn btn-primary" id="importModalOKBtn"
                                        autofocus>OK</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="modal fade" style="z-index: 9999;" id="confirmModal" tabindex="-1" aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="confirmModalTitle">Confirm Action</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"
                                        aria-label="Close"></button>
                                </div>
                                <div class="modal-body" id="confirmModalBody">
                                    Are you sure you want to proceed?
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary"
                                        data-bs-dismiss="modal">Cancel</button>
                                    <button type="button" class="btn btn-danger btn-primary" id="confirmModalConfirmBtn"
                                        autofocus>Confirm</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="loader.js"></script>
    <script>
        loadSidebar("Grades (First Sem) c.html");
    </script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const STORAGE_KEY = "CardGen";

            if (!localStorage.getItem(STORAGE_KEY)) {
                localStorage.setItem(STORAGE_KEY, JSON.stringify({
                    information: {},
                    subject: { sem1: { core: {}, applied: {} }, sem2: { core: {}, applied: {} } },
                    students: { boys: {}, girls: {} },
                    chathistory: {}
                }));
            }

            function getCardGen() { return JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}"); }
            function saveCardGen(data) { localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); }

            // ==================== NORMALIZE NAME ====================
            const normalizeName = name => {
                if (!name) return "";
                return name.toLowerCase()
                    .normalize("NFD")
                    .replace(/[\u0300-\u036f]/g, "")
                    .replace(/[^a-z\s]/g, '')
                    .replace(/\s+/g, ' ')
                    .trim();
            };

            // ==================== COMPUTATIONS ====================
            function computeFinalSemForCell(instance, row, col) {
                if (row < 4) return;
                const isCore = col >= 2 && col <= 25;
                const isApplied = col >= 26 && col <= 49;
                if (!isCore && !isApplied) return;

                const base = isCore ? 2 : 26;
                const subjectOffset = Math.floor((col - base) / 3) * 3;
                const col1 = base + subjectOffset;
                const col2 = base + subjectOffset + 1;
                const col3 = base + subjectOffset + 2;

                const q1 = parseFloat(instance.getDataAtCell(row, col1)) || 0;
                const q2 = parseFloat(instance.getDataAtCell(row, col2)) || 0;

                const finalGrade = (q1 > 0 && q2 > 0) ? Math.round((q1 + q2) / 2) : null;
                instance.setDataAtCell(row, col3, finalGrade, "autoCalc");
            }

            function computeGenAveForStudent(instance, row) {
                if (row < 4) return;
                let total = 0, count = 0;
                for (let s = 0; s < 8; s++) {
                    const valCore = parseFloat(instance.getDataAtCell(row, 4 + s * 3)) || 0;
                    const valApplied = parseFloat(instance.getDataAtCell(row, 28 + s * 3)) || 0;
                    if (valCore > 0) { total += valCore; count++; }
                    if (valApplied > 0) { total += valApplied; count++; }
                }
                const genAve = count > 0 ? Math.round(total / count) : null;
                instance.setDataAtCell(row, 1, genAve, "autoCalc");
            }

            // ==================== SAVE GRADES ====================
            function saveGradesToCardGen(instance, gender) {
                let data = getCardGen();
                if (!data.students) data.students = { boys: {}, girls: {} };
                if (!data.students[gender]) data.students[gender] = {};

                for (let i = 4; i < instance.countRows(); i++) {
                    const name = instance.getDataAtCell(i, 0)?.trim();
                    if (!name) continue;

                    let student = Object.values(data.students[gender]).find(s => s.name?.trim() === name);
                    if (!student) {
                        student = {
                            name,
                            grade: {
                                sem1: {
                                    core: {},
                                    applied: {},
                                    genAve: ""
                                }
                            }
                        };
                        data.students[gender][name.toUpperCase()] = student; // ← CHANGE: Use name as key
                    }

                    student.grade = student.grade || {};
                    student.grade.sem1 = student.grade.sem1 || { core: {}, applied: {}, genAve: "" };
                    student.grade.sem1.genAve = instance.getDataAtCell(i, 1) ?? "";

                    for (let s = 0; s < 8; s++) {
                        const col = 2 + s * 3;
                        const key = `subject${s + 1}`;
                        student.grade.sem1.core[key] = {
                            "1st": instance.getDataAtCell(i, col) ?? "",
                            "2nd": instance.getDataAtCell(i, col + 1) ?? "",
                            "final": instance.getDataAtCell(i, col + 2) ?? ""
                        };
                    }

                    for (let s = 0; s < 8; s++) {
                        const col = 26 + s * 3;
                        const key = `subject${s + 1}`;
                        student.grade.sem1.applied[key] = {
                            "1st": instance.getDataAtCell(i, col) ?? "",
                            "2nd": instance.getDataAtCell(i, col + 1) ?? "",
                            "final": instance.getDataAtCell(i, col + 2) ?? ""
                        };
                    }
                }

                saveCardGen(data);
            }

            // ==================== RELOAD ALL TABLES (NEW - CLEAN & RELIABLE) ====================
            function reloadAllTables() {
                const data = getCardGen();

                // === Subject Table ===
                const coreNames = data.subject?.sem1?.core || {};
                const appliedNames = data.subject?.sem1?.applied || {};
                const coreSubs = [], appliedSubs = [];
                for (let i = 1; i <= 8; i++) {
                    coreSubs.push(coreNames[`subject${i}`] || "");
                    appliedSubs.push(appliedNames[`subject${i}`] || "");
                }

                const subjectData = [
                    ['', 'Core Subject', 'Applied and Specialized Subjects'],
                    ['1st Subject', coreSubs[0], appliedSubs[0]],
                    ['2nd Subject', coreSubs[1], appliedSubs[1]],
                    ['3rd Subject', coreSubs[2], appliedSubs[2]],
                    ['4th Subject', coreSubs[3], appliedSubs[3]],
                    ['5th Subject', coreSubs[4], appliedSubs[4]],
                    ['6th Subject', coreSubs[5], appliedSubs[5]],
                    ['7th Subject', coreSubs[6], appliedSubs[6]],
                    ['8th Subject', coreSubs[7], appliedSubs[7]],
                ];

                const subjectHot = document.getElementById('subjectList')?.__hotInstance;
                if (subjectHot) {
                    subjectHot.loadData(subjectData);
                    subjectHot.render();
                }

                // === Boys & Girls Tables ===
                ['boys', 'girls'].forEach(gender => {
                    const containerId = gender === 'boys' ? 'boysHot' : 'girlsHot';
                    const hot = document.getElementById(containerId)?.__hotInstance;
                    if (!hot) return;

                    // Build headers (same as in createStudentTable)
                    const headerRows = [];
                    const row0 = Array(50).fill("");
                    row0[0] = "Names of Learners"; row0[1] = "Gen Ave";
                    for (let i = 2; i <= 25; i++) row0[i] = "Core Subjects";
                    for (let i = 26; i <= 49; i++) row0[i] = "Applied & Specialized Subjects";
                    headerRows.push(row0);

                    const row1 = Array(50).fill("");
                    for (let s = 1; s <= 8; s++) {
                        row1[2 + (s - 1) * 3] = `${s} Subject`;
                        row1[26 + (s - 1) * 3] = `${s} Subject`;
                    }
                    headerRows.push(row1);

                    const row2 = Array(50).fill("");
                    const row3 = Array(50).fill("");
                    const anchors = [2, 5, 8, 11, 14, 17, 20, 23, 26, 29, 32, 35, 38, 41, 44, 47];
                    anchors.forEach(c => {
                        row2[c] = "QUARTER";
                        row2[c + 2] = "Final Sem";
                        row3[c] = "1";
                        row3[c + 1] = "2";
                    });
                    headerRows.push(row2, row3);

                    // Build student rows
                    const students = Object.values(data.students?.[gender] || {});
                    const studentRows = students.map(stu => {
                        const name = stu.name || "";
                        const genAve = stu.grade?.sem1?.genAve ?? "";
                        const row = [name, genAve, ...Array(48).fill("")];

                        for (let s = 0; s < 8; s++) {
                            const key = `subject${s + 1}`;
                            const g = stu.grade?.sem1?.core?.[key] || {};
                            const col = 2 + s * 3;
                            row[col] = g["1st"] ?? "";
                            row[col + 1] = g["2nd"] ?? "";
                            row[col + 2] = g["final"] ?? "";
                        }

                        for (let s = 0; s < 8; s++) {
                            const key = `subject${s + 1}`;
                            const g = stu.grade?.sem1?.applied?.[key] || {};
                            const col = 26 + s * 3;
                            row[col] = g["1st"] ?? "";
                            row[col + 1] = g["2nd"] ?? "";
                            row[col + 2] = g["final"] ?? "";
                        }

                        return row;
                    });

                    while (studentRows.length < 50) {
                        studentRows.push(["", "", ...Array(48).fill("")]);
                    }

                    const fullData = headerRows.concat(studentRows);
                    hot.loadData(fullData);
                    hot.render();
                });
            }

            // ==================== SUBJECT TABLE ====================
            const subjectContainer = document.getElementById('subjectList');
            let cardGen = getCardGen();

            const coreNames = cardGen.subject?.sem1?.core || {};
            const appliedNames = cardGen.subject?.sem1?.applied || {};

            const coreSubs = [];
            const appliedSubs = [];
            for (let i = 1; i <= 8; i++) {
                coreSubs.push(coreNames[`subject${i}`] || "");
                appliedSubs.push(appliedNames[`subject${i}`] || "");
            }

            const subjectData = [
                ['', 'Core Subject', 'Applied and Specialized Subjects'],
                ['1st Subject', coreSubs[0], appliedSubs[0]],
                ['2nd Subject', coreSubs[1], appliedSubs[1]],
                ['3rd Subject', coreSubs[2], appliedSubs[2]],
                ['4th Subject', coreSubs[3], appliedSubs[3]],
                ['5th Subject', coreSubs[4], appliedSubs[4]],
                ['6th Subject', coreSubs[5], appliedSubs[5]],
                ['7th Subject', coreSubs[6], appliedSubs[6]],
                ['8th Subject', coreSubs[7], appliedSubs[7]],
            ];

            subjectContainer.__hotInstance = new Handsontable(subjectContainer, {
                data: subjectData,
                rowHeaders: false,
                colHeaders: false,
                fixedRowsTop: 1,
                fixedColumnsLeft: 1,
                stretchH: 'all',
                height: 'auto',
                licenseKey: 'non-commercial-and-evaluation',
                cells: function (row, col) {
                    const meta = {};

                    if (row === 0) {
                        // Header row → bold + center everywhere
                        meta.readOnly = true;
                        meta.className = 'htCenter htBold';
                        return meta;
                    }

                    if (col === 0) {
                        // Label column (1st Subject, 2nd Subject, …) → center, not bold
                        meta.className = 'htCenter';
                        return meta;
                    }

                    // Core & Applied columns – data rows → center
                    if (col === 1 || col === 2) {
                        meta.className = 'htCenter';
                        return meta;
                    }

                    return meta;
                },
                afterChange: function (changes, source) {
                    if (source === 'loadData' || source === 'autoCalc') return;
                    let data = getCardGen();
                    data.subject = data.subject || { sem1: { core: {}, applied: {} } };
                    data.subject.sem1.core = {};
                    data.subject.sem1.applied = {};

                    for (let i = 1; i <= 8; i++) {
                        const coreName = this.getDataAtCell(i, 1) || "";
                        const appliedName = this.getDataAtCell(i, 2) || "";
                        data.subject.sem1.core[`subject${i}`] = coreName;
                        data.subject.sem1.applied[`subject${i}`] = appliedName;
                    }
                    saveCardGen(data);
                }
            });

            // ==================== STUDENT TABLES ====================
            function createStudentTable(containerId, gender) {
                const container = document.getElementById(containerId);
                if (!container) return;

                const data = getCardGen();

                const headerRows = [];
                const row0 = Array(50).fill("");
                row0[0] = "Names of Learners"; row0[1] = "Gen Ave";
                for (let i = 2; i <= 25; i++) row0[i] = "Core Subjects";
                for (let i = 26; i <= 49; i++) row0[i] = "Applied & Specialized Subjects";
                headerRows.push(row0);

                const row1 = Array(50).fill("");
                for (let s = 1; s <= 8; s++) {
                    row1[2 + (s - 1) * 3] = `${s} Subject`;
                    row1[26 + (s - 1) * 3] = `${s} Subject`;
                }
                headerRows.push(row1);

                const row2 = Array(50).fill("");
                const row3 = Array(50).fill("");
                const anchors = [2, 5, 8, 11, 14, 17, 20, 23, 26, 29, 32, 35, 38, 41, 44, 47];
                anchors.forEach(c => {
                    row2[c] = "QUARTER";
                    row2[c + 2] = "Final Sem";
                    row3[c] = "1";
                    row3[c + 1] = "2";
                });
                headerRows.push(row2, row3);

                const students = data.students?.[gender] || {};

                // Sa loob ng createStudentTable function, palitan ang student rows creation ng ganito:

const sortedStudents = Object.values(students).sort((a, b) => {
    const nameA = (a.name || "").trim();
    const nameB = (b.name || "").trim();
    return nameA.localeCompare(nameB, undefined, { sensitivity: 'base' }); // mas maganda para case-insensitive
});

const studentRows = sortedStudents.map(stu => {
    const name = stu.name || "";
    const genAve = stu.grade?.sem1?.genAve ?? "";
    const row = [name, genAve, ...Array(48).fill("")];

    for (let s = 0; s < 8; s++) {
        const key = `subject${s + 1}`;
        const g = stu.grade?.sem1?.core?.[key] || {};
        const col = 2 + s * 3;
        row[col] = g["1st"] ?? "";
        row[col + 1] = g["2nd"] ?? "";
        row[col + 2] = g["final"] ?? "";
    }

    for (let s = 0; s < 8; s++) {
        const key = `subject${s + 1}`;
        const g = stu.grade?.sem1?.applied?.[key] || {};
        const col = 26 + s * 3;
        row[col] = g["1st"] ?? "";
        row[col + 1] = g["2nd"] ?? "";
        row[col + 2] = g["final"] ?? "";
    }

    return row;
});

                while (studentRows.length < 50) {
                    studentRows.push(["", "", ...Array(48).fill("")]);
                }

                const mergeCells = [
                    { row: 0, col: 0, rowspan: 4, colspan: 1 }, { row: 0, col: 1, rowspan: 4, colspan: 1 },
                    { row: 0, col: 2, rowspan: 1, colspan: 24 }, { row: 0, col: 26, rowspan: 1, colspan: 24 },
                    ...anchors.map(c => ({ row: 1, col: c, rowspan: 1, colspan: 3 })),
                    ...anchors.flatMap(c => [{ row: 2, col: c, rowspan: 1, colspan: 2 }, { row: 2, col: c + 2, rowspan: 2, colspan: 1 }])
                ];

                const hot = new Handsontable(container, {
                    data: headerRows.concat(studentRows),
                    rowHeaders: i => i >= 4 ? i - 3 : "",
                    colHeaders: false,
                    mergeCells,
                    stretchH: 'all',
                    manualRowResize: true,
                    manualColumnResize: true,
                    licenseKey: 'non-commercial-and-evaluation',

                    columns: (function () {
                        const cols = Array(50).fill({});
                        cols[0] = { type: 'text' };
                        cols[1] = { readOnly: true };
                        for (let i = 2; i < 50; i++) {
                            const isSecondQuarter = (i - 2) % 3 === 1 || (i - 26) % 3 === 1;
                            cols[i] = {
                                type: 'numeric',
                                numericFormat: { pattern: '0' },
                                validator: isSecondQuarter ? function (value, callback) {
                                    if (value === '' || value == null) return callback(true);
                                    const row = this.row;
                                    if (row < 4) return callback(true);
                                    const base = i < 26 ? 2 : 26;
                                    const firstQuarterCol = base + Math.floor((i - base - 1) / 3) * 3;
                                    const q1 = parseFloat(this.instance.getDataAtCell(row, firstQuarterCol)) || 0;
                                    const q2 = parseFloat(value) || 0;
                                    callback(q2 >= q1);
                                } : null,
                                allowInvalid: true
                            };
                        }
                        return cols;
                    })(),

                    cells: function (row, col) {
                        const meta = {};

                        if (row < 4) {
                            // All header rows → centered + bold + locked
                            meta.readOnly = true;
                            meta.className = 'htCenter htBold';
                            return meta;
                        }

                        if (col === 0) {
                            // Names column – data rows only
                            meta.readOnly = true;
                            meta.className = 'htLeft htBold';
                            return meta;
                        }

                        if (col === 1) {
                            // General Average – always centered
                            meta.readOnly = true;
                            meta.className = 'htCenter';
                            return meta;
                        }

                        // Remaining columns = grade cells (2–49) in data rows
                        if (col >= 2 && col < 50 && row >= 4) {
                            meta.className = 'htCenter';           // ← this is the key change
                            // You can keep type: 'numeric' etc. from columns definition
                            return meta;
                        }

                        return meta;
                    },

                    afterValidate: function (isValid, value, row, col) {
                        if (row < 4) return;
                        const isSecondQuarter = (col - 2) % 3 === 1 || (col - 26) % 3 === 1;
                        if (!isSecondQuarter) return;

                        const meta = this.getCellMeta(row, col);
                        if (!isValid) {
                            meta.className = (meta.className || '').replace(' htInvalid', '') + ' htInvalid';
                            showToast("Warning: 2nd Quarter grade cannot be lower than 1st Quarter!", "warning");
                        } else {
                            meta.className = (meta.className || '').replace(' htInvalid', '');
                        }
                        this.render();
                    },

                    afterChange: function (changes, source) {
                        if (!changes || source === 'loadData' || source === 'autoCalc' || source === 'import') return;

                        changes.forEach(([row, colStr]) => {
                            const rowIndex = row;
                            const colIndex = parseInt(colStr);
                            if (rowIndex < 4) return;

                            computeFinalSemForCell(this, rowIndex, colIndex);
                            computeGenAveForStudent(this, rowIndex);

                            const isFirstQuarter = (colIndex >= 2 && (colIndex - 2) % 3 === 0) || (colIndex >= 26 && (colIndex - 26) % 3 === 0);
                            if (isFirstQuarter) {
                                const secondCol = colIndex + 1;
                                const q2Value = this.getDataAtCell(rowIndex, secondCol);
                                if (q2Value !== '' && q2Value !== null) {
                                    this.validateCell(q2Value, this.getCellMeta(rowIndex, secondCol), () => { });
                                }
                            }
                        });

                        saveGradesToCardGen(this, gender);
                    }
                });

                container.__hotInstance = hot;
            }

            createStudentTable('boysHot', 'boys');
            createStudentTable('girlsHot', 'girls');

            // ==================== REUSABLE CONFIRM MODAL FUNCTION (same as reference) ====================
            function askConfirm(title, message, onConfirm) {
                document.getElementById('confirmModalTitle').textContent = title;
                document.getElementById('confirmModalBody').textContent = message;

                const confirmBtn = document.getElementById('confirmModalConfirmBtn');
                const newConfirmBtn = confirmBtn.cloneNode(true);
                confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);

                newConfirmBtn.addEventListener('click', function () {
                    if (onConfirm) onConfirm();
                    const modalEl = document.getElementById('confirmModal');
                    const modal = bootstrap.Modal.getInstance(modalEl);
                    if (modal) modal.hide();
                });

                const modal = new bootstrap.Modal(document.getElementById('confirmModal'), {
                    keyboard: true,
                    backdrop: 'static'
                });
                modal.show();

                const modalEl = document.getElementById('confirmModal');
                modalEl.addEventListener('shown.bs.modal', () => newConfirmBtn.focus(), { once: true });

                // Keyboard navigation: Arrow Left/Right switches between buttons
                const handleArrowKeys = (e) => {
                    if (e.key === 'ArrowLeft' || e.key === 'ArrowRight') {
                        e.preventDefault();
                        const cancelBtn = modalEl.querySelector('.btn-secondary[data-bs-dismiss="modal"]');
                        if (document.activeElement === newConfirmBtn) {
                            cancelBtn.focus();
                        } else {
                            newConfirmBtn.focus();
                        }
                    }
                };
                modalEl.addEventListener('keydown', handleArrowKeys);
                modalEl.addEventListener('hidden.bs.modal', function cleanup() {
                    modalEl.removeEventListener('keydown', handleArrowKeys);
                    modalEl.removeEventListener('hidden.bs.modal', cleanup);
                });
            }

            // ==================== CLEAR ACTION USING REUSABLE MODAL ====================
            window.showClearSem1GradesConfirmation = function () {
                askConfirm(
                    "Clear Semester 1 Grades",
                    "Are you sure you want to clear all Semester 1 grades and subject names? This cannot be undone.",
                    confirmClearSem1Grades
                );
            };

            window.confirmClearSem1Grades = function () {
                let data = getCardGen();

                // Clear subject names
                data.subject = data.subject || { sem1: { core: {}, applied: {} } };
                data.subject.sem1.core = {};
                data.subject.sem1.applied = {};

                // Clear grades but keep student names
                ['boys', 'girls'].forEach(gender => {
                    Object.values(data.students?.[gender] || {}).forEach(student => {
                        if (student.grade?.sem1) {
                            student.grade.sem1 = { core: {}, applied: {}, genAve: "" };
                        }
                    });
                });

                saveCardGen(data);

                // Instant clear on tables
                const subjectHot = document.getElementById('subjectList')?.__hotInstance;
                if (subjectHot) {
                    const currentData = subjectHot.getData();
                    for (let row = 1; row <= 8; row++) {
                        currentData[row][1] = "";
                        currentData[row][2] = "";
                    }
                    subjectHot.loadData(currentData);
                }

                ['boysHot', 'girlsHot'].forEach(containerId => {
                    const hot = document.getElementById(containerId)?.__hotInstance;
                    if (!hot) return;
                    const currentData = hot.getData();
                    for (let row = 4; row < currentData.length; row++) {
                        currentData[row][1] = ""; // Gen Ave
                        for (let col = 2; col < 50; col++) {
                            currentData[row][col] = "";
                        }
                    }
                    hot.loadData(currentData);
                });

                showToast("Semester 1 grades cleared instantly! ⚡", "success");

                setTimeout(() => {
                    location.reload();
                }, 3000);
            };


            window.exportData = () => {
                const data = getCardGen();
                const wb = XLSX.utils.book_new();

                const coreNames = data.subject?.sem1?.core || {};
                const appliedNames = data.subject?.sem1?.applied || {};
                const coreSubs = [], appliedSubs = [];
                for (let i = 1; i <= 8; i++) {
                    coreSubs.push(coreNames[`subject${i}`] || "");
                    appliedSubs.push(appliedNames[`subject${i}`] || "");
                }

                const subjectData = [
                    ['', 'Core Subject', 'Applied and Specialized Subjects'],
                    ['1st Subject', coreSubs[0], appliedSubs[0]],
                    ['2nd Subject', coreSubs[1], appliedSubs[1]],
                    ['3rd Subject', coreSubs[2], appliedSubs[2]],
                    ['4th Subject', coreSubs[3], appliedSubs[3]],
                    ['5th Subject', coreSubs[4], appliedSubs[4]],
                    ['6th Subject', coreSubs[5], appliedSubs[5]],
                    ['7th Subject', coreSubs[6], appliedSubs[6]],
                    ['8th Subject', coreSubs[7], appliedSubs[7]],
                ];

                const boysFull = prepareStudentSheet(data.students?.boys || {});
                const girlsFull = prepareStudentSheet(data.students?.girls || {});

                const boysHeaders = boysFull.slice(0, 4);
                const boysStudents = boysFull.slice(4, 54);
                const girlsStudents = girlsFull.slice(4, 54);

                const sheet = [];
                subjectData.forEach(r => sheet.push(r));
                sheet.push([]);

                boysHeaders.forEach(r => sheet.push(r));
                const boysTitle = Array(50).fill(""); boysTitle[0] = "Males";
                sheet.push(boysTitle);
                boysStudents.forEach(r => sheet.push(r));

                const girlsTitle = Array(50).fill(""); girlsTitle[0] = "Females";
                sheet.push(girlsTitle);
                girlsStudents.forEach(r => sheet.push(r));
                sheet.push([]);

                const ws = XLSX.utils.aoa_to_sheet(sheet);

                ws['!merges'] = [
                    { s: { r: 10, c: 0 }, e: { r: 13, c: 0 } },
                    { s: { r: 10, c: 1 }, e: { r: 13, c: 1 } },
                    { s: { r: 10, c: 2 }, e: { r: 10, c: 25 } },
                    { s: { r: 10, c: 26 }, e: { r: 10, c: 49 } },
                    ...[2, 5, 8, 11, 14, 17, 20, 23, 26, 29, 32, 35, 38, 41, 44, 47].map(c => ({ s: { r: 11, c }, e: { r: 11, c: c + 2 } })),
                    ...[2, 5, 8, 11, 14, 17, 20, 23, 26, 29, 32, 35, 38, 41, 44, 47].map(c => ({ s: { r: 12, c }, e: { r: 12, c: c + 1 } })),
                    ...[4, 7, 10, 13, 16, 19, 22, 25, 28, 31, 34, 37, 40, 43, 46, 49].map(c => ({ s: { r: 12, c }, e: { r: 13, c } })),
                    { s: { r: 14, c: 0 }, e: { r: 14, c: 49 } },
                    { s: { r: 65, c: 0 }, e: { r: 65, c: 49 } }
                ];

                const boldCenter = { font: { bold: true }, alignment: { horizontal: "center", vertical: "center" } };
                const center = { alignment: { horizontal: "center", vertical: "center" } };

                for (let c = 0; c < 50; c++) {
                    const addr = XLSX.utils.encode_cell({ r: 0, c });
                    if (ws[addr]) ws[addr].s = boldCenter;
                }

                [10, 11, 12, 13].forEach(r => {
                    for (let c = 0; c < 50; c++) {
                        const addr = XLSX.utils.encode_cell({ r, c });
                        if (ws[addr]) ws[addr].s = boldCenter;
                    }
                });

                for (let c of [2, 5, 8, 11, 14, 17, 20, 23, 26, 29, 32, 35, 38, 41, 44, 47]) {
                    ['11', '12'].forEach(rowOffset => {
                        const r = rowOffset === '11' ? 11 : 12;
                        const addr = XLSX.utils.encode_cell({ r, c });
                        if (!ws[addr]) ws[addr] = { v: "" };
                        ws[addr].s = center;
                    });
                }

                if (!ws['A15']) ws['A15'] = { v: "Males" };
                ws['A15'].s = { font: { bold: true, sz: 16, color: { rgb: "1f4e78" } }, alignment: { horizontal: "center", vertical: "center" }, fill: { fgColor: { rgb: "E6F0FA" } } };

                if (!ws['A66']) ws['A66'] = { v: "Females" };
                ws['A66'].s = { font: { bold: true, sz: 16, color: { rgb: "c1121f" } }, alignment: { horizontal: "center", vertical: "center" }, fill: { fgColor: { rgb: "FDEBEC" } } };

                ws['!cols'] = Array(50).fill({ wch: 10 });
                ws['!cols'][0] = { wch: 8 };
                ws['!cols'][1] = { wch: 32 };

                const range = XLSX.utils.decode_range(ws['!ref']);
                for (let r = range.s.r; r <= range.e.r; r++) {
                    for (let c = range.s.c; c <= range.e.c; c++) {
                        const addr = XLSX.utils.encode_cell({ r, c });
                        if (!ws[addr]) continue;
                        ws[addr].s = {
                            ...(ws[addr].s || {}),
                            border: { top: { style: "thin" }, bottom: { style: "thin" }, left: { style: "thin" }, right: { style: "thin" } }
                        };
                    }
                }

                XLSX.utils.book_append_sheet(wb, ws, "First Sem");
                XLSX.writeFile(wb, "Grades_Sem1_DEPED_FINAL.xlsx");

                showToast("Exported na! Perfect DepEd Class Record with all merges!");
            };

            // ==================== IMPORT DATA (NOW USES reloadAllTables) ====================
            // ==================== IMPORT DATA (FULLY FIXED - NO SETTIMEOUT) ====================
            // ==================== IMPORT DATA (ALTERNATIVE: RECREATE INPUT FOR RE-IMPORTS) ====================
            window.importData = function (e) {
                const file = e.target.files[0];
                if (!file) return;

                const importModal = new bootstrap.Modal(document.getElementById('importModal'), {
                    backdrop: 'static',
                    keyboard: false
                });

                // Initially hide footer and close button (will show only after processing)
                document.getElementById('importModalFooter').classList.add('d-none');
                document.getElementById('importModalCloseBtn').classList.add('d-none');
                importModal.show();

                const reader = new FileReader();
                reader.onload = function (ev) {
                    try {
                        const data = ev.target.result;
                        const wb = XLSX.read(data, {
                            type: 'array',
                            dense: false,
                            cellText: false,
                            cellDates: false
                        });

                        const sheetName = "First Sem";
                        if (!wb.SheetNames.includes(sheetName)) {
                            throw new Error("Walang sheet na 'First Sem' sa file! Siguraduhing tama ang sheet name.");
                        }

                        const ws = wb.Sheets[sheetName];

                        const getVal = (r, c) => {
                            const addr = XLSX.utils.encode_cell({ r, c });
                            const cell = ws[addr];
                            return cell && cell.v !== undefined && cell.v !== null ? String(cell.v).trim() : "";
                        };

                        let cardGen = getCardGen();
                        cardGen.subject = cardGen.subject || { sem1: { core: {}, applied: {} } };
                        cardGen.students = cardGen.students || { boys: {}, girls: {} };

                        const boysMap = new Map();
                        Object.values(cardGen.students.boys || {}).forEach(stu => {
                            if (stu.name) boysMap.set(normalizeName(stu.name), stu);
                        });
                        const girlsMap = new Map();
                        Object.values(cardGen.students.girls || {}).forEach(stu => {
                            if (stu.name) girlsMap.set(normalizeName(stu.name), stu);
                        });

                        const findStudent = (map, rawName) => {
                            if (!rawName) return null;
                            let norm = normalizeName(rawName);
                            if (map.has(norm)) return map.get(norm);
                            const parts = norm.split(' ');
                            if (parts.length >= 3) {
                                const noMiddle = parts[0] + ' ' + parts.slice(2).join(' ');
                                if (map.has(noMiddle)) return map.get(noMiddle);
                            }
                            return null;
                        };

                        let boysSuccess = 0, girlsSuccess = 0;
                        const unmatched = [];

                        // Import subject names (rows 1 to 8)
                        for (let i = 1; i <= 8; i++) {
                            cardGen.subject.sem1.core[`subject${i}`] = getVal(i, 1) || "";
                            cardGen.subject.sem1.applied[`subject${i}`] = getVal(i, 2) || "";
                        }

                        // Import Males (rows 15 to 64)
                        for (let r = 15; r <= 64; r++) {
                            const name = getVal(r, 0);
                            if (!name) continue;
                            const student = findStudent(boysMap, name);
                            if (student) {
                                student.grade = student.grade || {};
                                student.grade.sem1 = { core: {}, applied: {}, genAve: "" };
                                for (let s = 0; s < 8; s++) {
                                    const c = 2 + s * 3;
                                    student.grade.sem1.core[`subject${s + 1}`] = {
                                        "1st": getVal(r, c) || "",
                                        "2nd": getVal(r, c + 1) || "",
                                        "final": ""
                                    };
                                }
                                for (let s = 0; s < 8; s++) {
                                    const c = 26 + s * 3;
                                    student.grade.sem1.applied[`subject${s + 1}`] = {
                                        "1st": getVal(r, c) || "",
                                        "2nd": getVal(r, c + 1) || "",
                                        "final": ""
                                    };
                                }
                                boysSuccess++;
                            } else {
                                unmatched.push(name);
                            }
                        }

                        // Import Females (rows 66 to 115)
                        for (let r = 66; r <= 115; r++) {
                            const name = getVal(r, 0);
                            if (!name) continue;
                            const student = findStudent(girlsMap, name);
                            if (student) {
                                student.grade = student.grade || {};
                                student.grade.sem1 = { core: {}, applied: {}, genAve: "" };
                                for (let s = 0; s < 8; s++) {
                                    const c = 2 + s * 3;
                                    student.grade.sem1.core[`subject${s + 1}`] = {
                                        "1st": getVal(r, c) || "",
                                        "2nd": getVal(r, c + 1) || "",
                                        "final": ""
                                    };
                                }
                                for (let s = 0; s < 8; s++) {
                                    const c = 26 + s * 3;
                                    student.grade.sem1.applied[`subject${s + 1}`] = {
                                        "1st": getVal(r, c) || "",
                                        "2nd": getVal(r, c + 1) || "",
                                        "final": ""
                                    };
                                }
                                girlsSuccess++;
                            } else {
                                unmatched.push(name);
                            }
                        }

                        // Compute final grades and general average
                        const computeFinalsAndGenAve = (student) => {
                            let total = 0, count = 0;
                            for (let s = 1; s <= 8; s++) {
                                const key = `subject${s}`;
                                ['core', 'applied'].forEach(type => {
                                    const grades = student.grade.sem1[type][key] || {};
                                    const q1 = parseFloat(grades["1st"]) || 0;
                                    const q2 = parseFloat(grades["2nd"]) || 0;
                                    const final = (q1 > 0 && q2 > 0) ? Math.round((q1 + q2) / 2) : "";
                                    student.grade.sem1[type][key]["final"] = final;
                                    if (final) { total += final; count++; }
                                });
                            }
                            student.grade.sem1.genAve = count > 0 ? Math.round(total / count) : "";
                        };

                        Object.values(cardGen.students.boys || {}).concat(Object.values(cardGen.students.girls || {}))
                            .forEach(stu => { if (stu.grade?.sem1) computeFinalsAndGenAve(stu); });

                        // Save to localStorage
                        saveCardGen(cardGen);

                        // RELOAD ALL TABLES IMMEDIATELY
                        reloadAllTables();

                        // Directly show success result
                        document.getElementById('importModalTitle').textContent = "Import Completed! ✅";
                        document.getElementById('importModalBody').innerHTML = `
    <strong>Import successful!</strong><br><br>
    • <strong>${boysSuccess}</strong> Male students imported<br>
    • <strong>${girlsSuccess}</strong> Female students imported<br><br>
    Unmatched names: <strong>${unmatched.length}</strong>
    ${unmatched.length > 0 ?
                                `<div class="unmatched-container">
            ${unmatched.map(name => `<div>${name}</div>`).join('')}
        </div>` :
                                '<p class="text-success mt-3"><strong>All names matched perfectly! 🎉</strong></p>'
                            }
`;

                        // Show footer and buttons
                        document.getElementById('importModalFooter').classList.remove('d-none');
                        document.getElementById('importModalCloseBtn').classList.remove('d-none');
                        document.getElementById('importModalOKBtn').onclick = () => importModal.hide();

                        // Focus OK button
                        const okBtn = document.getElementById('importModalOKBtn');
                        if (okBtn) {
                            setTimeout(() => okBtn.focus(), 100);
                        }

                        showToast("Import successful! Nakikita mo na ang grades sa tables! 🚀", "success");

                    } catch (err) {
                        console.error("Import error:", err);
                        // Directly show error result
                        document.getElementById('importModalTitle').textContent = "Import Failed ❌";
                        document.getElementById('importModalBody').innerHTML = `<p class="text-danger">Error: ${err.message || "Unknown error occurred"}</p>`;
                        document.getElementById('importModalFooter').classList.remove('d-none');
                        document.getElementById('importModalCloseBtn').classList.remove('d-none');
                        document.getElementById('importModalOKBtn').onclick = () => importModal.hide();
                        showToast("May error sa import.", "danger");
                    } finally {
                        // Recreate file input for reliable re-imports
                        const oldInput = document.getElementById('importFileInput');
                        if (oldInput) {
                            const parent = oldInput.parentNode;
                            const newInput = oldInput.cloneNode(true);
                            newInput.value = '';
                            parent.replaceChild(newInput, oldInput);
                        }
                    }
                };

                reader.readAsArrayBuffer(file);
            };

            // ==================== PREPARE STUDENT SHEET (for export) ====================
            function prepareStudentSheet(students) {
                const headerRows = [];
                const row0 = Array(50).fill("");
                row0[0] = "Names of Learners"; row0[1] = "Gen Ave";
                for (let i = 2; i <= 25; i++) row0[i] = "Core Subjects";
                for (let i = 26; i <= 49; i++) row0[i] = "Applied & Specialized Subjects";
                headerRows.push(row0);

                const row1 = Array(50).fill("");
                for (let s = 1; s <= 8; s++) {
                    row1[2 + (s - 1) * 3] = `${s} Subject`;
                    row1[26 + (s - 1) * 3] = `${s} Subject`;
                }
                headerRows.push(row1);

                const row2 = Array(50).fill("");
                const row3 = Array(50).fill("");
                const anchors = [2, 5, 8, 11, 14, 17, 20, 23, 26, 29, 32, 35, 38, 41, 44, 47];
                anchors.forEach(c => {
                    row2[c] = "QUARTER";
                    row2[c + 2] = "Final Sem";
                    row3[c] = "1";
                    row3[c + 1] = "2";
                });
                headerRows.push(row2, row3);

                const studentRows = Object.values(students).map(stu => {
                    const name = stu.name || "";
                    const genAve = stu.grade?.sem1?.genAve ?? "";
                    const row = [name, genAve, ...Array(48).fill("")];

                    for (let s = 0; s < 8; s++) {
                        const key = `subject${s + 1}`;
                        const g = stu.grade?.sem1?.core?.[key] || {};
                        const col = 2 + s * 3;
                        row[col] = g["1st"] ?? "";
                        row[col + 1] = g["2nd"] ?? "";
                        row[col + 2] = g["final"] ?? "";
                    }

                    for (let s = 0; s < 8; s++) {
                        const key = `subject${s + 1}`;
                        const g = stu.grade?.sem1?.applied?.[key] || {};
                        const col = 26 + s * 3;
                        row[col] = g["1st"] ?? "";
                        row[col + 1] = g["2nd"] ?? "";
                        row[col + 2] = g["final"] ?? "";
                    }

                    return row;
                });

                while (studentRows.length < 50) {
                    studentRows.push(["", "", ...Array(48).fill("")]);
                }

                return headerRows.concat(studentRows);
            }

            // ==================== MODAL KEYBOARD ENHANCEMENTS (exact same behavior as reference) ====================
            // For clearModal – Confirm button is primary action (autofocus + Enter = Confirm)
            document.getElementById('clearModal').addEventListener('shown.bs.modal', function () {
                const confirmBtn = document.getElementById('clearModalConfirmBtn');
                const cancelBtn = this.querySelector('.btn-secondary[data-bs-dismiss="modal"]');

                confirmBtn.focus();

                const handleArrowKeys = (e) => {
                    if (e.key === 'ArrowLeft' || e.key === 'ArrowRight') {
                        e.preventDefault();
                        if (document.activeElement === confirmBtn) {
                            cancelBtn.focus();
                        } else {
                            confirmBtn.focus();
                        }
                    }
                };

                this.addEventListener('keydown', handleArrowKeys);

                this.addEventListener('hidden.bs.modal', function cleanup() {
                    this.removeEventListener('keydown', handleArrowKeys);
                    this.removeEventListener('hidden.bs.modal', cleanup);
                });
            });

            // For importModal – when footer appears, focus the OK button (only actionable button)
            document.getElementById('importModal').addEventListener('shown.bs.modal', function () {
                // When the footer becomes visible (after import finishes), focus the OK button
                const observer = new MutationObserver(() => {
                    const footer = document.getElementById('importModalFooter');
                    const okBtn = document.getElementById('importModalOKBtn');
                    if (!footer.classList.contains('d-none') && okBtn) {
                        okBtn.focus();
                    }
                });
                observer.observe(document.getElementById('importModalFooter'), { attributes: true, attributeFilter: ['class'] });
            });
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/handsontable@14.3.0/dist/handsontable.full.min.js"></script>
    <script src="SideBar-NavBar.js"></script>
    <script src="Logout.js"></script>
    <script src="Toast.js"></script>
</body>

</html>